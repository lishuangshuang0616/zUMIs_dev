<!DOCTYPE html>

<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>${samplename} Summary Report</title>
<link rel="icon" href="data:image/png;base64,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" type="image/vnd.microsoft.icon">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet"/>

${plotly_loader_tag}
<style>
        html {
            overflow-y: scroll;
        }
        :root {
            --primary-color: #27AE60; /* Emerald Green */
            --primary-dark: #1E8449; /* Forest Green */
            --secondary-color: #F0FDF4; /* Very Light Mint */
            --accent-color: #2ECC71; /* Vibrant Green */
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --gradient-bg: linear-gradient(135deg, #1E8449 0%, #27AE60 100%);
            --section-gradient: linear-gradient(135deg, #27AE60 0%, #d5e1db 100%);
            --content-max-width: 1000px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        .library-tab-btn { display: inline-flex; }
        [data-library-content] { display: none; }
        [data-library-content="gene-expression"] { display: block; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'PingFang SC', 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.5;
            color: var(--text-primary);
            background: #f1f5f9; /* Light gray background */
            min-height: 100vh;
            font-size: 13px;
        }

        .container {
            max-width: 1080px;
            margin: 0 auto;
            padding: 0 20px;
        }

        header {
            background: var(--gradient-bg);
            color: white;
            padding: 2rem 0;
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
            opacity: 0.3;
        }

        .header-content {
            position: relative;
            z-index: 1;
        }

        h1 {
            font-size: 2rem; /* Slightly smaller h1 */
            font-weight: 700;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            font-weight: 300;
        }

        main {
            padding: 2rem 0;
        }

        .section-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            
            position: relative;
            min-width: 0;
        }
        .section-card.simple-card::before { display: none; }

        .section-card::before {
            display: none;
        }

        .section-card:hover {
            box-shadow: var(--shadow-lg);
        }
        [style*="border-bottom: 2px solid #3498db"] { border-bottom: none !important; }
        /* Default hide VDJ target sections to avoid initial flicker; JS toggles visibility */
        [data-section="vdj-t-target"], [data-section="vdj-b-target"] {
            display: none;
        }

        h2 {
            color: var(--primary-color);
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        h2::before {
            content: '';
            width: 6px;
            height: 2rem;
            background: var(--gradient-bg);
            border-radius: 3px;
        }

        h3 {
            color: var(--text-primary);
            font-size: 1.15rem;
            font-weight: 500;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--secondary-color);
        }

        .plotly-wrapper {
            display: grid;
            gap: 1.5rem;
            margin: 1.5rem 0;
        }

        .plotly-graph {
            background: var(--secondary-color);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            
        }

        .plotly-graph:hover {
            background: #f1f5f9;
        }

        .flex-container {
            display: flex;
            gap: 2rem;
            align-items: stretch;
            flex-wrap: wrap;
        }

        .flex-item {
            flex: 1;
            min-width: 300px;
            background: var(--secondary-color);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            margin: 1rem 0;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .left-half, .right-half {
            flex: 1;
            padding: 1rem;
        }

        .image {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
        }

        /* Marker Table Styles */
        .marker-table-info {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
            color: #64748b;
            line-height: 1.5;
        }

        .marker-table-container {
            overflow-x: auto;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            margin-bottom: 1rem;
            -webkit-overflow-scrolling: touch;
            width: 100%;
            max-width: 100%;
            position: relative;
        }

        .marker-table {
            width: auto;
            border-collapse: collapse;
            font-size: 0.85rem;
            min-width: 100%;
            table-layout: auto;
            white-space: nowrap;
            max-width: none;
        }

        .marker-table th {
            background: #f1f5f9;
            color: #334155;
            font-weight: 600;
            padding: 0.75rem 0.5rem;
            text-align: center;
            border: 1px solid #e2e8f0;
            font-size: 0.8rem;
            white-space: nowrap;
        }

        .marker-table th:first-child,
        .marker-table th:nth-child(2) {
            background: #e2e8f0;
            position: sticky;
            left: 0;
            z-index: 10;
            min-width: 120px;
        }

        .marker-table th:nth-child(2) {
            left: 120px;
        }

        .marker-table td {
            padding: 0.5rem;
            text-align: center;
            border: 1px solid #e2e8f0;
            font-size: 0.8rem;
            white-space: nowrap;
        }

        .marker-table td:first-child,
        .marker-table td:nth-child(2) {
            background: #f8fafc;
            position: sticky;
            left: 0;
            z-index: 5;
            font-weight: 500;
            text-align: left;
            padding-left: 0.75rem;
        }

        .marker-table td:nth-child(2) {
            left: 120px;
        }

        .marker-table .l2fc-value {
            font-weight: 600;
        }

        .marker-table .l2fc-value.significant {
            color: #000000;
            font-weight: bold;
        }

        .marker-table .l2fc-value.not-significant {
            color: #efefef;
        }

        .marker-table .pval-value {
            font-family: 'Courier New', monospace;
        }

        .marker-table .pval-value.significant {
            color: #000000;
            font-weight: bold;
        }

        .marker-table .pval-value.not-significant {
            color: #efefef;
        }

        .marker-table .grayed {
            color: #efefef !important;
            font-weight: normal !important;
        }

        .marker-table tbody tr:hover {
            background: #f8fafc;
        }

        .table-pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: #f8fafc;
            border-top: 1px solid #e2e8f0;
            border-radius: 0 0 8px 8px;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .pagination-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s ease;
        }

        .pagination-btn:hover {
            background: var(--primary-hover);
        }

        .pagination-btn:disabled {
            background: #94a3b8;
            cursor: not-allowed;
            transform: none;
        }

        .pagination-info {
            color: #64748b;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .rows-select {
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 0.5rem;
            font-size: 0.85rem;
            background: white;
            cursor: pointer;
        }

        .rows-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* Force button styles to override any conflicting rules */
        button[id*="toggle"] {
            /* Force unified green theme for help circles */
            background: var(--gradient-bg) !important;
            color: white;
            border: none !important;
            width: 24px !important; /* smaller circle */
            height: 24px !important; /* smaller circle */
            font-size: 12px !important; /* smaller question mark */
            border-radius: 50% !important; /* ensure circle shape */
            box-shadow: 0 2px 8px rgba(13, 148, 136, 0.3) !important;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        button[id*="toggle"]:hover {
            background: var(--primary-dark) !important;
            box-shadow: 0 4px 12px rgba(13, 148, 136, 0.4) !important;
        }

        /* Responsive Design */
        
        @media (max-width: 768px) {
            .sidebar-navigation {
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                z-index: 1000;
                transition: transform 0.3s ease;
                overflow-y: auto;
                width: 260px;
            }
            
            .content-area {
                margin-left: 0;
                padding: 1.5rem;
                width: 100%;
            }
            
            .content-wrapper {
                max-width: var(--content-max-width);
                margin: 0 auto;
            }
        }
        
        /* Tablet and small desktop */
        @media (min-width: 769px) and (max-width: 1200px) {
            .sidebar-navigation {
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                z-index: 1000;
                transition: transform 0.3s ease;
                overflow-y: auto;
                width: 260px;
            }
            
            .content-area {
                margin-left: 0;
                padding: 1.5rem;
                width: 100%;
            }
            
            .content-wrapper {
                max-width: var(--content-max-width);
                margin: 0 auto;
            }
        }
        
        /* Mobile and tablet */
        @media (max-width: 768px) {
            .sidebar-navigation {
                transition: transform 0.3s ease;
                width: 250px;
            }
            
            .content-area {
                margin-left: 0;
                padding: 1rem;
            }
            
            .container {
                padding: 0 15px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .section-card {
                padding: 1.5rem;
                margin-bottom: 1.5rem;
            }
            
            .flex-container {
                flex-direction: column;
                gap: 1rem;
            }
            
            .flex-item {
                min-width: unset;
            }
            
            /* Pipeline Information responsive */
            .pipeline-info-grid {
                grid-template-columns: 1fr !important;
                gap: 1rem !important;
            }
            
            .summary-section {
                padding: 1rem;
                margin-bottom: 1rem;
            }
            
            /* Statistics table responsive */
        .stats-table-container {
            overflow-x: auto;
        }
        
        .stats-table-container table {
            width: 100%;
        }
        
        @media (max-width: 768px) {
            .stats-table-container table {
                font-size: 0.9em;
            }
            
            .stats-table-container td {
                padding: 10px 12px !important;
            }
        }
        
        @media (max-width: 480px) {
            .stats-table-container table {
                font-size: 0.8em;
            }
            
            .stats-table-container td {
                padding: 8px 10px !important;
            }
        }

        /* Tables responsive */
            .table-responsive {
                overflow-x: auto;
            }
            
            table {
                width: 100%;
            }
            
            /* Charts responsive */
            .chart-container {
                margin: 1rem 0;
            }
            
            .plotly-graph {
                width: 100% !important;
                height: auto !important;
            }
            
            /* Tab buttons responsive */
            .tab-list {
                padding: 0 1rem;
            }
            
            .tab-button {
                padding: 0.75rem 1rem;
                font-size: 0.9rem;
                font-weight: bold;
            }
        }
        

        
        /* Mobile overlay */
        .mobile-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
        
        @media (max-width: 768px) {
            .sidebar-navigation {
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                z-index: 1000;
                transition: transform 0.3s ease;
                overflow-y: auto;
                width: 250px;
            }
            
            .content-area {
                margin-left: 0;
                width: 100%;
            }
        }

        /* Small mobile devices */
        @media (max-width: 480px) {
            .content-area {
                padding: 0.5rem;
            }
            
            .summary-section {
                padding: 0.75rem;
                border-radius: 10px;
            }
            
            h1 {
                font-size: 1.5rem;
                margin-bottom: 1rem;
            }
            
            h2 {
                font-size: 1.4rem !important;
                margin-bottom: 1rem !important;
            }
            
            h3 {
                font-size: 1.1rem !important;
                margin-bottom: 0.75rem !important;
            }
            
            .section-card {
                padding: 1rem !important;
                margin-bottom: 1rem !important;
            }
            
            .plotly-wrapper {
                gap: 1rem !important;
                margin: 1rem 0 !important;
            }
            
            .plotly-graph {
                padding: 1rem !important;
                margin-bottom: 1rem !important;
            }
            
            .sidebar-header {
                padding: 0 1rem 1rem 1rem;
            }
            
            .sidebar-title {
                font-size: 1.2rem;
            }
            
            .sidebar-subtitle {
                font-size: 1.0rem;
                font-weight: bold;
            }
            
            /* Make text more compact */
            p {
                font-size: 0.9rem !important;
                line-height: 1.4 !important;
                margin-bottom: 0.75rem !important;
            }
            
            /* Compact table styling */
            .stats-table-container {
                margin: 0.75rem 0 !important;
            }
            
            /* Reduce chart heights for mobile */
            .chart-container {
                margin: 0.75rem 0 !important;
            }
            
            .chart-container, .plotly-graph-div {
                max-height: 250px !important;
            }
            
            /* Make summary cards more compact */
            .summary-card {
                padding: 0.75rem !important;
                margin-bottom: 0.75rem !important;
            }
            
            /* Optimize table display for very small screens */
            .stats-table-container table {
                font-size: 0.75rem !important;
            }
            
            .stats-table-container th,
            .stats-table-container td {
                padding: 6px 8px !important;
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--secondary-color);
        }

        ::-webkit-scrollbar-thumb {
            background: #ccced1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover,
        ::-webkit-scrollbar-thumb:active {
            background: var(--primary-color);
        }

        /* Navigation and Progress Indicator */
        .progress-nav {
            position: sticky;
            top: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 0;
            z-index: 100;
            margin-bottom: 2rem;
        }

        .nav-items {
            display: flex;
            gap: 2rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .nav-item {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            background: var(--secondary-color);
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            
            border: 1px solid var(--border-color);
        }

        .nav-item:hover, .nav-item.active {
            background: var(--primary-color);
            color: white;
            box-shadow: var(--shadow-sm);
        }

        /* New Summary Cards */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .summary-card {
            background-color: #fff;
            border-radius: 16px;
            padding: 2rem 1.5rem;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
            
            text-align: center;
            min-width: 0; /* Allow flex item to shrink below content size */
            overflow: hidden; /* prevent visual overflow */
        }
        .summary-card:hover {
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-color);
        }

        .summary-card-content .value {
            font-size: 3.0rem; /* slightly smaller to fit */
            font-weight: 600;
            color: var(--text-primary);
            line-height: 1.2;
            white-space: normal; /* allow wrapping */
            word-break: break-word; /* break long tokens */
            overflow-wrap: anywhere; /* ensure no overflow */
            max-width: 100%;
        }

        .summary-card-content .label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
            line-height: 1.4;
        }

        /* Enhanced Chart Containers */
        .chart-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
            padding-left: 1rem;
        }

        /* Loading States */
        .loading-placeholder {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 8px;
            height: 200px;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Tooltip Styles */
        .tooltip {
            position: relative;
            cursor: help;
        }

        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 45%;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            color: var(--text-primary);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            font-size: 0.85rem;
            white-space: normal;
            opacity: 0;
            visibility: hidden;
            
            z-index: 1000;
            width: 400px;
            max-width: 95vw;
            text-align: left;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-lg);
        }

        .tooltip:hover::after {
            opacity: 1;
            visibility: visible;
        }

        /* Main Layout Styles */
        .main-layout {
            min-height: 100vh;
            gap: 0;
        }



        .tab-list {
            list-style: none;
            padding: 0;
            margin: 0;
            flex-grow: 1;
        }



        /* Right Content Area */
        .content-area {
            flex: 1;
            margin-left: 0;
            padding: 0 1.5rem 1.5rem 1.5rem;
            background: #f8fafc;
            min-height: 100vh;
            position: relative;
        }

        .content-wrapper {
            max-width: var(--content-max-width);
            margin: 0 auto;
            min-width: 0;
            padding-top: 1rem;
        }

        /* Constrain cards width to avoid overly wide borders */
        .summary-section,
        .chart-container {
            max-width: var(--card-max-width);
            margin-left: auto;
            margin-right: auto;
        }

        .summary-section {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.05);
            border: var(--card-border-width) solid #e2e8f0;
        }

        .tab-content {
            min-height: 0px;
        }

        /* Inline Navigation and Header */
        .content-topbar {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            padding: 8px 0 16px 0;
        }
        .content-topbar .topbar-title {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
        }
        .content-topbar .topbar-subtitle {
            margin: 0;
            font-size: 0.9rem;
            color: #64748b;
        }
        .inline-nav .tab-list {
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            background: #ffffff;
            box-shadow: 0 2px 12px rgba(0,0,0,0.05);
            overflow: hidden;
        }
        .inline-nav .tab-button {
            border-left: none;
            border-bottom: 1px solid #e2e8f0;
            text-align: left;
        }
        .inline-nav .tab-item:last-child .tab-button {
            border-bottom: none;
        }
        .report-footer {
            background: transparent;
            border: none;
            box-shadow: none;
            border-radius: 0;
            padding: 12px 0;
            font-size: 0.8rem;
            color: #64748b;
            margin-top: 24px;
            max-width: var(--content-max-width);
            margin-left: auto;
            margin-right: auto;
            text-align: center;
        }
        @media (min-width: 769px) {
            .content-area { display: block; }
            .inline-nav { position: fixed; top: 120px; left: max(24px, calc((100vw - var(--content-max-width)) / 2 - 204px)); width: 180px; z-index: 100; }
        }

        /* Hide inline nav on mid-width screens to prevent overlap */
        @media (min-width: 769px) and (max-width: 1200px) {
            .inline-nav { display: none !important; }
        }
        @media (max-width: 768px) {
            .sidebar-navigation { display: block; }
            .inline-nav { display: none; }
            .content-topbar { display: block; }
            .report-footer { margin-top: 16px; }
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        /* Cluster Tab Styles */
        .cluster-plots-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-top: 1.5rem;
        }

        .cluster-plot-item {
            background: #f8fafc;
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .cluster-plot-item h3 {
            color: #2d3748;
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .plot-description {
            color: #718096;
            font-size: 0.9rem;
            line-height: 1.5;
            margin-bottom: 1rem;
        }

        .cluster-plot-placeholder {
            min-height: 400px;
            background: white;
            border-radius: 8px;
            border: 2px dashed #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .plot-loading {
            text-align: center;
            color: #718096;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e2e8f0;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive two-column grid class */
        .responsive-two-col-grid {
            display: grid;
            grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
            gap: 20px;
            margin-top: 15px;
        }
        /* Ensure grid children can shrink and not force overflow */
        .responsive-two-col-grid > * {
            min-width: 0;
        }


        @media (max-width: 768px) {
            .responsive-two-col-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
        }

        @media (max-width: 480px) {
            .responsive-two-col-grid {
                gap: 10px;
            }
        }




        /* Force responsive behavior for all screen sizes */
        @media screen and (max-width: 1200px) {
            .content-area {
                margin-left: 0;
            }
            [data-library-content="gene-expression"] .responsive-two-col-grid {
                grid-template-columns: 1fr !important;
                gap: 1rem !important;
            }
            
            .marker-table-container {
                overflow-x: auto !important;
                -webkit-overflow-scrolling: touch !important;
                width: 100% !important;
                max-width: 100% !important;
            }
            
            #marker-table {
                min-width: 100% !important;
                font-size: 0.8rem !important;
            }
        }

        @media (max-width: 768px) {
            .cluster-plots-container {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            /* Force responsive behavior for marker table */
            .marker-table-container {
                overflow-x: auto !important;
                -webkit-overflow-scrolling: touch !important;
            }
            
            #marker-table {
                min-width: 100% !important;
                font-size: 11px !important;
            }
            
            /* Additional mobile optimizations for 768px */
            .section-card {
                padding: 1.25rem !important;
                margin-bottom: 1.25rem !important;
            }
            
            h2 {
                font-size: 1.5rem !important;
                margin-bottom: 1.25rem !important;
            }
            
            h3 {
                font-size: 1.2rem !important;
                margin-bottom: 1rem !important;
            }
            
            .plotly-wrapper {
                gap: 1.25rem !important;
                margin: 1.25rem 0 !important;
            }
            
            .plotly-graph {
                padding: 1.25rem !important;
            }
            
            /* Make charts more mobile-friendly */
            .cluster-plot-placeholder {
                min-height: 300px !important;
            }
            
            /* Optimize chart containers for mobile */
            .chart-container, .plotly-graph-div {
                max-height: 350px !important;
            }
            
            /* Make summary cards more compact on tablets */
            .summary-card {
                padding: 1rem !important;
                margin-bottom: 1rem !important;
            }
            
            /* Reduce text size slightly for better fit */
            p {
                font-size: 0.95rem !important;
                line-height: 1.5 !important;
            }
            
            /* Clonotype section mobile optimization */
            .clonotype-chart-container {
                max-height: 350px !important;
                overflow: hidden !important;
            }
            
            .clonotype-table-container {
                overflow-x: hidden;
            }
            
            .clonotype-table {
                font-size: 0.75rem !important;
                table-layout: fixed;
                width: 100%;
            }

            .clonotype-table th, .clonotype-table td {
                white-space: normal;
                word-wrap: break-word;
            }
        }

        @media (max-width: 480px) {
            /* Marker table responsive styles */
            .marker-table-container {
                padding: 5px !important;
                overflow-x: auto !important;
                -webkit-overflow-scrolling: touch !important;
            }
            
            #marker-table {
                font-size: 9px !important;
                min-width: 100% !important;
            }
            
            #marker-table th,
            #marker-table td {
                padding: 1px 2px !important;
                min-width: 30px !important;
                white-space: normal !important;
                word-break: break-word !important;
            }
            
            /* Remove fixed widths on small screens */
            #marker-table th[style*="width"],
            #marker-table td[style*="width"] {
                width: auto !important;
                min-width: 25px !important;
            }
            
            /* Make the gene expression section more responsive */
            [data-library-content="gene-expression"] .responsive-two-col-grid {
                grid-template-columns: 1fr !important;
            }
            
            /* Keep RNA marker table constrained even on small screens */
            [data-library-content="gene-expression"] .marker-table-container {
                max-width: 720px !important;
                width: 100% !important;
                margin-left: auto !important;
                margin-right: auto !important;
            }
            [data-library-content="gene-expression"] .marker-search-row {
                max-width: 720px !important;
                width: 100% !important;
                margin-left: 0 !important;
                margin-right: 0 !important;
            }
            
            /* Clonotype section mobile optimization for small screens */
            .clonotype-chart-container {
                max-height: 250px !important;
                overflow: hidden !important;
            }
            
            .clonotype-table {
                font-size: 0.75rem !important;
            }
            
            .clonotype-table th,
            .clonotype-table td {
                padding: 6px 8px !important;
            }
        }

        /* Analysis Description Styles */
        .analysis-description {
            background: #f7fafc;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border-left: 4px solid #4299e1;
        }

        .analysis-description p {
            color: #4a5568;
            line-height: 1.6;
            margin-bottom: 1rem;
        }

        .key-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .metric-item {
            background: white;
            padding: 1rem;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }

        .metric-label {
            display: block;
            font-size: 0.85rem;
            color: #718096;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .metric-value {
            display: block;
            font-size: 1rem;
            color: #2d3748;
            font-weight: 600;
        }

        .sample-info-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            background: var(--gradient-bg);
            color: white;
            margin: 0 -1.5rem;
        }
        .brand-info {
            display: inline-flex;
            align-items: flex-start;
        }
        .brand-name {
            color: white;
            font-size: 1.5rem;
            font-weight: 600;
        }
        .brand-tm {
            font-size: 0.6rem;
            font-weight: 700;
            vertical-align: text-top;
            transform: translateY(4px);
            margin-left: 4px;
        }

        /* Library Type Selector Styles */
        .library-selector-container {
            position: sticky;
            top: 0;
            background: #f8fafc; /* Match content area background */
            z-index: 100;
            padding-top: 0; /* Keep content at top edge */
            /* Counteract parent padding to span full width */
            margin-left: -1.5rem;
            margin-right: -1.5rem;
            padding-left: 1.5rem;
            padding-right: 1.5rem;
            margin-bottom: 12px; /* tighter spacing below */
            box-sizing: border-box;
        }

        /* Place library tabs and sample title on the same row */
        .library-topbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            flex-wrap: nowrap; /* keep in one row */
            padding: 6px 0; /* reduce bar height */
            border-bottom: 1px solid #e5e7eb; /* full-width divider */
        }
        .library-topbar-right {
            display: flex;
            align-items: flex-end; /* align items to the bottom edge */
            gap: 8px;
            justify-content: flex-end;
            flex: 0 1 45%;
            min-width: 220px;
            max-width: 45%;
            padding-right: 20px; /* small breathing room from right edge */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .library-topbar-title {
            margin: 0;
            font-size: 2.0rem;
            line-height: 1; /* tighten line height for cleaner bottom alignment */
            font-weight: 600;
            color: white;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .library-topbar-subtitle {
            margin: 0;
            font-size: 1.0rem;
            color: #64748b;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Small green badge for Sample ID label */
        .library-topbar-badge {
            color: white;
            font-weight: 700;
            font-size: 1rem; /* roughly half of 2rem title */
            line-height: 1;
            margin-right: 6px;
            white-space: nowrap;
            position: relative; /* fine-tune vertical offset */
            top: 0; /* neutral offset for flex-end alignment */
        }
        @media (max-width: 900px) {
            .library-topbar-badge { font-size: 0.85rem; }
        }

        .library-selector-title {
            display: none;
        }

        .library-tabs {
            display: flex;
            gap: 0;
            justify-content: flex-start;
            flex-wrap: nowrap; /* prevent second row */
            position: relative;
            flex: 1 1 auto;
            min-width: 0; /* enable shrinking without overflow */
        }

        .top-tab-buttons {
            display: flex;
            gap: 8px;
            align-items: center;
            flex: 0 0 auto;
            white-space: nowrap;
        }

        .top-tab-buttons .tab-button {
            width: auto;
            padding: 8px 12px;
            border-left: none;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            background: white;
            color: #475569;
            font-size: 0.85rem;
            font-weight: 600;
            text-align: center;
            justify-content: center;
            gap: 0;
        }

        .top-tab-buttons .tab-button:hover {
            background: #f8fafc;
            color: #1e293b;
            border-color: var(--primary-color);
        }

        .top-tab-buttons .tab-button.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .library-tab-btn {
            padding: 10px 18px;
            border: none;
            border-radius: 0;
            background: transparent;
            color: #6b7280;
            font-size: 17px;
            font-weight: 550;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: auto;
            text-align: center;
            position: relative;
            border-bottom: 4px solid transparent;
        }

        @media (max-width: 900px) {
            .library-topbar-title { font-size: 1.2rem; }
            .library-topbar-subtitle { font-size: 0.95rem; }
            .library-tab-btn { padding: 8px 12px; font-size: 16px; }
        }

        .library-tab-btn:hover {
            color: #374151;
            background: rgba(0, 0, 0, 0.02);
        }

        .library-tab-btn.active {
            color: #1f2937 !important;
            font-weight: 600 !important;
            border-bottom-color: var(--primary-color) !important;
            background: transparent !important;
        }

        .library-tab-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            color: #d1d5db;
        }

        .library-tab-btn:disabled:hover {
            background: transparent;
            color: #d1d5db;
        }

        /* Content visibility for library types is now handled by JavaScript to support dynamic default views. */

        /* New Info Box Styles */
        .info-box {
            margin-top: 2rem;
            background: #fff; /* Changed from var(--secondary-color) to white */
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
        }
        .info-box-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1rem;
        }
        .info-item {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-left-width: 4px;
            
        }
        .info-item:hover {
            box-shadow: var(--shadow-md);
        }
        .info-item-label {
            display: block;
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-bottom: 0.25rem;
        }
        .info-item-value {
            color: var(--text-primary);
            font-size: 0.9rem;
            font-weight: 600;
        }
        /* Info item border colors */
        .info-item.version { border-left-color: #3498db; }
        .info-item.chemistry { border-left-color: #e74c3c; }
        .info-item.introns { border-left-color: #9b59b6; }
        .info-item.transcriptome { border-left-color: #f39c12; }
        .text-success { color: #3498DB; }
</style>
<script>
    // Normalize fonts across charts: x-axis and annotations
    (function() {
        if (!window.Plotly) { return; }
        const originalNewPlot = Plotly.newPlot;
        Plotly.newPlot = function(gd, data, layout, config) {
            try {
                if (layout && typeof layout === 'object') {
                    // Enforce x-axis fonts
                    Object.keys(layout).forEach(function(key) {
                        if (key.startsWith('xaxis')) {
                            const axis = layout[key] || {};
                            axis.titlefont = { size: 12, color: '#2c3e50' };
                            axis.tickfont = { size: 10, color: '#2c3e50' };
                            axis.title = axis.title || {};
                            axis.title.font = { size: 12, color: '#2c3e50' };
                            layout[key] = axis;
                        }
                    });
                    // Enforce annotation fonts
                    if (Array.isArray(layout.annotations)) {
                        layout.annotations = layout.annotations.map(function(a) {
                            a = a || {};
                            a.font = Object.assign({}, a.font, { size: 12 });
                            return a;
                        });
                    }
                }
            } catch (e) {}
            return originalNewPlot.call(this, gd, data, layout, config);
        };
    })();
</script>
<script>
// Plotly visibility and resize handling to prevent blank charts on navigation
(function() {
    const safeResize = (el) => {
        try { Plotly.Plots.resize(el); } catch (e) {}
        try { Plotly.redraw(el); } catch (e) {}
    };

    const observeTargets = new IntersectionObserver((entries) => {
        entries.forEach((entry) => {
            if (entry.isIntersecting && entry.intersectionRatio > 0) {
                const el = entry.target;
                safeResize(el);
            }
        });
    }, { threshold: [0, 0.1, 0.2] });

    const registerElement = (id) => {
        const el = document.getElementById(id);
        if (!el) return;
        observeTargets.observe(el);
    };

    window.registerPlot = (id, data, layout, config) => {
        return Plotly.newPlot(id, data, layout, config).then(() => {
            registerElement(id);
            const el = document.getElementById(id);
            safeResize(el);
        });
    };

    const registerAllPlaceholders = () => {
        document.querySelectorAll('.plot-placeholder').forEach((el) => {
            observeTargets.observe(el);
        });
    };

    window.addEventListener('DOMContentLoaded', () => {
        registerAllPlaceholders();
        // Initial pass to ensure any loaded plots are sized
        document.querySelectorAll('.plot-placeholder').forEach((el) => safeResize(el));
    });

    window.addEventListener('visibilitychange', () => {
        if (!document.hidden) {
            document.querySelectorAll('.plot-placeholder').forEach((el) => safeResize(el));
        }
    });

    window.addEventListener('hashchange', () => {
        // After anchor navigation, ensure visible plots are resized
        setTimeout(() => {
            document.querySelectorAll('.plot-placeholder').forEach((el) => safeResize(el));
        }, 150);
    });

    window.addEventListener('resize', () => {
        document.querySelectorAll('.plot-placeholder').forEach((el) => safeResize(el));
    });
})();
</script>
<script>
// More robust plot resizing on tab/library switch
(function() {
    const forceResizeAllPlotsIn = (container) => {
        if (!container || !window.Plotly) return;
        setTimeout(() => {
            const plots = container.querySelectorAll('.plot-placeholder, .plotly-graph-div, [data-processed="true"]');
            for (let i = 0; i < plots.length; i++) {
                try {
                    Plotly.Plots.resize(plots[i]);
                } catch (e) {
                    // Ignore errors if element is not a plot
                }
            }
        }, 50); // A small delay to allow the layout to update
    };

    const setupTabListeners = () => {
        document.body.addEventListener('click', function(event) {
            const button = event.target.closest('button');
            if (!button) return;

            let targetContent;
            // Handle main tabs
            if (button.matches('[data-tab]')) {
                const tabId = button.getAttribute('data-tab');
                targetContent = document.getElementById(tabId + '-tab');
            }
            // Handle library tabs
            else if (button.matches('[data-library]')) {
                const libraryId = button.getAttribute('data-library');
                // Find the active tab pane first
                const activeTabPane = document.querySelector('.tab-pane.active');
                if(activeTabPane){
                    targetContent = activeTabPane.querySelector(`[data-library-content="${libraryId}"]`);
                }
            }

            if (targetContent) {
                forceResizeAllPlotsIn(targetContent);
            }
        });
    };

    window.addEventListener('DOMContentLoaded', setupTabListeners);
})();
</script>
</head>
<body><div class="container">

<!-- Mobile overlay -->
<div class="mobile-overlay" id="mobileOverlay"></div>
<div class="main-layout">

<!-- Right Content Area -->
<div class="content-area">
  <!-- Report footer moved to bottom of content column -->

  <!-- Sample Info -->
  <div class="sample-info-container">
      <div class="brand-info">
        <span class="brand-name">MGIEasy Full-length Transcriptome</span>
      </div>
      <div class="library-topbar-right">
        <span class="library-topbar-badge">Sample ID:</span>
        <h1 class="library-topbar-title">${samplename}</h1>
      </div>
  </div>

  <!-- Global Library Type Selector (visible across all tabs) -->
  <div class="library-selector-container">
    <div class="library-topbar">
      <div class="library-tabs">
        <button class="library-tab-btn active" data-tab="summary">Summary</button>
        <button class="library-tab-btn" data-tab="cells">UMI-based</button>
        <button class="library-tab-btn" data-tab="library">Read-based</button>
      </div>
    </div>
  </div>

<div class="content-wrapper">
<!-- Tab Content Areas -->
<div class="tab-content">
<!-- Summary Tab -->
<div class="tab-pane active" id="summary-tab">
<section class="summary-section" data-library-content="gene-expression">
<h2>Summary 
                                <button id="toggle-summary-explanation" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(13, 148, 136, 0.3)'" onmouseover="this.style.transform='scale(1.1)'; this.style.boxShadow='0 4px 12px rgba(13, 148, 136, 0.4)'" style="
                                    background: var(--gradient-bg);
                                    color: white;
                                    border: none;
                                    border-radius: 50%;
                                    width: 28px;
                                    height: 28px;
                                    font-size: 14px;
                                    font-weight: bold;
                                    cursor: pointer;
                                    margin-left: 15px;
                                    box-shadow: 0 2px 8px rgba(13, 148, 136, 0.3);                                    
                                    display: inline-flex;
                                    align-items: center;
                                    justify-content: center;
                                ">?</button>
</h2>
<div id="summary-explanation" style="
                                display: none; 
                                margin-top: 15px; 
                                padding: 20px; 
                                background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
                                border: none;
                                border-radius: 12px;
                                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
                                
                            ">
<h3 style="
                                    color: #2c3e50;
                                    margin-bottom: 15px;
                                    font-size: 1.1em;
                                    border-bottom: 2px solid #3498db;
                                    padding-bottom: 8px;
                                    display: inline-block;
                                ">Summary Parameters Explanation</h3>
<ul style="
                                    list-style: none;
                                    padding: 0;
                                    margin: 0;
                                ">
<li style="
                                        margin-bottom: 12px;
                                    padding: 12px;
                                    background: rgba(255, 255, 255, 0.8);
                                    border-radius: 8px;
                                    border-left: 4px solid #3498db;
                                    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                                "><strong style="color: #2980b9;">Estimated number of cells:</strong> The number of barcodes identified as real cells (not background noise or empty droplets) in the sequencing data. This is predicted using an empty droplet model (EmptyDrops) after merging cell barcodes from the same droplet. Values higher or lower than expected may indicate inaccurate cell counting, cell lysis, or failures in droplet generation.</li>
<li style="
                                    margin-bottom: 12px;
                                    padding: 12px;
                                    background: rgba(255, 255, 255, 0.8);
                                    border-radius: 8px;
                                    border-left: 4px solid #e74c3c;
                                    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                                "><strong style="color: #c0392b;">Median UMI per cell:</strong> The median number of unique molecular identifiers (UMIs) detected per cell among all identified cells.</li>
<li style="
                                    margin-bottom: 12px;
                                    padding: 12px;
                                    background: rgba(255, 255, 255, 0.8);
                                    border-radius: 8px;
                                    border-left: 4px solid #27ae60;
                                    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                                "><strong style="color: #229954;">Median gene per cell:</strong> The median number of unique genes with detectable expression in each cell.</li>
<li style="
                                    margin-bottom: 0;
                                    padding: 12px;
                                    background: rgba(255, 255, 255, 0.8);
                                    border-radius: 8px;
                                    border-left: 4px solid #f39c12;
                                    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                                "><strong style="color: #d68910;">Mean reads per cell:</strong> The average number of raw sequencing reads per cell, calculated by dividing the total raw reads by the number of identified cells.</li>
</ul>
</div>
<!-- Summary Stats -->
<div class="summary-cards">
<div class="summary-card">
<div class="summary-card-content">
<div class="value">${rna_estm_Num_cell}</div>
<div class="label">Estimated number of cells</div>
</div>
</div>
<div class="summary-card">
<div class="summary-card-content">
<div class="value">${rna_median_umis_percell}</div>
<div class="label">Median UMI per cell</div>
</div>
</div>
<div class="summary-card">
<div class="summary-card-content">
<div class="value">${rna_median_genes_percell}</div>
<div class="label">Median gene per cell</div>
</div>
</div>
<div class="summary-card">
<div class="summary-card-content">
<div class="value">${rna_mean_reads_percell}</div>
<div class="label">Mean reads per cell</div>
</div>
</div>
</div>
<!-- Pipeline Information -->
<div class="info-box">
    <h3 class="info-box-title">Information</h3>
    <div class="info-grid">
        <div class="info-item version">
            <strong class="info-item-label">Pipeline Version:</strong>
            <span class="info-item-value">${version}</span>
        </div>
        <div class="info-item chemistry">
            <strong class="info-item-label">Chemistry:</strong>
            <span class="info-item-value">${rna_end_display}</span>
        </div>
        <div class="info-item introns">
            <strong class="info-item-label">Include Introns:</strong>
            <span class="info-item-value text-success">${rna_intron_display}</span>
        </div>
        <div class="info-item transcriptome">
            <strong class="info-item-label">Transcriptome:</strong>
            <span class="info-item-value">${rna_species}</span>
        </div>
    </div>
</div>
<script>
                            document.getElementById('toggle-summary-explanation').addEventListener('click', function() {
                                var explanationDiv = document.getElementById('summary-explanation');
                                if (explanationDiv.style.display === 'none') {
                                    explanationDiv.style.display = 'block';
                                } else {
                                    explanationDiv.style.display = 'none';
                                }
                            });
                        </script>
</section>
<!-- Configuration Section -->
<section class="section-card simple-card">
<div style="display: flex; align-items: center; justify-content: space-between;">
    <span style="font-size: 14px; font-weight: 400; color: #334155;">Configuration Parameters</span>
    <button id="toggle-parameters" aria-label="Toggle parameters" style="
        width: 28px;
        height: 28px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        background: #ffffff;
        color: #334155;
        cursor: pointer;
        transition: all 0.2s ease;
    ">
        <svg id="toggle-parameters-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="6 9 12 15 18 9"></polyline>
        </svg>
    </button>
</div>
<div id="parameters-content" style="display: none; margin-top: 10px;">
    <div id="csv-title" style="font-size: 13px; font-weight: 500; color: #475569; margin-bottom: 6px;">Input CSV</div>
    <div class="marker-table-container" id="csv-table-container" style="border: 1px solid #e2e8f0; border-radius: 8px; background: #ffffff;">
        <p style="padding: 12px; color: #64748b;">CSV data not available or empty.</p>
    </div>
    <div id="fastq-title" style="font-size: 13px; font-weight: 500; color: #475569; margin: 12px 0 6px 0;">Input FASTQs</div>
    <div class="marker-table-container" id="fastq-content-container" style="border: 1px solid #e2e8f0; border-radius: 8px; background: #ffffff; margin-top: 8px;">
        <p style="padding: 12px; color: #64748b;">FASTQ data not available or empty.</p>
    </div>
</div>
<script>
    (function() {
        var btn = document.getElementById('toggle-parameters');
        var icon = document.getElementById('toggle-parameters-icon');
        var content = document.getElementById('parameters-content');
        btn.addEventListener('click', function() {
            var open = content.style.display === 'block';
            content.style.display = open ? 'none' : 'block';
            icon.style.transform = open ? 'rotate(0deg)' : 'rotate(180deg)';
        });
        btn.addEventListener('mouseover', function() {
            btn.style.background = '#f8fafc';
        });
        btn.addEventListener('mouseout', function() {
            btn.style.background = '#ffffff';
        });
    })();
</script>
</section>
</div>
<!-- Cells Tab -->
<div class="tab-pane" id="cells-tab">
<!-- Library Type Selector removed; using global selector above -->
<!-- Sample Statistics and Violin Plot Section -->
<section class="section-card" data-library-content="gene-expression">
<h3 class="tooltip" data-tooltip="Key quality metrics for the single-cell RNA sequencing sample">RNA Quality Metrics
                                <button id="toggle-cells-explanation" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(59, 130, 246, 0.3)'; this.style.background='#3b82f6'" onmouseover="this.style.transform='scale(1.1)'; this.style.boxShadow='0 4px 12px rgba(59, 130, 246, 0.4)'; this.style.background='#2563eb'" style="
                                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                    color: white;
                                    border: none;
                                    border-radius: 50%;
                                    width: 28px;
                                    height: 28px;
                                    font-size: 14px;
                                    font-weight: bold;
                                    cursor: pointer;
                                    margin-left: 15px;
                                    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);                                   
                                    display: inline-flex;
                                    align-items: center;
                                    justify-content: center;
                                ">?</button>
</h3>
<div id="cells-explanation" style="
                                display: none; 
                                margin-top: 15px; 
                                padding: 20px; 
                                background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
                                border: none;
                                border-radius: 12px;
                                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
                                
                            ">
<h4 style="
                                    color: #2c3e50;
                                    margin-bottom: 15px;
                                    font-size: 1.1em;
                                    border-bottom: 2px solid #3498db;
                                    padding-bottom: 8px;
                                    display: inline-block;
                                ">Cell Quality Metrics Explanation</h4>
<ul style="
                                    list-style: none;
                                    padding: 0;
                                    margin: 0;
                                ">
<li style="
                                        margin-bottom: 12px;
                                        padding: 12px;
                                        background: rgba(255, 255, 255, 0.8);
                                        border-radius: 8px;
                                        border-left: 4px solid #3498DB;
                                        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                                    "><strong style="color: #2980B9;">Estimated number of cells:</strong> The number of barcodes identified as real cells (not background noise or empty droplets) in the sequencing data. This is predicted using an empty droplet model (EmptyDrops) after merging cell barcodes from the same droplet. Values higher or lower than expected may indicate inaccurate cell counting, cell lysis, or failures in droplet generation.</li>
<li style="
                                        margin-bottom: 12px;
                                        padding: 12px;
                                        background: rgba(255, 255, 255, 0.8);
                                        border-radius: 8px;
                                        border-left: 4px solid #e74c3c;
                                        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                                    "><strong style="color: #C0392B;">Mean reads per cell:</strong> The average number of raw sequencing reads per cell, calculated by dividing the total raw reads by the number of identified cells.</li>
<li style="
                                        margin-bottom: 12px;
                                        padding: 12px;
                                        background: rgba(255, 255, 255, 0.8);
                                        border-radius: 8px;
                                        border-left: 4px solid #27AE60;
                                        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                                    "><strong style="color: #229954;">UMI counts per cell:</strong>  The number of unique transcript molecules captured per cell after UMI deduplication. Both mean and median values shown.</li>
<li style="
                                        margin-bottom: 12px;
                                        padding: 12px;
                                        background: rgba(255, 255, 255, 0.8);
                                        border-radius: 8px;
                                        border-left: 4px solid #f39c12;
                                        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                                    "><strong style="color: #e67e22;">Total genes detected:</strong> The total number of distinct genes detected across all cells in the dataset. This serves as an indicator of the biological diversity and overall sensitivity of the experiment.</li>
<li style="
                                        margin-bottom: 12px;
                                        padding: 12px;
                                        background: rgba(255, 255, 255, 0.8);
                                        border-radius: 8px;
                                        border-left: 4px solid #9b59b6;
                                        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                                    "><strong style="color: #8e44ad;">Genes per cell:</strong> Number of detected genes reflects cell viability and transcriptional complexity. Both mean and median values shown.</li>
<li style="
                                        margin-bottom: 12px;
                                        padding: 12px;
                                        background: rgba(255, 255, 255, 0.8);
                                        border-radius: 8px;
                                        border-left: 4px solid #34495e;
                                        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                                    "><strong style="color: #2c3e50;">Fraction reads in cells:</strong> The proportion of reads that are uniquely mapped to the transcriptome and associated with a valid cell barcode, indicating the efficiency of cell capture.</li>
<li style="
                                        margin-bottom: 0;
                                        padding: 12px;
                                        background: rgba(255, 255, 255, 0.8);
                                        border-radius: 8px;
                                        border-left: 4px solid #6366F1;
                                        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                                    "><strong style="color: #1D4ED8;">RNA Violin Plot:</strong> A violin plot illustrating the distribution of Genes (number of genes detected), UMIs (number of UMIs) and Mito.percent across all cells, providing insights into data quality and variability.</li>
</ul>
</div>
<div class="responsive-two-col-grid">
<!-- Left side: Statistics Table -->
<div>
<div class="stats-table-container" style="overflow-x: auto;">
<table style="
                                            width: 100%;
                                            border-collapse: collapse;
                                            background: white;
                                            border-radius: 8px;
                                            overflow: hidden;
                                            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                                        ">
<tbody>
<tr style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
<td style="padding: 12px 15px; font-weight: 600; color: #2c3e50; border-bottom: 1px solid #dee2e6;">
                                                        Estimated number of cells
</td>
<td style="padding: 12px 15px; color: #495057; border-bottom: 1px solid #dee2e6; font-weight: 600; text-align: right;">${rna_estm_Num_cell}</td>
</tr>
<tr style="background: white;">
<td style="padding: 12px 15px; font-weight: 600; color: #2c3e50; border-bottom: 1px solid #dee2e6;">
                                                        Mean reads per cell
</td>
<td style="padding: 12px 15px; color: #495057; border-bottom: 1px solid #dee2e6; font-weight: 600; text-align: right;">${rna_mean_reads_percell}</td>
</tr>
<tr style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
<td style="padding: 12px 15px; font-weight: 600; color: #2c3e50; border-bottom: 1px solid #dee2e6;">
                                                        Mean UMI counts per cell
</td>
<td style="padding: 12px 15px; color: #495057; border-bottom: 1px solid #dee2e6; font-weight: 600; text-align: right;">${rna_mean_umis_percell}</td>
</tr>
<tr style="background: white;">
<td style="padding: 12px 15px; font-weight: 600; color: #2c3e50; border-bottom: 1px solid #dee2e6;">
                                                        Median UMI counts per cell
</td>
<td style="padding: 12px 15px; color: #495057; border-bottom: 1px solid #dee2e6; font-weight: 600; text-align: right;">${rna_median_umis_percell}</td>
</tr>
<tr style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
<td style="padding: 12px 15px; font-weight: 600; color: #2c3e50; border-bottom: 1px solid #dee2e6;">
                                                        Total genes detected
</td>
<td style="padding: 12px 15px; color: #495057; border-bottom: 1px solid #dee2e6; font-weight: 600; text-align: right;">${rna_total_gene}</td>
</tr>
<tr style="background: white;">
<td style="padding: 12px 15px; font-weight: 600; color: #2c3e50; border-bottom: 1px solid #dee2e6;">
                                                        Mean Genes per cell
</td>
<td style="padding: 12px 15px; color: #495057; border-bottom: 1px solid #dee2e6; font-weight: 600; text-align: right;">${rna_mean_genes_percell}</td>
</tr>
<tr style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
<td style="padding: 12px 15px; font-weight: 600; color: #2c3e50; border-bottom: 1px solid #dee2e6;">
                                                        Median Genes per cell
</td>
<td style="padding: 12px 15px; color: #495057; border-bottom: 1px solid #dee2e6; font-weight: 600; text-align: right;">${rna_median_genes_percell}</td>
</tr>
<tr style="background: white;">
<td style="padding: 12px 15px; font-weight: 600; color: #2c3e50;">
                                                        Fraction reads in cells
</td>
<td style="padding: 12px 15px; color: #495057; font-weight: 600; text-align: right;">${rna_fraction_transcriptome_in_cells}</td>
</tr>
</tbody>
</table>
</div>
</div>
<!-- Right side: Violin Plot -->
<div>
<div style="
        background: white;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        min-height: 300px;
    ">
<h4 style="color: #2c3e50; margin-bottom: 8px; text-align: center;">RNA Violin Plot</h4>
                                        <div style="display: flex; gap: 8px; width: 100%; height: auto; min-height: 300px; align-items: flex-start; justify-content: center;">
                                            <div id="violin-plot-mid" class="plot-placeholder" data-plot-id="violin-plot-mid" style="width: 140px; height: 300px;"></div>
                                            <div id="violin-plot-gene" class="plot-placeholder" data-plot-id="violin-plot-gene" style="width: 140px; height: 300px;"></div>
                                            <div id="violin-plot-area" class="plot-placeholder" data-plot-id="violin-plot-area" style="width: 140px; height: 300px;"></div>
                                        </div>
                                        <script id="script-violin-plots">
                                            // Data from raw_qc injected via template placeholders, with safe fallback
                                            const midCountDataJSON = '${rna_violin_mid}';
                                            const geneTypeDataJSON = '${rna_violin_gene}';
                                            const cellAreaDataJSON = '${rna_violin_mito}';

                                            const midCountData = (midCountDataJSON && midCountDataJSON.startsWith('[')) ? JSON.parse(midCountDataJSON) : [];
                                            const geneTypeData = (geneTypeDataJSON && geneTypeDataJSON.startsWith('[')) ? JSON.parse(geneTypeDataJSON) : [];
                                            const cellAreaData = (cellAreaDataJSON && cellAreaDataJSON.startsWith('[')) ? JSON.parse(cellAreaDataJSON) : [];


                                            function calculateCustomStats(data, removeOutliersForPlot = true) {
                                                const allDataSorted = [...data].sort((a, b) => a - b);
                                                const n = allDataSorted.length;
                                                
                                                const stats = {
                                                    min: allDataSorted[0],
                                                    q1: allDataSorted[Math.floor(n * 0.25)],
                                                    median: allDataSorted[Math.floor(n * 0.5)],
                                                    q3: allDataSorted[Math.floor(n * 0.75)],
                                                    max: allDataSorted[n - 1],
                                                    mean: data.reduce((a, b) => a + b, 0) / n
                                                };
                                                
                                                let plotData = [...data];
                                                if (removeOutliersForPlot) {
                                                    const iqr = stats.q3 - stats.q1;
                                                    const lowerBound = stats.q1 - 3.0 * iqr;
                                                    const upperBound = stats.q3 + 3.0 * iqr;
                                                    
                                                    plotData = data.filter(val => val >= lowerBound && val <= upperBound);
                                                }
                                                
                                                return {
                                                    ...stats,
                                                    plotData: plotData,
                                                    allData: data
                                                };
                                            }

                                            const midStats = calculateCustomStats(midCountData, true);
                                            const geneStats = calculateCustomStats(geneTypeData, true);
                                            const areaStats = calculateCustomStats(cellAreaData, false); 

                                            // Common layout configuration
                                            const commonLayout = {
                                                width: 140,
                                                height: 300,
                                                xaxis: {
                                                    title: '',
                                                    showgrid: false,
                                                    zeroline: false,
                                                    showticklabels: true,
                                                    tickfont: {
                                                        size: 12,
                                                        color: '#2c3e50'
                                                    },
                                                    titlefont: {
                                                        family: 'Inter',
                                                        size: 12,
                                                        color: '#2c3e50'
                                                    }
                                                },
                                                yaxis: {
                                                    title: { text: '', standoff: 0 },
                                                    showgrid: true,
                                                    gridcolor: 'rgba(0,0,0,0.1)',
                                                    zeroline: false,
                                                    titlefont: {
                                                        family: 'Inter',
                                                        size: 12,
                                                        color: '#2c3e50'
                                                    }
                                                },
                                                plot_bgcolor: 'white',
                                                paper_bgcolor: 'white',
                                                hovermode: 'closest',
                                                hoverlabel: {
                                                    bgcolor: '#334155',
                                                    bordercolor: 'rgba(0,0,0,0)',
                                                    font: { color: '#ffffff', size: 10 },
                                                    align: 'left'
                                                },
                                                margin: {
                                                    l: 25,
                                                    r: 0,
                                                    t: 40,
                                                    b: 25
                                                },
                                                showlegend: false,
                                                font: {
                                                    family: 'Arial, sans-serif',
                                                    size: 9,
                                                    color: '#2c3e50'
                                                }
                                            };

                                            const commonConfig = {
                                                displayModeBar: false,
                                                displaylogo: false,
                                                responsive: true
                                            };

                                            const violinColors = {
                                                genes: { fill: 'rgba(41, 128, 185, 0.8)', line: '#2980b9' },
                                                umis:  { fill: 'rgba(41, 128, 185, 0.8)', line: '#2980b9' },
                                                mito:  { fill: 'rgba(41, 128, 185, 0.8)', line: '#2980b9' }
                                            };

                                            const midViolinData = [{
                                                type: 'violin',
                                                x: Array(midStats.plotData.length).fill('Genes'),
                                                y: midStats.plotData, 
                                                box: { 
                                                    visible: true,
                                                    fillcolor: 'rgba(255,255,255,0.8)',
                                                    line: { color: violinColors.genes.line, width: 1 },
                                                    q1: [midStats.q1],
                                                    median: [midStats.median],
                                                    q3: [midStats.q3],
                                                    lowerfence: [midStats.min],
                                                    upperfence: [midStats.max]
                                                },
                                                meanline: { 
                                                    visible: true, 
                                                    color: violinColors.genes.line, 
                                                    width: 2 
                                                },
                                                mean: [midStats.mean],
                                                points: false,
                                                fillcolor: violinColors.genes.fill,
                                                line: { color: violinColors.genes.line },
                                                hoveron: 'violins',
                                                name: '',
                                                hovertemplate: '%{y:.3f}<extra></extra>'
                                            }];

                                            const midLayout = {
                                                ...commonLayout,
                                                annotations: [{
                                                    text: 'Count',
                                                    x: 0,
                                                    y: 1,
                                                    yshift: 30,
                                                    xref: 'paper',
                                                    yref: 'paper',
                                                    showarrow: false,
                                                    xanchor: 'left',
                                                    yanchor: 'top',
                                                    align: 'left',
                                                    font: { family: 'Inter', size: 12, color: '#2c3e50' }
                                                }]
                                            };

                                            // UMIs violin plot - compute stats over full data, plot filtered data
                                            const geneViolinData = [{
                                                type: 'violin',
                                                x: Array(geneStats.plotData.length).fill('UMIs'),
                                                y: geneStats.plotData,
                                                box: { 
                                                    visible: true,
                                                    fillcolor: 'rgba(255,255,255,0.8)',
                                                    line: { color: violinColors.umis.line, width: 1 },
                                                    q1: [geneStats.q1],
                                                    median: [geneStats.median],
                                                    q3: [geneStats.q3],
                                                    lowerfence: [geneStats.min],
                                                    upperfence: [geneStats.max]
                                                },
                                                meanline: { 
                                                    visible: true, 
                                                    color: violinColors.umis.line, 
                                                    width: 2 
                                                },
                                                // custom mean line position
                                                mean: [geneStats.mean],
                                                points: false,
                                                fillcolor: violinColors.umis.fill,
                                                line: { color: violinColors.umis.line },
                                                hoveron: 'violins',
                                                name: '',
                                                hovertemplate: '%{y:.3f}<extra></extra>'
                                            }];

                                            const geneLayout = {
                                                ...commonLayout,
                                                annotations: [{
                                                    text: 'Count',
                                                    x: 0,
                                                    y: 1,
                                                    yshift: 30,
                                                    xref: 'paper',
                                                    yref: 'paper',
                                                    showarrow: false,
                                                    xanchor: 'left',
                                                    yanchor: 'top',
                                                    align: 'left',
                                                    font: { family: 'Inter', size: 12, color: '#2c3e50' }
                                                }]
                                            };

                                            // Mito percent violin plot - compute stats over full data
                                            const areaViolinData = [{
                                                type: 'violin',
                                                x: Array(areaStats.plotData.length).fill('Mito percent'),
                                                y: areaStats.plotData, // plot using filtered data
                                                box: { 
                                                    visible: true,
                                                    fillcolor: 'rgba(255,255,255,0.8)',
                                                    line: { color: violinColors.mito.line, width: 1 },
                                                    q1: [areaStats.q1],
                                                    median: [areaStats.median],
                                                    q3: [areaStats.q3],
                                                    lowerfence: [areaStats.min],
                                                    upperfence: [areaStats.max]
                                                },
                                                meanline: { 
                                                    visible: true, 
                                                    color: violinColors.mito.line, 
                                                    width: 2 
                                                },
                                                // custom mean line position
                                                mean: [areaStats.mean],
                                                points: false,
                                                fillcolor: violinColors.mito.fill,
                                                line: { color: violinColors.mito.line },
                                                hoveron: 'violins',
                                                name: '',
                                                hovertemplate: '%{y:.3f}<extra></extra>'
                                                
                                            }];

                                            const areaLayout = {
                                                ...commonLayout,
                                                yaxis: {
                                                    title: { text: '', standoff: 2 },
                                                    showgrid: true,
                                                    gridcolor: 'rgba(0,0,0,0.1)',
                                                    zeroline: false,
                                                    titlefont: {
                                                        size: 12,
                                                        color: '#2c3e50'
                                                    }
                                                },
                                                annotations: [{
                                                    text: 'Percent',
                                                    x: 0,
                                                    y: 1,
                                                    yshift: 30,
                                                    xref: 'paper',
                                                    yref: 'paper',
                                                    showarrow: false,
                                                    xanchor: 'left',
                                                    yanchor: 'top',
                                                    align: 'left',
                                                    font: { family: 'Inter', size: 12, color: '#2c3e50' }
                                                }]
                                            };

                                            // Create the three plots
                                            Plotly.newPlot('violin-plot-mid', midViolinData, midLayout, commonConfig);
                                            Plotly.newPlot('violin-plot-gene', geneViolinData, geneLayout, commonConfig);
                                            Plotly.newPlot('violin-plot-area', areaViolinData, areaLayout, commonConfig);
                                        </script>
                                    </div>
                                </div>
    </div>
</section>
<!-- VDJ-T Quality Metrics Section -->
<!-- VDJ-T V(D)J Annotation Section -->
<!-- VDJ-B Quality Metrics Section -->
<!-- ATAC Quality Metrics Section -->
<!-- RNA Beads to Cells Analysis Section -->
<section class="section-card" data-library-content="gene-expression">
<h3 class="tooltip" data-tooltip="Analysis of bead-to-cell mapping and barcode rank distribution for RNA">RNA Beads to Cells
                                <button id="toggle-rna-beads-explanation" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(59, 130, 246, 0.3)'; this.style.background='#3b82f6'" onmouseover="this.style.transform='scale(1.1)'; this.style.boxShadow='0 4px 12px rgba(59, 130, 246, 0.4)'; this.style.background='#2563eb'" style="
                                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                    color: white;
                                    border: none;
                                    border-radius: 50%;
                                    width: 28px;
                                    height: 28px;
                                    font-size: 14px;
                                    font-weight: bold;
                                    cursor: pointer;
                                    margin-left: 15px;
                                    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);                                    
                                    display: inline-flex;
                                    align-items: center;
                                    justify-content: center;
                                ">?</button>
</h3>
<div id="rna-beads-explanation" style="
                                display: none; 
                                margin-top: 15px; 
                                padding: 20px; 
                                background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
                                border: none;
                                border-radius: 12px;
                                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
                                
                            ">
<h4 style="
                                    color: #2c3e50;
                                    margin-bottom: 15px;
                                    font-size: 1.1em;
                                    border-bottom: 2px solid #3498db;
                                    padding-bottom: 8px;
                                    display: inline-block;
                                ">RNA Beads to Cells Analysis Explanation</h4>
<ul style="
                                    list-style: none;
                                    padding: 0;
                                    margin: 0;
                                ">
<li style="
                                        margin-bottom: 12px;
                                        padding: 12px;
                                        background: rgba(255, 255, 255, 0.8);
                                        border-radius: 8px;
                                        border-left: 4px solid #3498db;
                                        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                                    "><strong style="color: #2980b9;">RNA Barcode Rank Plot (left):</strong> In the library, transcripts from the same cell are grouped under a unified cell ID, each tagged with unique molecular identifiers (UMIs). However, RNA from ambient sources or dying cells may also be captured during library preparation. This barcode rank plot visualizes the distribution of total UMI counts per cell ID (x-axis: cell ID rank; y-axis: UMI count, both in log scale). Cell IDs with higher UMI counts (on the left) are more likely to represent real cells, while lower-count IDs (on the right) are often background. Blue points indicate high-confidence cells, gray points represent background (e.g., empty droplets), and the blue gradient region marks a transitional zone identified by an ambient RNA model. Hovering over each point reveals its rank, UMI count, and the percentage of real cells in its neighborhood, aiding in the distinction between true cells and noise.</li>
<li style="
                                        margin-bottom: 0;
                                        padding: 12px;
                                        background: rgba(255, 255, 255, 0.8);
                                        border-radius: 8px;
                                        border-left: 4px solid #e74c3c;
                                        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                                    "><strong style="color: #c0392b;">Bead Count Distribution (right):</strong> This plot displays the distribution of barcoded bead counts per droplet among identified real cells. While the number of beads per droplet is theoretically expected to follow a Poisson distribution, deviations may occur due to factors such as low RNA capture or inefficient bead merging. The distribution is affected by cell filtering thresholds and dynamically updates accordingly. If most droplets contain only one bead, it is advisable to check whether the oligo library has sufficient sequencing depth (recommended >50M reads) and whether it is properly matched to the cDNA library, as these factors can impact overall data quality and cell recovery.</li>
</ul>
</div>
<div class="responsive-two-col-grid">
<!-- Left side: Barcode Rank Plot -->
<div>
<div style="
                                        background: white;
                                        border-radius: 8px;
                                        padding: 15px;
                                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                                        height: 100%;
                                        display: flex;
                                        flex-direction: column;
                                        justify-content: center;
                                        align-items: center;
                                        min-height: 400px;
                                    ">
<h4 style="color: #2c3e50; margin-bottom: 15px; text-align: center;">RNA Barcode Rank Plot</h4>
<div id="rna-barcode-rank-plot" class="plot-placeholder" data-plot-id="rna-barcode-rank-plot" style="width: 400px; height: 360px; margin: 0 auto;"></div>
<script id="script-rna-barcode-rank-plot">
  // Render RNA Barcode Rank Plot
  const tracesJSON = '${rna_rankplot_data}';
  let traces = [];
  if (tracesJSON) {
      try {
          const parsedData = JSON.parse(tracesJSON);
          if (Array.isArray(parsedData)) {
              traces = parsedData;
          }
      } catch (e) {
          console.error("Failed to parse rna_rankplot_data:", e);
          traces = [];
      }
  }

  var hasData = traces && traces.length > 0;
  if (!hasData) {
    var container = document.getElementById('rna-barcode-rank-plot');
    if (container) {
      container.innerHTML = '<div style="text-align: center; color: #6c757d; padding-top: 50px;">No available data</div>';
    }
  } else {
    var layout = {
        xaxis: {
            type: 'log',
            title: { 
                text: 'Barcode in Rank-descending Order', 
                standoff: 12,
                font: { size: 12, color: '#2c3e50' }
            },
            tickfont: { size: 10, color: '#2c3e50' },
            color: 'black',
            showline: true,
            ticks: 'outside',
            ticklen: 4,
            tickwidth: 1,
            tickcolor: 'black',
            showgrid: true,
            gridcolor: 'lightgrey',
            linewidth: 1,
            fixedrange: true,
            automargin: false,
            linecolor: 'black'
        },
        yaxis: {
            type: 'log',
            title: '', // Keep empty title for minimalist style
            titlefont: { size: 12, color: '#2c3e50' },
            tickfont: { size: 10, color: '#2c3e50' },
            color: 'black',
            showline: true,
            ticks: 'outside',
            ticklen: 4,
            tickwidth: 1,
            showgrid: true,
            gridcolor: 'lightgrey',
            linewidth: 1,
            fixedrange: true,
            automargin: false,
            linecolor: 'black'
        },
        annotations: [{ // Top annotation for "UMI Counts"
            text: 'UMI Counts',
            x: 0,
            y: 1,
            yshift: 30,
            xref: 'paper',
            yref: 'paper',
            showarrow: false,
            xanchor: 'left',
            yanchor: 'top',
            font: { family: 'Inter', size: 12, color: '#2c3e50' }
        }],
        plot_bgcolor: 'rgba(0,0,0,0)',
        hovermode: 'closest',
        paper_bgcolor: 'white',
        showlegend: true,
        legend: {
          orientation: 'h',
          x: 0.9,
          y: 1,
          xanchor: 'center',
          yanchor: 'bottom',
          itemsizing: 'constant',
          font: { family: 'Arial', size: 10, color: 'black' },
          bgcolor: 'rgba(255,255,255,0)',
          borderwidth: 0
        },
        margin: { l: 30, r: 20, t: 36, b: 40 },
    };

    // Harden trace rendering on log axes
    traces = traces.map(function(t) {
      var y = Array.isArray(t.y) ? t.y : [];
      // Null out non-positive values to avoid log errors
      t.y = y.map(function(v) { return (v != null && v > 0) ? v : null; });
      // Prefer line mode when multiple points exist
      if (!t.mode) {
        t.mode = (t.y && t.y.length > 1) ? 'lines' : 'markers';
      }
      // Ensure consistent trace type and stable line rendering
      t.type = 'scatter';
      t.connectgaps = true;
      t.line = Object.assign({ simplify: false, width: 1 }, t.line || {});
      return t;
    });

    var config = { displayModeBar: false, responsive: true, useResizeHandler: true };
    var containerEl = document.getElementById('rna-barcode-rank-plot');
    if (typeof Plotly === 'undefined') {
      if (containerEl) containerEl.innerHTML = '<div style="text-align:center;color:#e74c3c;padding-top:50px;">Plotly library failed to load</div>';
    } else {
      try {
        // Defer to next frame to ensure layout metrics are ready
        window.requestAnimationFrame(function() {
          Plotly.newPlot('rna-barcode-rank-plot', traces, layout, config);
          // Keep plot responsive
          window.addEventListener('resize', function() {
            Plotly.Plots.resize(containerEl);
          });
        });
      } catch (err) {
        console.error('Plotly render error (RNA rank plot):', err);
        if (containerEl) containerEl.innerHTML = '<div style="text-align:center;color:#e74c3c;padding-top:50px;">Failed to render plot</div>';
      }
    }
  }
</script>

</div>
</div>
<!-- Right side: Bead Count Distribution -->
<div>
<div style="
                                        background: white;
                                        border-radius: 8px;
                                        padding: 15px;
                                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                                        height: 100%;
                                        display: flex;
                                        flex-direction: column;
                                        justify-content: center;
                                        align-items: center;
                                        min-height: 400px;
                                    ">
<h4 style="color: #2c3e50; margin-bottom: 15px; text-align: center;">Bead Count Distribution</h4>
<div id="bead-count-distribution" class="plot-placeholder" data-plot-id="bead-count-distribution" style="width: 400px; height: 360px; margin: 0 auto;"></div>
<script id="script-bead-count-distribution">
                                            // Bead Count Distribution Chart
                                            const beadCountXJSON = '${bead_count_x}';
                                            const beadCountYJSON = '${bead_count_y}';
                                            const xData = (beadCountXJSON && beadCountXJSON.startsWith('[')) ? JSON.parse(beadCountXJSON) : [];
                                            const yData = (beadCountYJSON && beadCountYJSON.startsWith('[')) ? JSON.parse(beadCountYJSON) : [];
                                            const beadCountColors = [
                                                'rgba(15, 76, 129, 0.8)',  
                                                'rgba(13, 96, 158, 0.8)',
                                                'rgba(22, 110, 172, 0.8)',
                                                'rgba(46, 124, 188, 0.8)',
                                                'rgba(69, 138, 202, 0.8)',
                                                'rgba(93, 152, 216, 0.8)',
                                                'rgba(117, 166, 230, 0.8)',
                                                'rgba(140, 180, 243, 0.8)',
                                                'rgba(163, 194, 255, 0.8)' 
                                            ];

                                            const beadCountData = [];
                                            for (let i = 0; i < xData.length; i++) {
                                                beadCountData.push({
                                                    x: [xData[i]],
                                                    y: [yData[i]],
                                                    type: 'bar',
                                                    width: 0.8,
                                                    marker: {
                                                        color: beadCountColors[i],
                                                        line: {
                                                            color: beadCountColors[i].replace('0.7', '1'),
                                                            width: 1
                                                        }
                                                    },
                                                    name: `${xData[i]} ${yData[i]}`,
                                                    hovertemplate: `<b>${xData[i]} beads per droplet</b><br>Count: ${yData[i]}<br><extra></extra>`
                                                });
                                            }

                                            const beadCountLayout = {
                                                title: {
                                                    text: '',
                                                    font: { size: 12, color: '#2c3e50' }
                                                },
                                                xaxis: {
                                                    title: 'Number of beads per droplet',
                                                    showgrid: false,
                                                    zeroline: false,
                                                    titlefont: { 
                                                        family: 'Inter',
                                                        size: 12, 
                                                        color: '#2c3e50' 
                                                    },
                                                    tickfont: { size: 10, color: '#2c3e50' },
                                                    range: [0.3, 9.7],
                                                    dtick: 1,
                                                    tick0: 1
                                                },
                                                yaxis: {
                                                    title: '',
                                                    showgrid: true,
                                                    gridcolor: 'rgba(0,0,0,0.1)',
                                                    zeroline: false,
                                                    titlefont: { 
                                                        family: 'Inter',
                                                        size: 14, 
                                                        color: '#2c3e50' 
                                                    },
                                                    tickfont: { size: 10, color: '#2c3e50' }
                                                },
                                                plot_bgcolor: 'rgba(0,0,0,0)',
                                                paper_bgcolor: 'rgba(0,0,0,0)',
                                                margin: { l: 30, r: 20, t: 36, b: 40 },
                                                annotations: [
                                                    {
                                                        text: 'Count',
                                                        xref: 'paper',
                                                        yref: 'paper',
                                                        x: 0,
                                                        y: 1,
                                                        showarrow: false,
                                                        font: { family: 'Inter', size: 14, color: '#2c3e50' },
                                                        xanchor: 'left',
                                                        yanchor: 'top',
                                                        yshift: 30
                                                    }
                                                ],
                                                showlegend: true,
                                                legend: {
                                                    x: 0.98,
                                                    y: 0.98,
                                                    xanchor: 'right',
                                                    yanchor: 'top',
                                                    bgcolor: 'rgba(255,255,255,0.9)',
                                                    bordercolor: 'rgba(0,0,0,0.2)',
                                                    borderwidth: 1,
                                                    font: { size: 10 }
                                                },
                                                font: { family: 'Arial, sans-serif' },
                                                bargap: 0.2,
                                                bargroupgap: 0.1
                                            };

                                            const beadCountConfig = {
                                                displayModeBar: false,
                                                responsive: true
                                            };

                                            Plotly.newPlot('bead-count-distribution', beadCountData, beadCountLayout, beadCountConfig);
                                        </script>
</div>
</div>
</div>
</section>
<script>
                            document.getElementById('toggle-rna-beads-explanation').addEventListener('click', function() {
                                const explanation = document.getElementById('rna-beads-explanation');
                                if (explanation.style.display === 'none' || explanation.style.display === '') {
                                    explanation.style.display = 'block';
                                } else {
                                    explanation.style.display = 'none';
                                }
                            });
                        </script>
<!-- ATAC Beads to Cells Analysis Section -->
<!-- ATAC Cluster Analysis Section -->
<!-- ATAC Targeting Section -->
<!-- VDJ-B V(D)J Annotation Section -->
<!-- Top 10 Clonotypes Section -->
<!-- VDJ-T Target Section -->
<!-- VDJ-B Top 10 Clonotypes Section -->
<!-- VDJ-B Target Section -->
<!-- Cluster Analysis Section -->
<section class="section-card" data-library-content="gene-expression">
<h3 class="tooltip" data-tooltip="Cell clustering analysis using UMAP dimensionality reduction">Cluster Analysis
                                <button id="toggle-cluster-explanation" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(59, 130, 246, 0.3)'; this.style.background='#3b82f6'" onmouseover="this.style.transform='scale(1.1)'; this.style.boxShadow='0 4px 12px rgba(59, 130, 246, 0.4)'; this.style.background='#2563eb'" style="
                                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                    color: white;
                                    border: none;
                                    border-radius: 50%;
                                    width: 28px;
                                    height: 28px;
                                    font-size: 14px;
                                    font-weight: bold;
                                    cursor: pointer;
                                    margin-left: 15px;
                                    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);                                 
                                    display: inline-flex;
                                    align-items: center;
                                    justify-content: center;
                                ">?</button>
</h3>
<div id="cluster-explanation" style="
                                display: none; 
                                margin-top: 15px; 
                                padding: 20px; 
                                background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
                                border: none;
                                border-radius: 12px;
                                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
                                
                            ">
<h4 style="
                                    color: #2c3e50;
                                    margin-bottom: 15px;
                                    font-size: 1.1em;
                                    border-bottom: 2px solid #3498db;
                                    padding-bottom: 8px;
                                    display: inline-block;
                                ">Cluster Analysis Explanation</h4>
<ul style="
                                    list-style: none;
                                    padding: 0;
                                    margin: 0;
                                ">
<li style="
                                        margin-bottom: 12px;
                                        padding: 12px;
                                        background: rgba(255, 255, 255, 0.8);
                                        border-radius: 8px;
                                        border-left: 4px solid #3498DB;
                                        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                                    "><strong style="color: #2980B9;">RNA Cluster Assignment(left):</strong> Cell type clustering plot generated using the Louvain algorithm to group cells with similar gene expression profiles, visualized through UMAP dimensionality reduction where different colors represent distinct cell clusters or potential cell types.</li>
<li style="
                                        margin-bottom: 0px;
                                        padding: 12px;
                                        background: rgba(255, 255, 255, 0.8);
                                        border-radius: 8px;
                                        border-left: 4px solid #e74c3c;
                                        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                                    "><strong style="color: #C0392B;">UMI Count Overlay(right):</strong> UMI expression intensity plot showing total UMI counts per cell on the same UMAP coordinate system, with a color gradient from low to high expression levels for effective quality control assessment.</li>
</ul>
</div>
<div class="responsive-two-col-grid">
<!-- Left side: Cluster Assignment -->
<div>
<div style="
                                        background: white;
                                        border-radius: 8px;
                                        padding: 15px;
                                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                                        height: 100%;
                                        display: flex;
                                        flex-direction: column;
                                        justify-content: center;
                                        align-items: center;
                                        min-height: 400px;
                                    ">
<h4 style="color: #2c3e50; margin-bottom: 15px; text-align: center;">RNA Cluster Assignment</h4>
<div id="cluster-assignment-plot" class="plot-placeholder" data-plot-id="cluster-assignment-plot" style="width: 400px; height: 360px;"></div>
<script id="script-cluster-assignment-plot">
                                            // Build cluster assignment from injected JSON: UMAP_1, UMAP_2, leiden
                                            const rnaUmapXJSON = '${rna_umap_x}';
                                            const rnaUmapYJSON = '${rna_umap_y}';
                                            const rnaLeidenJSON = '${rna_leiden}';
                                            const rnaClustersJSON = '${rna_clusters}';

                                            let umapX = [];
                                            let umapY = [];
                                            let leiden = [];
                                            let clusters = [];
                                            try { if (rnaUmapXJSON && rnaUmapXJSON.trim().startsWith('[')) umapX = JSON.parse(rnaUmapXJSON); } catch (e) { umapX = []; }
                                            try { if (rnaUmapYJSON && rnaUmapYJSON.trim().startsWith('[')) umapY = JSON.parse(rnaUmapYJSON); } catch (e) { umapY = []; }
                                            try { if (rnaLeidenJSON && rnaLeidenJSON.trim().startsWith('[')) leiden = JSON.parse(rnaLeidenJSON); } catch (e) { leiden = []; }
                                            try { if (rnaClustersJSON && rnaClustersJSON.trim().startsWith('[')) clusters = JSON.parse(rnaClustersJSON); } catch (e) { clusters = []; }

                                            // Fallback to derive clusters if not provided
                                            if (!clusters || clusters.length === 0) {
                                                const set = new Set(leiden.map(String));
                                                clusters = Array.from(set);
                                            }

                                            const clusterPalette = ['#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd', '#8c564b', '#e377c2', '#7f7f7f', '#bcbd22', '#17becf', '#13c2c2', '#bdb76b', '#6a5acd', '#20b2aa', '#ff6347'];
                                            const clusterData = [];

                                            if (umapX.length > 0 && umapY.length === umapX.length && leiden.length === umapX.length && clusters.length > 0) {
                                                // Group points by cluster label
                                                const indicesByCluster = new Map();
                                                clusters.forEach(c => indicesByCluster.set(String(c), []));
                                                for (let i = 0; i < umapX.length; i++) {
                                                    const label = String(leiden[i]);
                                                    if (!indicesByCluster.has(label)) indicesByCluster.set(label, []);
                                                    indicesByCluster.get(label).push(i);
                                                }
                                                clusters.forEach((cluster, idx) => {
                                                    const idxs = indicesByCluster.get(String(cluster)) || [];
                                                    const x = idxs.map(i => umapX[i]);
                                                    const y = idxs.map(i => umapY[i]);
                                                    clusterData.push({
                                                        x: x,
                                                        y: y,
                                                        mode: 'markers',
                                                        type: 'scattergl',
                                                        name: `Cluster ${cluster}`,
                                                        marker: {
                                                            color: clusterPalette[idx % clusterPalette.length],
                                                            size: 3,
                                                            opacity: 0.7
                                                        },
                                                        hovertemplate: '<b>Cluster %{text}</b><br>' +
                                                                     'UMAP_1: %{x:.2f}<br>' +
                                                                     'UMAP_2: %{y:.2f}<br>' +
                                                                     '<extra></extra>',
                                                        text: Array(x.length).fill(String(cluster))
                                                    });
                                                });
                                            } else {
                                                // Graceful fallback: small random demo for preview
                                                const demoClusters = ['0'];
                                                demoClusters.forEach((cluster, idx) => {
                                                    const numPoints = 3;
                                                    const cx = (Math.random() - 0.5) * 20;
                                                    const cy = (Math.random() - 0.5) * 20;
                                                    const x = [];
                                                    const y = [];
                                                    for (let i = 0; i < numPoints; i++) {
                                                        x.push(cx + (Math.random() - 0.5) * 8);
                                                        y.push(cy + (Math.random() - 0.5) * 8);
                                                    }
                                                    clusterData.push({
                                                        x, y, mode: 'markers', type: 'scattergl', name: `Cluster ${cluster}`,
                                                        marker: { color: clusterPalette[idx], size: 4, opacity: 0.7 },
                                                        hovertemplate: '<b>Cluster %{text}</b><br>' +
                                                                      'UMAP_1: %{x:.2f}<br>' +
                                                                      'UMAP_2: %{y:.2f}<br>' +
                                                                      '<extra></extra>',
                                                        text: Array(numPoints).fill(cluster)
                                                    });
                                                });
                                            }
                                            
                                            const clusterLayout = {
                                                title: '',
                                                xaxis: {
                                                    title: 'UMAP_1',
                                                    showgrid: true,
                                                    gridcolor: 'lightgray',
                                                    zeroline: false,
                                                    titlefont: { size: 12, color: '#2c3e50' },
                                                    tickfont: { size: 10, color: '#2c3e50' }
                                                },
                                                yaxis: {
                                                    title: 'UMAP_2',
                                                    showgrid: true,
                                                    gridcolor: 'lightgray',
                                                    zeroline: false,
                                                    titlefont: { size: 12, color: '#2c3e50' },
                                                    tickfont: { size: 10, color: '#2c3e50' }
                                                },
                                                plot_bgcolor: 'rgba(0,0,0,0)',
                                                paper_bgcolor: 'rgba(0,0,0,0)',
                                                margin: { l: 40, r: 20, t: 20, b: 60 },
                                                showlegend: true,
                                                legend: {
                                                    title: { text: 'Cluster', font: { size: 12 } },
                                                    font: { size: 10, family: 'Arial' },
                                                    itemsizing: 'constant',
                                                    x: 1.02,
                                                    y: 1,
                                                    xanchor: 'left',
                                                    yanchor: 'top'
                                                },
                                                font: { family: 'Arial, sans-serif' }
                                            };
                                            
                                            const clusterConfig = {
                                                displayModeBar: false,
                                                responsive: true
                                            };
                                            
                                            Plotly.newPlot('cluster-assignment-plot', clusterData, clusterLayout, clusterConfig);
                                        </script>
</div>
</div>
<!-- Right side: RNA Overlay -->
<div>
<div style="
                                        background: white;
                                        border-radius: 8px;
                                        padding: 15px;
                                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                                        height: 100%;
                                        display: flex;
                                        flex-direction: column;
                                        justify-content: center;
                                        align-items: center;
                                        min-height: 400px;
                                    ">
<h4 style="color: #2c3e50; margin-bottom: 15px; text-align: center;">UMI Count Overlay</h4>
<div id="gene-expression-plot" class="plot-placeholder" data-plot-id="gene-expression-plot" style="width: 400px; height: 360px;"></div>
<script id="script-gene-expression-plot">
                                            // Build RNA overlay (UMI intensity) from injected JSON
                                            const rnaOverlayUmapXJSON = '${rna_umap_x}';
                                            const rnaOverlayUmapYJSON = '${rna_umap_y}';
                                            const rnaOverlayUMIJSON = '${rna_numi}';

                                            let overlayX = [];
                                            let overlayY = [];
                                            let overlayUMI = [];
                                            try { if (rnaOverlayUmapXJSON && rnaOverlayUmapXJSON.trim().startsWith('[')) overlayX = JSON.parse(rnaOverlayUmapXJSON); } catch (e) { overlayX = []; }
                                            try { if (rnaOverlayUmapYJSON && rnaOverlayUmapYJSON.trim().startsWith('[')) overlayY = JSON.parse(rnaOverlayUmapYJSON); } catch (e) { overlayY = []; }
                                            try { if (rnaOverlayUMIJSON && rnaOverlayUMIJSON.trim().startsWith('[')) overlayUMI = JSON.parse(rnaOverlayUMIJSON); } catch (e) { overlayUMI = []; }

                                            const expressionData = [];
                                            if (overlayX.length > 0 && overlayY.length === overlayX.length && overlayUMI.length === overlayX.length) {
                                                expressionData.push({
                                                    x: overlayX,
                                                    y: overlayY,
                                                    mode: 'markers',
                                                    type: 'scattergl',
                                                    marker: {
                                                        color: overlayUMI,
                                                        colorscale: 'Viridis',
                                                        size: 3,
                                                        opacity: 0.8,
                                                        colorbar: {
                                                            title: { text: 'nUMI', font: { size: 12 } },
                                                            titleside: 'right',
                                                            thickness: 15,
                                                            len: 0.8,
                                                            x: 1.02,
                                                            tickfont: { size: 10 }
                                                        }
                                                    },
                                                    hovertemplate: '<b>Cell</b><br>' +
                                                                 'UMAP_1: %{x:.2f}<br>' +
                                                                 'UMAP_2: %{y:.2f}<br>' +
                                                                 'nUMI: %{marker.color:.0f}<br>' +
                                                                 '<extra></extra>',
                                                    showlegend: false
                                                });
                                            } else {
                                                // Graceful fallback for preview: synthetic points
                                                const numCells = 3;
                                                const x = [], y = [], nUMI = [];
                                                for (let i = 0; i < numCells; i++) {
                                                    x.push((Math.random() - 0.5) * 20);
                                                    y.push((Math.random() - 0.5) * 20);
                                                    const logNormal = Math.exp(Math.random() * 2 + 6);
                                                    nUMI.push(Math.min(Math.max(logNormal, 500), 5000));
                                                }
                                                expressionData.push({
                                                    x, y, mode: 'markers', type: 'scattergl',
                                                    marker: {
                                                        color: nUMI,
                                                        colorscale: 'Viridis',
                                                        size: 4,
                                                        opacity: 0.8,
                                                        colorbar: {
                                                            title: { text: 'nUMI', font: { size: 12 } },
                                                            titleside: 'right', thickness: 15, len: 0.8, x: 1.02,
                                                            tickfont: { size: 10 }
                                                        }
                                                    },
                                                    hovertemplate: '<b>Cell</b><br>' +
                                                                   'UMAP_1: %{x:.2f}<br>' +
                                                                   'UMAP_2: %{y:.2f}<br>' +
                                                                   'nUMI: %{marker.color:.0f}<br>' +
                                                                   '<extra></extra>',
                                                    showlegend: false
                                                });
                                            }
                                            
                                            const expressionLayout = {
                                                title: '',
                                                xaxis: {
                                                    title: 'UMAP_1',
                                                    showgrid: true,
                                                    gridcolor: 'lightgray',
                                                    zeroline: false,
                                                    titlefont: { size: 12, color: '#2c3e50' },
                                                    tickfont: { size: 10, color: '#2c3e50' }
                                                },
                                                yaxis: {
                                                    title: 'UMAP_2',
                                                    showgrid: true,
                                                    gridcolor: 'lightgray',
                                                    zeroline: false,
                                                    titlefont: { size: 12, color: '#2c3e50' },
                                                    tickfont: { size: 10, color: '#2c3e50' }
                                                },
                                                plot_bgcolor: 'rgba(0,0,0,0)',
                                                paper_bgcolor: 'rgba(0,0,0,0)',
                                                margin: { l: 40, r: 30, t: 20, b: 60 },
                                                showlegend: false,
                                                font: { family: 'Arial, sans-serif' }
                                            };
                                            
                                            const expressionConfig = {
                                                displayModeBar: false,
                                                responsive: true
                                            };
                                            
                                            Plotly.newPlot('gene-expression-plot', expressionData, expressionLayout, expressionConfig);
                                        </script>
</div>
</div>
</div>
</section>
<!-- Cell Annotation Section -->
<section class="section-card" data-library-content="gene-expression">
<h3 class="tooltip" data-tooltip="Automated cell type identification and annotation using machine learning algorithms">Cell Annotation
                                <button id="toggle-annotation-explanation" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(59, 130, 246, 0.3)'; this.style.background='#3b82f6'" onmouseover="this.style.transform='scale(1.1)'; this.style.boxShadow='0 4px 12px rgba(59, 130, 246, 0.4)'; this.style.background='#2563eb'" style="
                                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                    color: white;
                                    border: none;
                                    border-radius: 50%;
                                    width: 28px;
                                    height: 28px;
                                    font-size: 14px;
                                    font-weight: bold;
                                    cursor: pointer;
                                    margin-left: 15px;
                                    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
                                    
                                    display: inline-flex;
                                    align-items: center;
                                    justify-content: center;
                                ">?</button>
</h3>
<div id="annotation-explanation" style="
                                display: none; 
                                margin-top: 15px; 
                                padding: 20px; 
                                background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
                                border: none;
                                border-radius: 12px;
                                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
                                
                            ">
<h4 style="
                                    color: #2c3e50;
                                    margin-bottom: 15px;
                                    font-size: 1.1em;
                                    border-bottom: 2px solid #3498db;
                                    padding-bottom: 8px;
                                    display: inline-block;
                                ">Cell Annotation Explanation</h4>
<ul style="
                                    list-style: none;
                                    padding: 0;
                                    margin: 0;
                                ">
<li style="
                                        margin-bottom: 0;
                                        padding: 12px;
                                        background: rgba(255, 255, 255, 0.8);
                                        border-radius: 8px;
                                        border-left: 4px solid #3498DB;
                                        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                                    "><strong style="color: #2980B9;">Cell Annotation Explanation:</strong> Predicted cell types were assigned based on correlation with established reference atlases: scHCL (Single-cell Human Cell Landscape) for human samples and scMCA (Single-cell Mouse Cell Atlas) for mouse samples. The annotation relies on Pearson correlation between individual cell expression profiles and reference cell types. UMAP plots display the predicted cell identities, with each color representing a distinct cell type. These results are intended for reference only and should be interpreted in the context of experimental and biological background. Annotation accuracy may vary depending on reference coverage and sample diversity. For non-human/mouse species, automated annotation is not currently supported. Users are encouraged to complement this initial annotation with marker gene expression analysis to ensure biological relevance.</li>
</ul>
</div>
<div id="cell-annotation-plot" class="plot-placeholder" data-plot-id="cell-annotation-plot" style="width: 750px; height: 400px; margin: 15px auto 0 auto;"></div>
<script id="script-cell-annotation-plot">
                                // Build cell annotation from injected JSON: Predicted cell type and UMAP coordinates
                                const annoUmapXJSON = '${rna_umap_x}';
                                const annoUmapYJSON = '${rna_umap_y}';
                                const annoCellTypeJSON = '${rna_pred_celltype}';
                                const annoTypesJSON = '${rna_pred_types}';
                                const annoCountsJSON = '${rna_pred_counts}';

                                let ax = [], ay = [], ct = [], types = [], counts = {};
                                try { if (annoUmapXJSON && annoUmapXJSON.trim().startsWith('[')) ax = JSON.parse(annoUmapXJSON); } catch (e) { ax = []; }
                                try { if (annoUmapYJSON && annoUmapYJSON.trim().startsWith('[')) ay = JSON.parse(annoUmapYJSON); } catch (e) { ay = []; }
                                try { if (annoCellTypeJSON && annoCellTypeJSON.trim().startsWith('[')) ct = JSON.parse(annoCellTypeJSON); } catch (e) { ct = []; }
                                try { if (annoTypesJSON && annoTypesJSON.trim().startsWith('[')) types = JSON.parse(annoTypesJSON); } catch (e) { types = []; }
                                try { if (annoCountsJSON && (annoCountsJSON.trim().startsWith('{') || annoCountsJSON.trim().startsWith('['))) counts = JSON.parse(annoCountsJSON); } catch (e) { counts = {}; }

                                const annotationData = [];
                                const annotationPalette = ['#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd', '#8c564b', '#e377c2', '#7f7f7f', '#13c2c2', '#bdb76b', '#6a5acd', '#20b2aa', '#ff6347'];

                                if (ax.length > 0 && ay.length === ax.length && ct.length === ax.length && types.length > 0) {
                                    // Group indices by cell type
                                    const idxByType = new Map();
                                    types.forEach(t => idxByType.set(String(t), []));
                                    for (let i = 0; i < ax.length; i++) {
                                        const t = String(ct[i] || 'Unknown');
                                        if (!idxByType.has(t)) idxByType.set(t, []);
                                        idxByType.get(t).push(i);
                                    }
                                    types.forEach((t, idx) => {
                                        const idxs = idxByType.get(String(t)) || [];
                                        const x = idxs.map(i => ax[i]);
                                        const y = idxs.map(i => ay[i]);
                                        // Guard: strip trailing count like ": 123" or "123" from label
                                        const displayLabel = String(t).replace(/\s*[:]\s*\d+\s*$/, '');
                                        const labelCount = counts && counts[String(t)] ? counts[String(t)] : x.length;
                                        annotationData.push({
                                            x: x,
                                            y: y,
                                            mode: 'markers',
                                            type: 'scattergl',
                                            name: `${displayLabel}: ${labelCount}`,
                                            marker: { color: annotationPalette[idx % annotationPalette.length], size: 3, opacity: 0.7 },
                                            hovertemplate: '<b>%{text}</b><br>' +
                                                           'UMAP_1: %{x:.2f}<br>' +
                                                           'UMAP_2: %{y:.2f}<br>' +
                                                           '<extra></extra>',
                                            text: Array(x.length).fill(displayLabel)
                                        });
                                    });
                                }
                                
                                const annotationLayout = {
                                    title: '',
                                    xaxis: {
                                        title: 'UMAP_1',
                                        showgrid: true,
                                        gridcolor: 'lightgray',
                                        zeroline: false,
                                        titlefont: { size: 12, color: '#2c3e50' },
                                        tickfont: { size: 10, color: '#2c3e50' }
                                    },
                                    yaxis: {
                                        title: 'UMAP_2',
                                        showgrid: true,
                                        gridcolor: 'lightgray',
                                        zeroline: false,
                                        titlefont: { size: 12, color: '#2c3e50' },
                                        tickfont: { size: 10, color: '#2c3e50' }
                                    },
                                    plot_bgcolor: 'rgba(0,0,0,0)',
                                    paper_bgcolor: 'rgba(0,0,0,0)',
                                    margin: { l: 60, r: 20, t: 20, b: 60 },
                                    showlegend: true,
                                    legend: {
                                        title: { text: 'Predicted cell type', font: { size: 16 } },
                                        font: { size: 10, family: 'Arial' },
                                        itemsizing: 'constant',
                                        x: 1.2,
                                        y: 0.5,
                                        xanchor: 'left',
                                        yanchor: 'middle'
                                    },
                                    font: { family: 'Arial, sans-serif' }
                                };
                                
                                const annotationConfig = {
                                    displayModeBar: false,
                                    responsive: true
                                };
                                
                                Plotly.newPlot('cell-annotation-plot', annotationData, annotationLayout, annotationConfig);
                            </script>
</section>
<!-- Top Features by Cluster Table -->
<section class="section-card" data-library-content="gene-expression">
<h3 class="tooltip" data-tooltip="Top differentially expressed genes for each cluster based on log2 fold-change">Top Features by Cluster
                                <button id="toggle-marker-explanation" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(59, 130, 246, 0.3)'; this.style.background='#3b82f6'" onmouseover="this.style.transform='scale(1.1)'; this.style.boxShadow='0 4px 12px rgba(59, 130, 246, 0.4)'; this.style.background='#2563eb'" style="
                                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                    color: white;
                                    border: none;
                                    border-radius: 50%;
                                    width: 28px;
                                    height: 28px;
                                    font-size: 14px;
                                    font-weight: bold;
                                    cursor: pointer;
                                    margin-left: 15px;
                                    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);                                  
                                    display: inline-flex;
                                    align-items: center;
                                    justify-content: center;
                                ">?</button>
</h3>
<div id="marker-explanation" style="
                                display: none; 
                                margin-top: 15px; 
                                padding: 20px; 
                                background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
                                border: none;
                                border-radius: 12px;
                                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
                                
                            ">
<h4 style="
                                    color: #2c3e50;
                                    margin-bottom: 15px;
                                    font-size: 1.1em;
                                    border-bottom: 2px solid #3498db;
                                    padding-bottom: 8px;
                                    display: inline-block;
                                ">Marker Gene Analysis Explanation</h4>
<ul style="
                                    list-style: none;
                                    padding: 0;
                                    margin: 0;
                                ">
<li style="
                                        margin-bottom: 12px;
                                        padding: 12px;
                                        background: rgba(255, 255, 255, 0.8);
                                        border-radius: 8px;
                                        border-left: 4px solid #3498DB;
                                        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                                    "><strong style="color: #2980B9;">Top Features by Cluster:</strong> The differential expression analysis seeks to find, for each cluster, features that are more highly expressed in that cluster relative to the rest of the sample. Here a differential expression test was performed between each cluster and the rest of the sample for each feature. The Log2 fold-change (L2FC) is an estimate of the log2 ratio of expression in a cluster to that in all other cells. A value of 1.0 indicates 2-fold greater expression in the cluster of interest. The p-value is a measure of the statistical significance of the expression difference and is based on a negative binomial test. The p-value reported here has been adjusted for multiple testing via the Benjamini-Hochberg procedure. In this table you can click on a column to sort by that value. Also, in this table features were filtered by (Mean UMI counts &gt; 1.0) and the top N features by L2FC for each cluster were retained. Features with L2FC &lt; 0 or adjusted p-value &gt;= 0.10 were grayed out. The number of top features shown per cluster, N, is set to limit the number of table entries shown to 10,000; N=10,000/K^2 where K is the number of clusters. N can range from 1 to 50. </li>
</ul>
</div>
<!-- Search Box -->
<div class="marker-search-row" style="
                                display: flex;
                                justify-content: flex-end;
                                margin: 20px 0 10px 0;
                            ">
<div style="
                                    display: flex;
                                    align-items: center;
                                    gap: 10px;
                                ">
<label for="marker-search" style="
                                        font-weight: 500;
                                        color: #333;
                                        font-size: 14px;
                                    ">Search:</label>
<input id="marker-search" onkeyup="filterMarkerTable()" placeholder="Search genes..." style="
                                        padding: 8px 12px;
                                        border: 2px solid #ddd;
                                        border-radius: 6px;
                                        font-size: 14px;
                                        width: 200px;
                                        transition: border-color 0.3s ease;
                                    " type="text"/>
</div>
</div>
<div class="marker-table-container" style="
                                background: white;
                                border-radius: 8px;
                                padding: 20px;
                                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                                overflow-x: auto;
                                -webkit-overflow-scrolling: touch;
                            ">
<table id="marker-table" style="
                                    min-width: 100%;
                                    width: max-content;
                                    border-collapse: collapse;
                                    font-size: 12px;
                                    background: white;
                                ">
<thead id="markerTableHeader">
<!-- Dynamic headers will be generated by JavaScript -->
</thead>
<tbody id="marker-table-body">
<!-- Data will be populated by JavaScript -->
</tbody>
</table>
</div>
<!-- Pagination Controls -->
<div style="
                                    display: flex;
                                    justify-content: space-between;
                                    align-items: center;
                                    margin-top: 20px;
                                    padding: 15px 0;
                                    border-top: 1px solid #dee2e6;
                                ">
<div style="color: #6c757d; font-size: 14px;">
                                        Showing <span id="marker-table-start">1</span>-<span id="marker-table-end">10</span> of <span id="marker-table-total">50</span> entries
                                    </div>
<!-- Entries selector in the middle -->
<div style="display: flex; align-items: center; gap: 10px;">
<span style="color: #495057; font-size: 14px;">Show</span>
<select id="marker-rows-selector" style="
                                            padding: 6px 10px;
                                            border: 1px solid #dee2e6;
                                            border-radius: 4px;
                                            background: white;
                                            color: #495057;
                                            font-size: 14px;
                                            cursor: pointer;
                                        ">
<option value="5">5</option>
<option selected="" value="10">10</option>
<option value="50">50</option>
<option value="100">100</option>
</select>
<span style="color: #495057; font-size: 14px;">entries</span>
</div>
<div style="display: flex; gap: 5px;">
<button disabled="" id="marker-prev-btn" style="
                                            padding: 8px 12px;
                                            border: 1px solid #dee2e6;
                                            background: white;
                                            color: #495057;
                                            border-radius: 4px;
                                            cursor: pointer;
                                            font-size: 14px;
                                        ">Previous</button>
<button id="marker-next-btn" style="
                                            padding: 8px 12px;
                                            border: 1px solid #dee2e6;
                                            background: white;
                                            color: #495057;
                                            border-radius: 4px;
                                            cursor: pointer;
                                            font-size: 14px;
                                        ">Next</button>
</div>
</div>
</section></div>

</div>
<!-- Library Tab -->
<div class="tab-pane" id="library-tab" style="padding-top: 0;">
<!-- Library Type Selector removed; using global selector above -->
<!-- Sequencing Metrics Card -->
<section class="section-card" data-library-content="gene-expression">
<h3 class="tooltip" data-tooltip="Quality metrics for sequencing data including read counts and base quality scores">Sequencing Metrics
                                <button id="toggle-sequencing-explanation" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(59, 130, 246, 0.3)'; this.style.background='#3b82f6'" onmouseover="this.style.transform='scale(1.1)'; this.style.boxShadow='0 4px 12px rgba(59, 130, 246, 0.4)'; this.style.background='#2563eb'" style="
                                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                    color: white;
                                    border: none;
                                    border-radius: 50%;
                                    width: 28px;
                                    height: 28px;
                                    font-size: 14px;
                                    font-weight: bold;
                                    cursor: pointer;
                                    margin-left: 15px;
                                    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);                                  
                                    display: inline-flex;
                                    align-items: center;
                                    justify-content: center;
                                ">?</button>
</h3>
<div id="sequencing-explanation" style="
                                display: none; 
                                margin: 15px 0;
                                background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
                                border: none;
                                padding: 20px; 
                                border-radius: 12px;
                                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
                                
                            ">
<h4 style="
                                    color: #2c3e50;
                                    margin-bottom: 15px;
                                    font-size: 1.1em;
                                    border-bottom: 2px solid #3498db;
                                    padding-bottom: 8px;
                                    display: inline-block;
                                ">Sequencing Metrics Explanation</h4>
<ul style="
                                    list-style: none;
                                    padding: 0;
                                    margin: 0;
                                ">
<li style="
                                        margin-bottom: 12px;
                                        padding: 12px;
                                        background: rgba(255, 255, 255, 0.8);
                                        border-radius: 8px;
                                        border-left: 4px solid #4CAF50;
                                        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                                    "><strong style="color: #388E3C;">cDNA(left): </strong> </li>
<li style="
                                        margin-bottom: 12px;
                                        padding: 12px;
                                        background: rgba(255, 255, 255, 0.8);
                                        border-radius: 8px;
                                        border-left: 4px solid #FFC107;
                                        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                                    "><strong style="color: #FFA000;">oligo(right):</strong> Oligonucleotide sequencing metrics for feature barcoding</li>
<li style="
                                        margin-bottom: 12px;
                                        padding: 12px;
                                        background: rgba(255, 255, 255, 0.8);
                                        border-radius: 8px;
                                        border-left: 4px solid #2196F3;
                                        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                                    "><strong style="color: #1976D2;">Q30 Scores:</strong> Percentage of bases with quality score 30 (99.9% accuracy)</li>
</ul>
</div>
<div class="metrics-container" style="display: flex; gap: 20px;">
<div class="metrics-column" style="flex: 1;">
<h4 style="text-align: center; color: #2c3e50; margin-bottom: 15px; font-size: 1.1em; background: var(--section-gradient); padding: 10px; border-radius: 8px;">cDNA</h4>
<div class="stats-table-container" style="overflow-x: auto;">
<table style="
                                            width: 100%;
                                            border-collapse: collapse;
                                            background: white;
                                            border-radius: 8px;
                                            overflow: hidden;
                                            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                                        ">
<tbody>
<tr style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
<td style="padding: 12px 15px; font-weight: 600; color: #2c3e50; border-bottom: 1px solid #dee2e6;">
                                                        Number of reads
                                                    </td>
<td style="padding: 12px 15px; color: #495057; border-bottom: 1px solid #dee2e6; font-weight: 600; text-align: right;">${rna_cdna_raw_reads}</td>
</tr>
<tr style="background: white;">
<td style="padding: 12px 15px; font-weight: 600; color: #2c3e50; border-bottom: 1px solid #dee2e6;">
                                                        Valid barcodes
                                                    </td>
<td style="padding: 12px 15px; color: #495057; border-bottom: 1px solid #dee2e6; font-weight: 600; text-align: right;">${rna_cdna_valid_barcode}</td>
</tr>
<tr style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
<td style="padding: 12px 15px; font-weight: 600; color: #2c3e50; border-bottom: 1px solid #dee2e6;">
                                                        Corrected barcodes
                                                    </td>
<td style="padding: 12px 15px; color: #495057; border-bottom: 1px solid #dee2e6; font-weight: 600; text-align: right;">${rna_cdna_corrected_barcode}</td>
</tr>
<tr style="background: white;">
<td style="padding: 12px 15px; font-weight: 600; color: #2c3e50; border-bottom: 1px solid #dee2e6;">
                                                        Valid UMIs
                                                    </td>
<td style="padding: 12px 15px; color: #495057; border-bottom: 1px solid #dee2e6; font-weight: 600; text-align: right;">${rna_cdna_valid_umi}</td>
</tr>
<tr style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
<td style="padding: 12px 15px; font-weight: 600; color: #2c3e50; border-bottom: 1px solid #dee2e6;">
                                                        Q30 bases in barcode
                                                    </td>
<td style="padding: 12px 15px; color: #495057; border-bottom: 1px solid #dee2e6; font-weight: 600; text-align: right;">${rna_cdna_q30_barcode}</td>
</tr>
<tr style="background: white;">
<td style="padding: 12px 15px; font-weight: 600; color: #2c3e50; border-bottom: 1px solid #dee2e6;">
                                                        Q30 bases in UMI
                                                    </td>
<td style="padding: 12px 15px; color: #495057; border-bottom: 1px solid #dee2e6; font-weight: 600; text-align: right;">${rna_cdna_q30_umi}</td>
</tr>
<tr style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
<td style="padding: 12px 15px; font-weight: 600; color: #2c3e50;">
                                                        Q30 bases in RNA read
                                                    </td>
<td style="padding: 12px 15px; color: #495057; font-weight: 600; text-align: right;">${rna_cdna_q30_read}</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="metrics-column" style="flex: 1;">
<h4 style="text-align: center; color: #2c3e50; margin-bottom: 15px; font-size: 1.1em; background: var(--section-gradient); padding: 10px; border-radius: 8px;">Oligo</h4>
<div class="stats-table-container" style="overflow-x: auto;">
<table style="
                                            width: 100%;
                                            border-collapse: collapse;
                                            background: white;
                                            border-radius: 8px;
                                            overflow: hidden;
                                            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                                        ">
<tbody>
<tr style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
<td style="padding: 12px 15px; font-weight: 600; color: #2c3e50; border-bottom: 1px solid #dee2e6;">
                                                        Number of reads
                                                    </td>
<td style="padding: 12px 15px; color: #495057; border-bottom: 1px solid #dee2e6; font-weight: 600; text-align: right;">${rna_index_num_reads}</td>
</tr>
<tr style="background: white;">
<td style="padding: 12px 15px; font-weight: 600; color: #2c3e50; border-bottom: 1px solid #dee2e6;">
                                                        Valid barcodes
                                                    </td>
<td style="padding: 12px 15px; color: #495057; border-bottom: 1px solid #dee2e6; font-weight: 600; text-align: right;">${rna_index_valid_barcode}</td>
</tr>
<tr style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
<td style="padding: 12px 15px; font-weight: 600; color: #2c3e50; border-bottom: 1px solid #dee2e6;">
                                                        Corrected barcodes
                                                    </td>
<td style="padding: 12px 15px; color: #495057; border-bottom: 1px solid #dee2e6; font-weight: 600; text-align: right;">${rna_index_corrected_barcode}</td>
</tr>
<tr style="background: white;">
<td style="padding: 12px 15px; font-weight: 600; color: #2c3e50; border-bottom: 1px solid #dee2e6;">
                                                        Q30 bases in barcode
                                                    </td>
<td style="padding: 12px 15px; color: #495057; border-bottom: 1px solid #dee2e6; font-weight: 600; text-align: right;">${rna_index_q30_barcode}</td>
</tr>
<tr style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
<td style="padding: 12px 15px; font-weight: 600; color: #2c3e50;">
                                                        Q30 bases in index read
                                                    </td>
<td style="padding: 12px 15px; color: #495057; font-weight: 600; text-align: right;">${rna_index_q30_read}</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</section>
<!-- VDJ-T Sequencing Enrichment Metrics Section -->
<!-- VDJ-B Sequencing Enrichment Metrics Section -->
<!-- ATAC Metrics Section -->
<!-- Mapping Metrics Card -->
<section class="section-card" data-library-content="gene-expression">
<h3 class="tooltip" data-tooltip="Read mapping statistics and genomic annotation analysis">Mapping Metrics
                                <button id="toggle-mapping-explanation" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(59, 130, 246, 0.3)'; this.style.background='#3b82f6'" onmouseover="this.style.transform='scale(1.1)'; this.style.boxShadow='0 4px 12px rgba(59, 130, 246, 0.4)'; this.style.background='#2563eb'" style="
                                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                    color: white;
                                    border: none;
                                    border-radius: 50%;
                                    width: 28px;
                                    height: 28px;
                                    font-size: 14px;
                                    font-weight: bold;
                                    cursor: pointer;
                                    margin-left: 15px;
                                    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);                                   
                                    display: inline-flex;
                                    align-items: center;
                                    justify-content: center;
                                ">?</button>
</h3>
<div id="mapping-explanation" style="
                                display: none; 
                                margin: 15px 0;
                                background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
                                border: none;
                                padding: 20px; 
                                border-radius: 12px;
                                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
                                
                            ">
<h4 style="
                                    color: #2c3e50;
                                    margin-bottom: 15px;
                                    font-size: 1.1em;
                                    border-bottom: 2px solid #3498db;
                                    padding-bottom: 8px;
                                    display: inline-block;
                                ">Mapping Metrics Explanation</h4>
<ul style="
                                    list-style: none;
                                    padding: 0;
                                    margin: 0;
                                ">
<li style="
                                        margin-bottom: 12px;
                                        padding: 12px;
                                        background: rgba(255, 255, 255, 0.8);
                                        border-radius: 8px;
                                        border-left: 4px solid #4CAF50;
                                        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                                    "><strong style="color: #388E3C;">All Reads:</strong> Overall mapping statistics for the entire dataset including all sequenced reads.</li>
<li style="
                                        margin-bottom: 12px;
                                        padding: 12px;
                                        background: rgba(255, 255, 255, 0.8);
                                        border-radius: 8px;
                                        border-left: 4px solid #FFC107;
                                        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                                    "><strong style="color: #FFA000;">Filtered Cells:</strong> Mapping metrics for high-quality cells only after quality filtering and doublet removal.</li>
<li style="
                                        margin-bottom: 12px;
                                        padding: 12px;
                                        background: rgba(255, 255, 255, 0.8);
                                        border-radius: 8px;
                                        border-left: 4px solid #2196F3;
                                        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                                    "><strong style="color: #1976D2;">Genomic Regions:</strong> Distribution across exonic, intronic, and intergenic regions showing where reads align in the genome.</li>
</ul>
</div>
<div class="metrics-container" style="display: flex; gap: 20px;">
<div class="metrics-column" style="flex: 1;">
<h4 style="text-align: center; color: #2c3e50; margin-bottom: 15px; font-size: 1.1em; background: var(--section-gradient); padding: 10px; border-radius: 8px;">All Reads</h4>
<div class="stats-table-container" style="overflow-x: auto;">
<table style="
                                            width: 100%;
                                            border-collapse: collapse;
                                            background: white;
                                            border-radius: 8px;
                                            overflow: hidden;
                                            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                                        ">
<tbody>
<tr style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
<td style="padding: 12px 15px; font-weight: 600; color: #2c3e50; border-bottom: 1px solid #dee2e6;">
                                                        Reads mapped to genome
                                                    </td>
<td style="padding: 12px 15px; color: #495057; border-bottom: 1px solid #dee2e6; font-weight: 600; text-align: right;">${rna_mapped}</td>
</tr>
<tr style="background: white;">
<td style="padding: 12px 15px; font-weight: 600; color: #2c3e50; border-bottom: 1px solid #dee2e6;">
                                                        Reads mapped confidently to genome
                                                    </td>
<td style="padding: 12px 15px; color: #495057; border-bottom: 1px solid #dee2e6; font-weight: 600; text-align: right;">${rna_mapped_conf}</td>
</tr>
<tr style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
<td style="padding: 12px 15px; font-weight: 600; color: #2c3e50; border-bottom: 1px solid #dee2e6;">
                                                        Reads mapped confidently to transcriptome
                                                    </td>
<td style="padding: 12px 15px; color: #495057; border-bottom: 1px solid #dee2e6; font-weight: 600; text-align: right;">${rna_transcriptome_conf}</td>
</tr>
<tr style="background: white;">
<td style="padding: 12px 15px; font-weight: 600; color: #2c3e50; border-bottom: 1px solid #dee2e6;">
                                                        Reads mapped confidently to exonic regions
                                                    </td>
<td style="padding: 12px 15px; color: #495057; border-bottom: 1px solid #dee2e6; font-weight: 600; text-align: right;">${rna_exon_conf}</td>
</tr>
<tr style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
<td style="padding: 12px 15px; font-weight: 600; color: #2c3e50; border-bottom: 1px solid #dee2e6;">
                                                        Reads mapped confidently to intronic regions
                                                    </td>
<td style="padding: 12px 15px; color: #495057; border-bottom: 1px solid #dee2e6; font-weight: 600; text-align: right;">${rna_intron_conf}</td>
</tr>
<tr style="background: white;">
<td style="padding: 12px 15px; font-weight: 600; color: #2c3e50; border-bottom: 1px solid #dee2e6;">
                                                        Reads mapped confidently to intergenic regions
                                                    </td>
<td style="padding: 12px 15px; color: #495057; border-bottom: 1px solid #dee2e6; font-weight: 600; text-align: right;">${rna_intergenic_conf}</td>
</tr>
<tr style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
<td style="padding: 12px 15px; font-weight: 600; color: #2c3e50;">
                                                        Reads mapped antisense to gene
                                                    </td>
<td style="padding: 12px 15px; color: #495057; font-weight: 600; text-align: right;">${rna_antisense}</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="metrics-column" style="flex: 1;">
<h4 style="text-align: center; color: #2c3e50; margin-bottom: 15px; font-size: 1.1em; background: var(--section-gradient); padding: 10px; border-radius: 8px;">Filtered Cells</h4>
<div class="stats-table-container" style="overflow-x: auto;">
<table style="
                                            width: 100%;
                                            border-collapse: collapse;
                                            background: white;
                                            border-radius: 8px;
                                            overflow: hidden;
                                            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                                        ">
<tbody>
<tr style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
<td style="padding: 12px 15px; font-weight: 600; color: #2c3e50; border-bottom: 1px solid #dee2e6;">
                                                        Reads mapped to genome
                                                    </td>
<td style="padding: 12px 15px; color: #495057; border-bottom: 1px solid #dee2e6; font-weight: 600; text-align: right;">${rna_mapped_filtered}</td>
</tr>
<tr style="background: white;">
<td style="padding: 12px 15px; font-weight: 600; color: #2c3e50; border-bottom: 1px solid #dee2e6;">
                                                        Reads mapped confidently to genome
                                                    </td>
<td style="padding: 12px 15px; color: #495057; border-bottom: 1px solid #dee2e6; font-weight: 600; text-align: right;">${rna_mapped_conf_filtered}</td>
</tr>
<tr style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
<td style="padding: 12px 15px; font-weight: 600; color: #2c3e50; border-bottom: 1px solid #dee2e6;">
                                                        Reads mapped confidently to transcriptome
                                                    </td>
<td style="padding: 12px 15px; color: #495057; border-bottom: 1px solid #dee2e6; font-weight: 600; text-align: right;">${rna_transcriptome_conf_filtered}</td>
</tr>
<tr style="background: white;">
<td style="padding: 12px 15px; font-weight: 600; color: #2c3e50; border-bottom: 1px solid #dee2e6;">
                                                        Reads mapped confidently to exonic regions
                                                    </td>
<td style="padding: 12px 15px; color: #495057; border-bottom: 1px solid #dee2e6; font-weight: 600; text-align: right;">${rna_exon_conf_filtered}</td>
</tr>
<tr style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
<td style="padding: 12px 15px; font-weight: 600; color: #2c3e50; border-bottom: 1px solid #dee2e6;">
                                                        Reads mapped confidently to intronic regions
                                                    </td>
<td style="padding: 12px 15px; color: #495057; border-bottom: 1px solid #dee2e6; font-weight: 600; text-align: right;">${rna_intron_conf_filtered}</td>
</tr>
<tr style="background: white;">
<td style="padding: 12px 15px; font-weight: 600; color: #2c3e50; border-bottom: 1px solid #dee2e6;">
                                                        Reads mapped confidently to intergenic regions
                                                    </td>
<td style="padding: 12px 15px; color: #495057; border-bottom: 1px solid #dee2e6; font-weight: 600; text-align: right;">${rna_intergenic_conf_filtered}</td>
</tr>
<tr style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
<td style="padding: 12px 15px; font-weight: 600; color: #2c3e50;">
                                                        Reads mapped antisense to gene
                                                    </td>
<td style="padding: 12px 15px; color: #495057; font-weight: 600; text-align: right;">${rna_antisense_filtered}</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</section>
<!-- ATAC Cell Quality Metrics Section -->
<section class="section-card" data-library-content="gene-expression">
<h3 class="tooltip" data-tooltip="Sequencing saturation analysis showing library complexity and sequencing depth efficiency">Saturation
                                <button id="toggle-saturation-explanation" onmouseout="this.style.transform='scale(1)'" onmouseover="this.style.transform='scale(1.1)'" style="
                                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                    color: white;
                                    border: none;
                                    border-radius: 50%;
                                    width: 28px;
                                    height: 28px;
                                    font-size: 14px;
                                    font-weight: bold;
                                    cursor: pointer;
                                    margin-left: 15px;
                                    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
                                    
                                ">?</button>
</h3>
<!-- Saturation Explanation -->
<div id="saturation-explanation" style="
                                display: none; 
                                margin: 15px 0;
                                background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
                                border: none;
                                padding: 20px; 
                                border-radius: 12px;
                                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
                                
                            ">
<h4 style="
                                    color: #2c3e50;
                                    margin-bottom: 15px;
                                    font-size: 1.1em;
                                    border-bottom: 2px solid #3498db;
                                    padding-bottom: 8px;
                                    display: inline-block;
                                ">Saturation Analysis Explanation</h4>
<ul style="
                                    list-style: none;
                                    padding: 0;
                                    margin: 0;
                                ">
<li style="
                                        margin-bottom: 12px;
                                        padding: 12px;
                                        background: rgba(255, 255, 255, 0.8);
                                        border-radius: 8px;
                                        border-left: 4px solid #4CAF50;
                                        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                                    "><strong style="color: #388E3C;">Left: Sequencing Saturation Curve:</strong> This plot shows how sequencing saturation varies with increasing sequencing depth, measured as mean reads per cell (downsampled). Saturation is calculated as 1 minus the ratio of unique UMI counts to total UMI counts, reflecting library complexity. A saturation value nearing 1.0 (100%) indicates that most mRNA transcripts have been captured. A plateau in the curve suggests that additional sequencing yields minimal new information, aiding in assessing whether the current depth is sufficient and cost-effective.</li>
<li style="
                                        margin-bottom: 12px;
                                        padding: 12px;
                                        background: rgba(255, 255, 255, 0.8);
                                        border-radius: 8px;
                                        border-left: 4px solid #FFC107;
                                        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                                    "><strong style="color: #FFA000;">Right: Median Genes per Cell Curve:</strong> This plot illustrates the median number of genes detected per cell across different sequencing depths. It highlights transcriptome complexity and per-cell sequencing coverage. A flattening curve near the observed depth indicates diminishing returns in gene detection with further sequencing.</li>
</ul>
</div>
<!-- Sequencing saturation parameter display -->
<div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
<div style="flex: 1; padding-right: 20px;">
<div style="display: inline-block; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 12px; padding: 15px 25px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); margin-bottom: 15px;">
<span style="font-weight: 600; color: #2c3e50; font-size: 1.1em;">Sequencing saturation:</span>
<span style="font-weight: 700; color: #2c3e50; font-size: 1.0em;">&nbsp;&nbsp;${rna_saturation}</span>
</div>
</div>
<div style="flex: 1; padding-left: 20px;">
<!-- Right side parameter space for future use -->
</div>
</div>
<!-- Left and Right Chart Container -->
<div class="responsive-two-col-grid">
<!-- Left side: Barcode Rank Plot -->
<div>
<div style="
                                        background: white;
                                        border-radius: 8px;
                                        padding: 15px;
                                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                                        height: 100%;
                                        display: flex;
                                        flex-direction: column;
                                        justify-content: center;
                                        align-items: center;
                                        min-height: 400px;
                                    ">
<h4 style="color: #2c3e50; margin-bottom: 15px; text-align: center;">Sequencing Saturation Curve</h4>
<div id="rna-sequencing-saturation" style="width: 400px; height: 350px; margin: 0 auto;"></div>
<script>
// Sequencing saturation plot (inline)
const rnaSatSfJSON = '${rna_saturation_sampling_fraction}';
const rnaSatSeqJSON = '${rna_saturation_seq_pct}';
const rnaMeanReadsStr = '${rna_mean_reads_percell}';
let rnaSatSfs = []; try { rnaSatSfs = JSON.parse(rnaSatSfJSON); } catch (e) { rnaSatSfs = []; }
let rnaSatSeqPct = []; try { rnaSatSeqPct = JSON.parse(rnaSatSeqJSON); } catch (e) { rnaSatSeqPct = []; }
const rnaMeanReads = Number(String(rnaMeanReadsStr || '').replace(/,/g, '').replace(/%/g, '')) || 0;
const rnaSeqX = rnaSatSfs.map(v => Number(v) * rnaMeanReads);
const rnaSeqY = rnaSatSeqPct.map(v => Number(v));
const xMaxSeq = rnaSeqX.length ? Math.max(...rnaSeqX) : 0;
const rnaSeqData = [{ x: rnaSeqX, y: rnaSeqY, type: 'scatter', mode: 'lines', line: { color: '#2980b9', width: 3 } }];
  const rnaSeqLayout = {
    autosize: true,
    height: 350,
    plot_bgcolor: 'rgba(0,0,0,0)',
    paper_bgcolor: 'rgba(0,0,0,0)',
    margin: { l: 40, r: 20, t: 40, b: 40 },
    xaxis: { title: { text: 'Mean Reads per Cell', font: { size: 12 } }, gridcolor: 'lightgray', zeroline: true, zerolinecolor: 'gray', tickformat: '~s', hoverformat: ',.0f', range: [0, xMaxSeq], anchor: 'y', side: 'bottom' },
    yaxis: { title: { text: '', standoff: 0 }, gridcolor: 'lightgray', range: [0, 100], zeroline: true, zerolinecolor: 'gray', automargin: true },
    annotations: [{
      text: 'Percent',
      x: 0,
      y: 1,
      yshift: 30,
      xref: 'paper',
      yref: 'paper',
      showarrow: false,
      xanchor: 'left',
      yanchor: 'top',
      align: 'left',
      font: { family: 'Inter', size: 12, color: '#2c3e50' }
    }]
  };
const rnaSeqTarget = document.getElementById('rna-sequencing-saturation');
if (rnaSeqTarget) {
  if (rnaSeqX.length && rnaSeqY.length && rnaSeqX.length === rnaSeqY.length) {
    Plotly.newPlot('rna-sequencing-saturation', rnaSeqData, rnaSeqLayout, { displayModeBar: false, responsive: true, useResizeHandler: true });
  } else {
    rnaSeqTarget.innerHTML = '<div style="color:#6c757d;">No available data</div>';
  }
}
</script>
</div>
</div>
<!-- Right side: Bead Count Distribution -->
<div>
<div style="
                                        background: white;
                                        border-radius: 8px;
                                        padding: 15px;
                                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                                        height: 100%;
                                        display: flex;
                                        flex-direction: column;
                                        justify-content: center;
                                        align-items: center;
                                        min-height: 400px;
                                    ">
<h4 style="color: #2c3e50; margin-bottom: 15px; text-align: center;">Median Genes per Cell Curve</h4>
<div id="rna-gene-saturation" style="width: 400px; height: 350px; margin: 0 auto;"></div>
<script>
// Median genes per cell curve (inline)
const rnaSatSfJSON2 = '${rna_saturation_sampling_fraction}';
const rnaSatGeneJSON = '${rna_saturation_median_genes}';
const rnaMeanReadsStr2 = '${rna_mean_reads_percell}';
let rnaSatSfs2 = []; try { rnaSatSfs2 = JSON.parse(rnaSatSfJSON2); } catch (e) { rnaSatSfs2 = []; }
let rnaSatGenes = []; try { rnaSatGenes = JSON.parse(rnaSatGeneJSON); } catch (e) { rnaSatGenes = []; }
const rnaMeanReads2 = Number(String(rnaMeanReadsStr2 || '').replace(/,/g, '').replace(/%/g, '')) || 0;
const rnaGeneX = rnaSatSfs2.map(v => Number(v) * rnaMeanReads2);
const rnaGeneY = rnaSatGenes.map(v => Number(v));
const xMaxGene = rnaGeneX.length ? Math.max(...rnaGeneX) : 0;
const yMaxGene = rnaGeneY.length ? Math.max(...rnaGeneY) : 0;
const rnaGeneData = [{ x: rnaGeneX, y: rnaGeneY, type: 'scatter', mode: 'lines', line: { color: '#2980b9', width: 3 } }];
  const rnaGeneLayout = {
    autosize: true,
    height: 350,
    plot_bgcolor: 'rgba(0,0,0,0)',
    paper_bgcolor: 'rgba(0,0,0,0)',
    margin: { l: 40, r: 20, t: 40, b: 40 },
    xaxis: { title: { text: 'Mean Reads per Cell', font: { size: 12 } }, gridcolor: 'lightgray', zeroline: true, zerolinecolor: 'gray', tickformat: '~s', hoverformat: ',.0f', range: [0, xMaxGene], anchor: 'y', side: 'bottom' },
    yaxis: { title: { text: '', standoff: 0 }, gridcolor: 'lightgray', zeroline: true, zerolinecolor: 'gray', automargin: true, range: [0, yMaxGene], anchor: 'x' },
    annotations: [{
      text: 'Count',
      x: 0,
      y: 1,
      yshift: 30,
      xref: 'paper',
      yref: 'paper',
      showarrow: false,
      xanchor: 'left',
      yanchor: 'top',
      align: 'left',
      font: { family: 'Inter', size: 12, color: '#2c3e50' }
    }]
  };
const rnaGeneTarget = document.getElementById('rna-gene-saturation');
if (rnaGeneTarget) {
  if (rnaGeneX.length && rnaGeneY.length && rnaGeneX.length === rnaGeneY.length) {
    Plotly.newPlot('rna-gene-saturation', rnaGeneData, rnaGeneLayout, { displayModeBar: false, responsive: true, useResizeHandler: true });
  } else {
    rnaGeneTarget.innerHTML = '<div style="color:#6c757d;">No available data</div>';
  }
}
</script>
</div>
</div>
</div>
<!-- Legacy Multi-bead Comparison (hidden by default) -->
<div style="display: none;">
<div class="chart-container">
<div class="chart-title">Multi-bead Comparison</div>
                                    {{ multibeads_base }}
                                </div>
</div>
<script>
                                document.getElementById('toggle-saturation-explanation').addEventListener('click', function() {
                                    const explanationDiv = document.getElementById('saturation-explanation');
                                    if (explanationDiv.style.display === 'none') {
                                        explanationDiv.style.display = 'block';
                                    } else {
                                        explanationDiv.style.display = 'none';
                                    }
                                });
                            </script>
</section>
</div>
<!-- Parameters Tab -->
    
</div>
</div>
</div>

<!-- Interactive JavaScript -->
<script>
        // --- MANUAL CONFIGURATION ---
        // To manually show or hide the VDJ Target sections, set the flags below.
        // 'true' will show the section, 'false' will hide it, overriding backend settings.
        const manualSectionConfig = {
            // 'vdj-t-target': true, // Uncomment to override
            // 'vdj-b-target': true, // Uncomment to override
        };
        // --------------------------

        let sectionConfig; // Global config object

        // Helper function for rendering text data into a preformatted block
        function renderTextData(containerId, dataString, emptyMessage) {
            const container = document.getElementById(containerId);
            if (!container) return;

            if (!dataString || dataString.trim() === '' || dataString.trim() === 'undefined') {
                container.innerHTML = `<p style="padding: 12px; color: #64748b;">${emptyMessage}</p>`;
                return;
            }

        const pre = document.createElement('pre');
            pre.style.whiteSpace = 'pre';
            pre.style.fontFamily = 'ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';
            pre.style.background = 'var(--secondary-color)';
            pre.style.border = '1px solid var(--border-color)';
            pre.style.borderRadius = '8px';
            pre.style.padding = '12px';
            pre.style.margin = '0';
            pre.style.lineHeight = '1.4';
            pre.style.overflowX = 'auto';
            pre.style.overflowY = 'hidden';
            pre.style.maxWidth = '100%';
            pre.textContent = dataString.trim();

            container.innerHTML = '';
            container.appendChild(pre);
        }

        // Tab switching functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize sectionConfig by merging backend and manual settings
            try {
                const backendConfig = {
                    'cell-annotation': String('${cell_annotation_available}').trim().toLowerCase() === 'true',
                    'vdj-t-target': String('${vdj_t_target_enabled}').trim().toLowerCase() === 'true',
                    'vdj-b-target': String('${vdj_b_target_enabled}').trim().toLowerCase() === 'true'
                };
                // Merge manual config over backend config. Manually defined values take precedence.
                sectionConfig = { ...backendConfig, ...manualSectionConfig };
            } catch (e) {
                console.warn('Failed to parse backend config, using manual/default values:', e);
                sectionConfig = {
                    'cell-annotation': false,
                    'vdj-t-target': false,
                    'vdj-b-target': false,
                    ...manualSectionConfig
                };
            }

            // Initialize section visibility based on the final configuration
            initializeSectionVisibility();
            
            // Toggle ATAC Cell Quality Metrics explanation
            const atacCellToggle = document.getElementById('toggle-atac-cell-explanation');
            if (atacCellToggle) {
                atacCellToggle.addEventListener('click', function() {
                    const explanation = document.getElementById('atac-cell-explanation');
                    if (explanation.style.display === 'none' || explanation.style.display === '') {
                        explanation.style.display = 'block';
                    } else {
                        explanation.style.display = 'none';
                    }
                });
            }
            
            const tabButtons = document.querySelectorAll('.library-tab-btn[data-tab]');
            const tabPanes = document.querySelectorAll('.tab-pane');

            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const targetTab = this.getAttribute('data-tab');

                    // Remove active class from all buttons and panes
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabPanes.forEach(pane => pane.classList.remove('active'));

                    // Add active class to clicked button and corresponding pane
                    this.classList.add('active');
                    const targetPane = document.getElementById(targetTab + '-tab');
                    if (targetPane) {
                        targetPane.classList.add('active');
                        // Scroll to the top of the page when switching tabs
                        window.scrollTo({
                            top: 0,
                            behavior: 'auto'
                        });
                    }
                });
            });
        });

        // Smooth scrolling for navigation
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                const targetId = this.getAttribute('href');
                const targetSection = document.querySelector(targetId);
                
                if (targetSection) {
                    targetSection.scrollIntoView({
                        behavior: 'auto',
                        block: 'start'
                    });
                    
                    // Update active navigation item
                    document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                    this.classList.add('active');
                }
            });
        });

        // Intersection Observer for navigation highlighting
        const observerOptions = {
            root: null,
            rootMargin: '-20% 0px -70% 0px',
            threshold: 0
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const id = entry.target.getAttribute('id');
                    document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                    const activeNav = document.querySelector(`[href="#${id}"]`);
                    if (activeNav) activeNav.classList.add('active');
                }
            });
        }, observerOptions);

        // Observe all sections with IDs
        document.querySelectorAll('section[id]').forEach(section => {
            observer.observe(section);
        });

        

        



        

        

        

        // Cells explanation toggle functionality
        document.getElementById('toggle-cells-explanation').addEventListener('click', function() {
            var explanationDiv = document.getElementById('cells-explanation');
            if (explanationDiv.style.display === 'none') {
                explanationDiv.style.display = 'block';
            } else {
                explanationDiv.style.display = 'none';
            }
        });



        // Clonotype explanation toggle functionality
        document.getElementById('toggle-clonotype-explanation').addEventListener('click', function() {
            var explanationDiv = document.getElementById('vdj-t-clonotype-explanation');
            if (!explanationDiv) return;
            if (explanationDiv.style.display === 'none' || explanationDiv.style.display === '') {
                explanationDiv.style.display = 'block';
            } else {
                explanationDiv.style.display = 'none';
            }
        });

        // Cluster analysis explanation toggle functionality
        document.getElementById('toggle-cluster-explanation').addEventListener('click', function() {
            var explanationDiv = document.getElementById('cluster-explanation');
            if (explanationDiv.style.display === 'none') {
                explanationDiv.style.display = 'block';
            } else {
                explanationDiv.style.display = 'none';
            }
        });

        // Initialize section visibility based on configuration
        function initializeSectionVisibility() {
            // Handle Cell Annotation section visibility
            const cellAnnotationSection = document.querySelector('#cell-annotation-plot').closest('.section-card');
            if (cellAnnotationSection) {
                if (sectionConfig['cell-annotation']) {
                    cellAnnotationSection.style.display = 'block';
                } else {
                    cellAnnotationSection.style.display = 'none';
                }
            }
        }

        function showGeneExpressionOnly() {
            document.querySelectorAll('[data-library-content]').forEach(element => {
                element.style.display = 'none';
            });
            document.querySelectorAll('[data-library-content="gene-expression"]').forEach(element => {
                element.style.display = 'block';
            });
        }

        function loadVdjTClonotypeData() {
            const templateData = '${vdj_t_clonotype_data}';
            let parsedData = null;
            if (templateData && templateData.trim().startsWith('[')) {
                try { parsedData = JSON.parse(templateData); } catch (e) { parsedData = null; }
            }
            if (!parsedData) {
                const scriptEl = document.getElementById('script-vdj-t-clonotype-chart');
                if (scriptEl) {
                    const m = scriptEl.textContent.match(/const\s+vdjTClonoJSON\s*=\s*'([^']*)'/);
                    if (m && m[1] && m[1].trim().startsWith('[')) {
                        try { parsedData = JSON.parse(m[1]); } catch (e) { parsedData = null; }
                    }
                }
            }
            if (parsedData && parsedData.length > 0) {
                const formattedData = parsedData.map(item => {
                    const proportionValue = (typeof item.proportion === 'string' && item.proportion.includes('%'))
                        ? item.proportion
                        : (Number(item.proportion) * 100).toFixed(2) + '%';
                    return { id: item.id, cdr3s: item.cdr3s, frequency: item.frequency, proportion: proportionValue };
                });
                loadClonotypeData(formattedData, 'vdj-t');
            } else {
                loadClonotypeData([], 'vdj-t');
            }
        }

        function loadVdjBClonotypeData() {
            const templateData = '${vdj_b_clonotype_data}';
            let parsedData = null;
            if (templateData && templateData.trim().startsWith('[')) {
                try { parsedData = JSON.parse(templateData); } catch (e) { parsedData = null; }
            }
            if (!parsedData) {
                const scriptEl = document.getElementById('script-vdj-b-clonotype-chart');
                if (scriptEl) {
                    const m = scriptEl.textContent.match(/const\s+vdjBClonoJSON\s*=\s*'([^']*)'/);
                    if (m && m[1] && m[1].trim().startsWith('[')) {
                        try { parsedData = JSON.parse(m[1]); } catch (e) { parsedData = null; }
                    }
                }
            }
            if (parsedData && parsedData.length > 0) {
                const formattedData = parsedData.map(item => {
                    const proportionValue = (typeof item.proportion === 'string' && item.proportion.includes('%'))
                        ? item.proportion
                        : (Number(item.proportion) * 100).toFixed(2) + '%';
                    return { id: item.id, cdr3s: item.cdr3s, frequency: item.frequency, proportion: proportionValue };
                });
                loadClonotypeData(formattedData, 'vdj-b');
            } else {
                loadClonotypeData([], 'vdj-b');
            }
        }

        function loadClonotypeData(data, libraryType) {
            const tableBody = document.getElementById('clonotype-table-body');
            const vdjBTableBody = document.getElementById('vdj-b-clonotype-table-body');
            const targetTableBody = libraryType === 'vdj-b' ? vdjBTableBody : tableBody;
            if (!targetTableBody) return;
            targetTableBody.innerHTML = '';
            if (!data || data.length === 0) {
                targetTableBody.innerHTML = `<tr><td colspan="4" style="padding: 6px 8px; text-align: center; color: #6c757d;">No clonotype data</td></tr>`;
                return;
            }
            data.forEach((item) => {
                const row = document.createElement('tr');
                row.style.background = 'white';
                const cdr3Formatted = String(item.cdr3s || '')
                    .split(';')
                    .map(s => s.trim())
                    .filter(Boolean)
                    .join('<br/>');
                row.innerHTML = `
                    <td style="padding: 6px 8px; color: #495057; border-bottom: 1px solid #dee2e6; font-weight: 600; text-align: center;">${item.id}</td>
                    <td style="padding: 6px 8px; color: #495057; border-bottom: 1px solid #dee2e6; font-family: monospace; font-size: 0.85rem; text-align: left; white-space: normal; overflow-wrap: anywhere; word-break: break-word;">${cdr3Formatted}</td>
                    <td style="padding: 6px 8px; color: #495057; border-bottom: 1px solid #dee2e6; font-weight: 600; text-align: center;">${item.frequency}</td>
                    <td style="padding: 6px 8px; color: #495057; border-bottom: 1px solid #dee2e6; font-weight: 600; text-align: center;">${item.proportion}</td>
                `;
                targetTableBody.appendChild(row);
            });
        }

        // Initialize visibility on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Scroll to top on page load with a small delay to ensure proper positioning
            setTimeout(function() {
                window.scrollTo(0, 0);
                document.documentElement.scrollTop = 0;
                document.body.scrollTop = 0;
            }, 100);
            
            showGeneExpressionOnly();
            
            initializeSectionVisibility();
            
            // Initialize marker table functionality
            initializeMarkerTable();
            
            // Initialize VDJ annotation explanation buttons
            initializeVDJAnnotationButtons();

            // Render CSV and FASTQ data into their respective containers
            const csvData = `${input_csv_data}`;
            renderTextData('csv-table-container', csvData, 'CSV data not available or empty.');
            
            const fastqData = `${fastq_display_html}`;
            renderTextData('fastq-content-container', fastqData, 'FASTQ data not available or empty.');
        });

        // VDJ Annotation Explanation Buttons
        function initializeVDJAnnotationButtons() {
            // VDJ-T annotation button
            const vdjTButton = document.getElementById('toggle-vdj-t-annotation-explanation');
            const vdjTExplanation = document.getElementById('vdj-t-annotation-explanation');
            
            if (vdjTButton && vdjTExplanation) {
                vdjTButton.addEventListener('click', function() {
                    if (vdjTExplanation.style.display === 'none' || vdjTExplanation.style.display === '') {
                        vdjTExplanation.style.display = 'block';
                    } else {
                        vdjTExplanation.style.display = 'none';
                    }
                });
            }
            
            // VDJ-B annotation button
            const vdjBButton = document.getElementById('toggle-vdj-b-annotation-explanation');
            const vdjBExplanation = document.getElementById('vdj-b-annotation-explanation');
            
            if (vdjBButton && vdjBExplanation) {
                vdjBButton.addEventListener('click', function() {
                    if (vdjBExplanation.style.display === 'none' || vdjBExplanation.style.display === '') {
                        vdjBExplanation.style.display = 'block';
                    } else {
                        vdjBExplanation.style.display = 'none';
                    }
                });
            }
        }

        // Function to dynamically generate table headers based on cluster data
        function generateMarkerTableHeaders(data) {
            if (!data || data.length === 0) return;
            
            // Extract cluster numbers from the first data row
            const firstRow = data[0];
            const clusterKeys = Object.keys(firstRow).filter(key => key.includes('_pval')).map(key => key.replace('_pval', ''));
            const clusterNumbers = clusterKeys.map(key => parseInt(key.replace('cluster', ''))).sort((a, b) => a - b);
            
            const thead = document.querySelector('#marker-table thead');
            if (!thead) return;
            
            // Clear existing headers
            thead.innerHTML = '';
            
            // Create main header row
            const mainHeaderRow = document.createElement('tr');
            mainHeaderRow.style.cssText = 'background: #f8f9fa; border-bottom: 1px solid #dee2e6;';
            
            // Feature column header
            const featureHeader = document.createElement('th');
            featureHeader.setAttribute('colspan', '2');
            featureHeader.style.cssText = 'padding: 8px 6px; text-align: center; font-weight: 600; color: #2c3e50; border-right: 1px solid #dee2e6;';
            featureHeader.textContent = 'Feature';
            mainHeaderRow.appendChild(featureHeader);
            
            // Cluster headers
            clusterNumbers.forEach((clusterNum, index) => {
                const clusterHeader = document.createElement('th');
                clusterHeader.setAttribute('colspan', '2');
                clusterHeader.style.cssText = `padding: 8px 6px; text-align: center; font-weight: 600; color: #2c3e50; ${index < clusterNumbers.length - 1 ? 'border-right: 1px solid #dee2e6;' : ''}`;
                clusterHeader.textContent = `Cluster ${clusterNum}`;
                mainHeaderRow.appendChild(clusterHeader);
            });
            
            thead.appendChild(mainHeaderRow);
            
            // Create sub header row
            const subHeaderRow = document.createElement('tr');
            subHeaderRow.style.cssText = 'background: #f8f9fa; border-bottom: 2px solid #dee2e6; font-size: 11px;';
            
            // ID and Name headers
            const idHeader = document.createElement('th');
            idHeader.className = 'sortable';
            idHeader.setAttribute('data-column', 'id');
            idHeader.style.cssText = 'padding: 4px 3px; text-align: center; color: #495057; border-right: 1px solid #dee2e6; cursor: pointer; user-select: none; font-weight: 600;';
            idHeader.textContent = 'ID';
            subHeaderRow.appendChild(idHeader);
            
            const nameHeader = document.createElement('th');
            nameHeader.className = 'sortable';
            nameHeader.setAttribute('data-column', 'name');
            nameHeader.style.cssText = 'padding: 4px 3px; text-align: center; color: #495057; border-right: 1px solid #dee2e6; cursor: pointer; user-select: none; font-weight: 600;';
            nameHeader.textContent = 'Name';
            subHeaderRow.appendChild(nameHeader);
            
            // Cluster sub headers (p-value and L2FC)
            clusterNumbers.forEach((clusterNum, index) => {
                const pvalHeader = document.createElement('th');
                pvalHeader.className = 'sortable';
                pvalHeader.setAttribute('data-column', `cluster${clusterNum}_pval`);
                pvalHeader.style.cssText = 'padding: 4px 3px; text-align: center; color: #6c757d; border-right: 1px solid #dee2e6; cursor: pointer; user-select: none;';
                pvalHeader.textContent = 'p-value';
                subHeaderRow.appendChild(pvalHeader);
                
                const l2fcHeader = document.createElement('th');
                l2fcHeader.className = 'sortable';
                l2fcHeader.setAttribute('data-column', `cluster${clusterNum}_lg2fc`);
                l2fcHeader.style.cssText = `padding: 4px 3px; text-align: center; color: #6c757d; ${index < clusterNumbers.length - 1 ? 'border-right: 1px solid #dee2e6;' : ''} cursor: pointer; user-select: none;`;
                l2fcHeader.textContent = 'L2FC';
                subHeaderRow.appendChild(l2fcHeader);
            });
            
            thead.appendChild(subHeaderRow);
        }

        // Marker Table Functionality
        // Utility: compact scientific notation formatter (e.g., '4.00000000000e-23' -> '4e-23')
        function formatSciString(value) {
            const s = String(value).trim();
            if (s === '' || s.toLowerCase() === 'nan') return s;
            const num = Number(s);
            if (!Number.isFinite(num)) return s;
            // Round mantissa to a single significant digit
            const expStr = num.toExponential(0); // one digit mantissa
            const m = expStr.match(/^([+-]?\d+(?:\.\d+)?)e([+-]?\d+)$/i);
            if (m) {
                const coef = m[1].replace(/\.?0+$/, '');
                const exp = String(parseInt(m[2], 10));
                return `${coef}e${exp}`;
            }
            return expStr.replace('E', 'e');
        }

        function initializeMarkerTable() {
            let currentPage = 1;
            let rowsPerPage = 10;
            let totalPages = 5;
            let markerData = [];
            let sortColumn = null;
            let sortDirection = 'desc';
            let filteredData = [];

            // Get table elements
            const markerTable = document.getElementById('marker-table');
            const markerTableStart = document.getElementById('marker-table-start');
            const markerTableEnd = document.getElementById('marker-table-end');
            const markerTableTotal = document.getElementById('marker-table-total');
            const markerPrevBtn = document.getElementById('marker-prev-btn');
            const markerNextBtn = document.getElementById('marker-next-btn');
            const rowsPerPageSelect = document.getElementById('marker-rows-selector');
            const searchBox = document.getElementById('marker-search');

            // Initialize marker data from template or use fallback data
            try {
                const templateMarkerData = JSON.parse('${rna_marker_data}');
                if (templateMarkerData && templateMarkerData.length > 0) {
                    markerData = templateMarkerData;
                } else {
                    throw new Error('No template data available');
                }
            } catch (e) {
                console.log('Using fallback marker data');
                // Fallback sample data: 5 rows, name = 'NNN', pval = '1e0', lg2fc = '0.00'
                markerData = [
                    {id: 'ENSG00000NNN1', name: 'NNN1', cluster0_pval: '1e0', cluster0_lg2fc: '0.00', cluster1_pval: '1e0', cluster1_lg2fc: '0.00', cluster2_pval: '1e0', cluster2_lg2fc: '0.00', cluster3_pval: '1e0', cluster3_lg2fc: '0.00', cluster4_pval: '1e0', cluster4_lg2fc: '0.00', cluster5_pval: '1e0', cluster5_lg2fc: '0.00', cluster6_pval: '1e0', cluster6_lg2fc: '0.00', cluster7_pval: '1e0', cluster7_lg2fc: '0.00', cluster8_pval: '1e0', cluster8_lg2fc: '0.00', cluster9_pval: '1e0', cluster9_lg2fc: '0.00', cluster10_pval: '1e0', cluster10_lg2fc: '0.00', cluster11_pval: '1e0', cluster11_lg2fc: '0.00', cluster12_pval: '1e0', cluster12_lg2fc: '0.00', cluster13_pval: '1e0', cluster13_lg2fc: '0.00', cluster14_pval: '1e0', cluster14_lg2fc: '0.00', cluster15_pval: '1e0', cluster15_lg2fc: '0.00'},
                    {id: 'ENSG00000NNN2', name: 'NNN2', cluster0_pval: '1e0', cluster0_lg2fc: '0.00', cluster1_pval: '1e0', cluster1_lg2fc: '0.00', cluster2_pval: '1e0', cluster2_lg2fc: '0.00', cluster3_pval: '1e0', cluster3_lg2fc: '0.00', cluster4_pval: '1e0', cluster4_lg2fc: '0.00', cluster5_pval: '1e0', cluster5_lg2fc: '0.00', cluster6_pval: '1e0', cluster6_lg2fc: '0.00', cluster7_pval: '1e0', cluster7_lg2fc: '0.00', cluster8_pval: '1e0', cluster8_lg2fc: '0.00', cluster9_pval: '1e0', cluster9_lg2fc: '0.00', cluster10_pval: '1e0', cluster10_lg2fc: '0.00', cluster11_pval: '1e0', cluster11_lg2fc: '0.00', cluster12_pval: '1e0', cluster12_lg2fc: '0.00', cluster13_pval: '1e0', cluster13_lg2fc: '0.00', cluster14_pval: '1e0', cluster14_lg2fc: '0.00', cluster15_pval: '1e0', cluster15_lg2fc: '0.00'},
                    {id: 'ENSG00000NNN3', name: 'NNN3', cluster0_pval: '1e0', cluster0_lg2fc: '0.00', cluster1_pval: '1e0', cluster1_lg2fc: '0.00', cluster2_pval: '1e0', cluster2_lg2fc: '0.00', cluster3_pval: '1e0', cluster3_lg2fc: '0.00', cluster4_pval: '1e0', cluster4_lg2fc: '0.00', cluster5_pval: '1e0', cluster5_lg2fc: '0.00', cluster6_pval: '1e0', cluster6_lg2fc: '0.00', cluster7_pval: '1e0', cluster7_lg2fc: '0.00', cluster8_pval: '1e0', cluster8_lg2fc: '0.00', cluster9_pval: '1e0', cluster9_lg2fc: '0.00', cluster10_pval: '1e0', cluster10_lg2fc: '0.00', cluster11_pval: '1e0', cluster11_lg2fc: '0.00', cluster12_pval: '1e0', cluster12_lg2fc: '0.00', cluster13_pval: '1e0', cluster13_lg2fc: '0.00', cluster14_pval: '1e0', cluster14_lg2fc: '0.00', cluster15_pval: '1e0', cluster15_lg2fc: '0.00'},
                    {id: 'ENSG00000NNN4', name: 'NNN4', cluster0_pval: '1e0', cluster0_lg2fc: '0.00', cluster1_pval: '1e0', cluster1_lg2fc: '0.00', cluster2_pval: '1e0', cluster2_lg2fc: '0.00', cluster3_pval: '1e0', cluster3_lg2fc: '0.00', cluster4_pval: '1e0', cluster4_lg2fc: '0.00', cluster5_pval: '1e0', cluster5_lg2fc: '0.00', cluster6_pval: '1e0', cluster6_lg2fc: '0.00', cluster7_pval: '1e0', cluster7_lg2fc: '0.00', cluster8_pval: '1e0', cluster8_lg2fc: '0.00', cluster9_pval: '1e0', cluster9_lg2fc: '0.00', cluster10_pval: '1e0', cluster10_lg2fc: '0.00', cluster11_pval: '1e0', cluster11_lg2fc: '0.00', cluster12_pval: '1e0', cluster12_lg2fc: '0.00', cluster13_pval: '1e0', cluster13_lg2fc: '0.00', cluster14_pval: '1e0', cluster14_lg2fc: '0.00', cluster15_pval: '1e0', cluster15_lg2fc: '0.00'},
                    {id: 'ENSG00000NNN5', name: 'NNN5', cluster0_pval: '1e0', cluster0_lg2fc: '0.00', cluster1_pval: '1e0', cluster1_lg2fc: '0.00', cluster2_pval: '1e0', cluster2_lg2fc: '0.00', cluster3_pval: '1e0', cluster3_lg2fc: '0.00', cluster4_pval: '1e0', cluster4_lg2fc: '0.00', cluster5_pval: '1e0', cluster5_lg2fc: '0.00', cluster6_pval: '1e0', cluster6_lg2fc: '0.00', cluster7_pval: '1e0', cluster7_lg2fc: '0.00', cluster8_pval: '1e0', cluster8_lg2fc: '0.00', cluster9_pval: '1e0', cluster9_lg2fc: '0.00', cluster10_pval: '1e0', cluster10_lg2fc: '0.00', cluster11_pval: '1e0', cluster11_lg2fc: '0.00', cluster12_pval: '1e0', cluster12_lg2fc: '0.00', cluster13_pval: '1e0', cluster13_lg2fc: '0.00', cluster14_pval: '1e0', cluster14_lg2fc: '0.00', cluster15_pval: '1e0', cluster15_lg2fc: '0.00'}
                ];
            }
            filteredData = [...markerData];
            
            // Generate dynamic table headers based on data
            generateMarkerTableHeaders(markerData);

            // Rows per page change handler
            if (rowsPerPageSelect) {
                rowsPerPageSelect.addEventListener('change', function() {
                    rowsPerPage = parseInt(this.value);
                    currentPage = 1;
                    totalPages = Math.ceil(filteredData.length / rowsPerPage);
                    updateMarkerTable();
                    updateMarkerPaginationInfo();
                });
            }

            // Search functionality
            if (searchBox) {
                searchBox.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase();
                    filteredData = markerData.filter(row => 
                        row.id.toLowerCase().includes(searchTerm) || 
                        row.name.toLowerCase().includes(searchTerm)
                    );
                    currentPage = 1;
                    totalPages = Math.ceil(filteredData.length / rowsPerPage);
                    updateMarkerTable();
                    updateMarkerPaginationInfo();
                });
            }

            // Sorting functionality
            function addSortingListeners() {
                const sortableHeaders = document.querySelectorAll('.sortable');
                sortableHeaders.forEach(header => {
                    header.addEventListener('click', function() {
                        const column = this.dataset.column;
                        
                        // Toggle sort direction if same column, otherwise set to descending
                        if (sortColumn === column) {
                            sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                        } else {
                            sortColumn = column;
                            sortDirection = 'desc';
                        }

                        // Update sort indicators - skip since we removed them
                        // sortableHeaders.forEach(h => {
                        //     const indicator = h.querySelector('.sort-indicator');
                        //     if (h.dataset.column === column) {
                        //         indicator.textContent = sortDirection === 'asc' ? ' ' : ' ';
                        //     } else {
                        //         indicator.textContent = ' ';
                        //     }
                        // });

                        // Sort the data
                        filteredData.sort((a, b) => {
                            let aVal = a[column];
                            let bVal = b[column];

                            // Handle numeric values (p-values and L2FC)
                            if (column.includes('pval') || column.includes('lg2fc')) {
                                // Handle special cases for p-values
                                if (column.includes('pval')) {
                                    // Convert string values to numbers, handle scientific notation
                                    if (aVal === '-' || aVal === '' || aVal === null || aVal === undefined) {
                                        aVal = Infinity;
                                    } else {
                                        aVal = parseFloat(aVal);
                                        if (isNaN(aVal)) aVal = Infinity;
                                    }
                                    
                                    if (bVal === '-' || bVal === '' || bVal === null || bVal === undefined) {
                                        bVal = Infinity;
                                    } else {
                                        bVal = parseFloat(bVal);
                                        if (isNaN(bVal)) bVal = Infinity;
                                    }
                                } else {
                                    // Handle LG2FC values
                                    aVal = parseFloat(aVal);
                                    bVal = parseFloat(bVal);
                                    
                                    // Handle NaN values for L2FC
                                    if (isNaN(aVal)) aVal = 0;
                                    if (isNaN(bVal)) bVal = 0;
                                }
                            }

                            if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
                            if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
                            return 0;
                        });

                        currentPage = 1;
                        updateMarkerTable();
                        updateMarkerPaginationInfo();
                    });
                });
            }

            // Apply color coding to existing table data
            function applyColorCoding() {
                const l2fcCells = document.querySelectorAll('.l2fc-value');
                const pvalCells = document.querySelectorAll('.pval-value');

                l2fcCells.forEach(cell => {
                    const l2fc = parseFloat(cell.dataset.l2fc);
                    const pval = parseFloat(cell.dataset.pval);
                    
                    if (l2fc < 0 || pval >= 0.10) {
                        cell.classList.add('not-significant');
                        cell.classList.remove('significant');
                    } else {
                        cell.classList.add('significant');
                        cell.classList.remove('not-significant');
                    }
                });

                pvalCells.forEach(cell => {
                    const pval = parseFloat(cell.dataset.pval);
                    const l2fcCell = cell.parentElement.querySelector('.l2fc-value');
                    const l2fc = l2fcCell ? parseFloat(l2fcCell.dataset.l2fc) : 0;
                    
                    if (l2fc < 0 || pval >= 0.10) {
                        cell.classList.add('not-significant');
                        cell.classList.remove('significant');
                    } else {
                        cell.classList.add('significant');
                        cell.classList.remove('not-significant');
                    }
                });
            }

            // Pagination event listeners
            if (markerPrevBtn) {
                markerPrevBtn.addEventListener('click', function() {
                    if (currentPage > 1) {
                        currentPage--;
                        updateMarkerTable();
                        updateMarkerPaginationInfo();
                    }
                });
            }

            if (markerNextBtn) {
                markerNextBtn.addEventListener('click', function() {
                    if (currentPage < totalPages) {
                        currentPage++;
                        updateMarkerTable();
                        updateMarkerPaginationInfo();
                    }
                });
            }

            // Function to update marker table display
            function updateMarkerTable() {
                const tbody = document.querySelector('#marker-table tbody');
                if (!tbody) return;

                // Clear existing rows
                tbody.innerHTML = '';

                // Calculate pagination
                const startIndex = (currentPage - 1) * rowsPerPage;
                const endIndex = Math.min(startIndex + rowsPerPage, filteredData.length);
                const pageData = filteredData.slice(startIndex, endIndex);



                // Generate table rows
                pageData.forEach(row => {
                    const tr = document.createElement('tr');
                    tr.style.borderBottom = '1px solid #dee2e6';
                    
                    // ID column
                    const idCell = document.createElement('td');
                    idCell.style.cssText = 'padding: 6px; text-align: left; font-family: monospace; font-size: 10px; border-right: 1px solid #dee2e6;';
                    idCell.textContent = row.id;
                    tr.appendChild(idCell);
                    
                    // Name column
                    const nameCell = document.createElement('td');
                    nameCell.style.cssText = 'padding: 6px; text-align: left; font-weight: 500; border-right: 1px solid #dee2e6;';
                    nameCell.textContent = row.name;
                    tr.appendChild(nameCell);
                    
                    // Cluster columns (dynamically generate based on data)
                    const clusterKeys = Object.keys(row).filter(key => key.includes('_pval')).map(key => key.replace('_pval', ''));
                    const clusterNumbers = clusterKeys.map(key => parseInt(key.replace('cluster', ''))).sort((a, b) => a - b);
                    
                    clusterNumbers.forEach((clusterNum, index) => {
                        const clusterKey = `cluster${clusterNum}`;
                        
                        // P-value column
                        const pvalCell = document.createElement('td');
                        pvalCell.style.cssText = 'padding: 6px; text-align: center; border-right: 1px solid #dee2e6;';
                        const pval = row[`${clusterKey}_pval`] || '-';
                        const l2fc = parseFloat(row[`${clusterKey}_lg2fc`] || '0');
                        const pvalNum = parseFloat(pval);
                        
                        if (l2fc < 0 || pvalNum >= 0.10) {
                            pvalCell.style.color = '#b0b0b0';
                        } else {
                            pvalCell.style.color = 'black';
                        }
                        // Display p-value in compact scientific notation when possible
                        pvalCell.textContent = formatSciString(pval);
                        tr.appendChild(pvalCell);
                        
                        // L2FC column
                        const l2fcCell = document.createElement('td');
                        l2fcCell.style.cssText = 'padding: 6px; text-align: center;';
                        if (index < clusterNumbers.length - 1) l2fcCell.style.borderRight = '1px solid #dee2e6';
                        
                        const l2fcVal = row[`${clusterKey}_lg2fc`] || '-';
                        if (l2fc < 0 || pvalNum >= 0.10) {
                            l2fcCell.style.color = '#b0b0b0';
                        } else {
                            l2fcCell.style.color = 'black';
                        }
                        l2fcCell.textContent = l2fcVal;
                        tr.appendChild(l2fcCell);
                    });
                    
                    tbody.appendChild(tr);
                });
            }

            function updateMarkerPaginationInfo() {
                const startIndex = (currentPage - 1) * rowsPerPage + 1;
                const endIndex = Math.min(currentPage * rowsPerPage, filteredData.length);

                if (markerTableStart) markerTableStart.textContent = startIndex;
                if (markerTableEnd) markerTableEnd.textContent = endIndex;
                if (markerTableTotal) markerTableTotal.textContent = filteredData.length;

                if (markerPrevBtn) {
                    markerPrevBtn.disabled = currentPage === 1;
                }

                if (markerNextBtn) {
                    markerNextBtn.disabled = currentPage === totalPages;
                }

                // Update total pages
                totalPages = Math.ceil(filteredData.length / rowsPerPage);
            }

            // Data Loader Functions
            function loadData() {
                const dataInput = document.getElementById('dataInput');
                const statusDiv = document.getElementById('dataStatus');
                
                try {
                    const inputData = JSON.parse(dataInput.value.trim());
                    
                    if (!Array.isArray(inputData)) {
                        throw new Error('Data must be an array');
                    }
                    
                    // Validate data structure
                    if (inputData.length > 0) {
                        const firstItem = inputData[0];
                        if (!firstItem.id || !firstItem.name) {
                            throw new Error('Each item must have "id" and "name" properties');
                        }
                    }
                    
                    // Update global markerData
                    markerData = inputData;
                    
                    // Reset pagination
                    currentMarkerPage = 1;
                    
                    // Update table and pagination
                    updateMarkerTable();
                    updateMarkerPaginationInfo();
                    
                    // Show success message
                    statusDiv.style.display = 'block';
                    statusDiv.style.background = '#d4edda';
                    statusDiv.style.color = '#155724';
                    statusDiv.style.border = '1px solid #c3e6cb';
                    statusDiv.textContent = `Successfully loaded ${inputData.length} records`;
                    
                    // Hide success message after 3 seconds
                    setTimeout(() => {
                        statusDiv.style.display = 'none';
                    }, 3000);
                    
                } catch (error) {
                    // Show error message
                    statusDiv.style.display = 'block';
                    statusDiv.style.background = '#f8d7da';
                    statusDiv.style.color = '#721c24';
                    statusDiv.style.border = '1px solid #f5c6cb';
                    statusDiv.textContent = `Error: ${error.message}`;
                }
            }
            
            
            
            function clearData() {
                document.getElementById('dataInput').value = '';
                const statusDiv = document.getElementById('dataStatus');
                statusDiv.style.display = 'none';
            }
            

            
            // Add event listeners for data loader buttons (commented out as buttons don't exist)
            // document.getElementById('loadDataBtn').addEventListener('click', loadData);
            // document.getElementById('clearDataBtn').addEventListener('click', clearData);

            // Add event listener for marker explanation toggle
            const toggleExplanationBtn = document.getElementById('toggle-marker-explanation');
            if (toggleExplanationBtn) {
                toggleExplanationBtn.addEventListener('click', function() {
                    const explanation = document.getElementById('marker-explanation');
                    if (explanation) {
                        if (explanation.style.display === 'none' || explanation.style.display === '') {
                            explanation.style.display = 'block';
                        } else {
                            explanation.style.display = 'none';
                        }
                    }
                });
            }

            // Add event listener for annotation explanation toggle
            const toggleAnnotationExplanationBtn = document.getElementById('toggle-annotation-explanation');
            if (toggleAnnotationExplanationBtn) {
                toggleAnnotationExplanationBtn.addEventListener('click', function() {
                    const explanation = document.getElementById('annotation-explanation');
                    if (explanation) {
                        if (explanation.style.display === 'none' || explanation.style.display === '') {
                            explanation.style.display = 'block';
                        } else {
                            explanation.style.display = 'none';
                        }
                    }
                });
            }

            // Add event listener for sequencing metrics explanation toggle
            const toggleSequencingExplanationBtn = document.getElementById('toggle-sequencing-explanation');
            if (toggleSequencingExplanationBtn) {
                toggleSequencingExplanationBtn.addEventListener('click', function() {
                    const explanation = document.getElementById('sequencing-explanation');
                    if (explanation) {
                        if (explanation.style.display === 'none' || explanation.style.display === '') {
                            explanation.style.display = 'block';
                        } else {
                            explanation.style.display = 'none';
                        }
                    }
                });
            }

            // Add event listener for mapping metrics explanation toggle
            const toggleMappingExplanationBtn = document.getElementById('toggle-mapping-explanation');
            if (toggleMappingExplanationBtn) {
                toggleMappingExplanationBtn.addEventListener('click', function() {
                    const explanation = document.getElementById('mapping-explanation');
                    if (explanation) {
                        if (explanation.style.display === 'none' || explanation.style.display === '') {
                            explanation.style.display = 'block';
                        } else {
                            explanation.style.display = 'none';
                        }
                    }
                });
            }

            // Add event listener for VDJ-T sequencing metrics explanation toggle
            const toggleVdjTSequencingExplanationBtn = document.getElementById('toggle-vdj-t-sequencing-explanation');
            if (toggleVdjTSequencingExplanationBtn) {
                toggleVdjTSequencingExplanationBtn.addEventListener('click', function() {
                    const explanation = document.getElementById('vdj-t-sequencing-explanation');
                    if (explanation) {
                        if (explanation.style.display === 'none' || explanation.style.display === '') {
                            explanation.style.display = 'block';
                        } else {
                            explanation.style.display = 'none';
                        }
                    }
                });
            }

            // Add event listener for VDJ-B sequencing metrics explanation toggle
            const toggleVdjBSequencingExplanationBtn = document.getElementById('toggle-vdj-b-sequencing-explanation');
            if (toggleVdjBSequencingExplanationBtn) {
                toggleVdjBSequencingExplanationBtn.addEventListener('click', function() {
                    const explanation = document.getElementById('vdj-b-sequencing-explanation');
                    if (explanation) {
                        if (explanation.style.display === 'none' || explanation.style.display === '') {
                            explanation.style.display = 'block';
                        } else {
                            explanation.style.display = 'none';
                        }
                    }
                });
            }

            // Initialize all functionality
            addSortingListeners();
            updateMarkerTable();
            updateMarkerPaginationInfo();
            initializeClonotypeTable();

            // Clonotype Table Functionality
            function initializeClonotypeTable() {
                // Check which VDJ library type is currently active
                const activeLibrary = document.querySelector('.library-tab-btn.active')?.dataset.library || 'vdj-t';
                
                // Always load both VDJ-T and VDJ-B data initially
                loadVdjTClonotypeData();
                loadVdjBClonotypeData();
            }

            function loadVdjTClonotypeData() {
                const templateData = '${vdj_t_clonotype_data}';
                let parsedData = null;

                // Try template variable first if it looks like JSON
                if (templateData && templateData.trim().startsWith('[')) {
                    try {
                        parsedData = JSON.parse(templateData);
                    } catch (e) {
                        console.warn('Failed to parse VDJ-T clonotype data from template:', e);
                    }
                }

                // Fallback: extract embedded JSON from the chart script block
                if (!parsedData) {
                    const scriptEl = document.getElementById('script-vdj-t-clonotype-chart');
                    if (scriptEl) {
                        const m = scriptEl.textContent.match(/const\s+vdjTClonoJSON\s*=\s*'([^']*)'/);
                        if (m && m[1] && m[1].trim().startsWith('[')) {
                            try {
                                parsedData = JSON.parse(m[1]);
                            } catch (e) {
                                console.warn('Failed to parse VDJ-T clonotype data from chart script:', e);
                            }
                        }
                    }
                }

                // Populate table if we have data, otherwise show empty state
                if (parsedData && parsedData.length > 0) {
                    const formattedData = parsedData.map(item => {
                        const proportionValue = (typeof item.proportion === 'string' && item.proportion.includes('%'))
                            ? item.proportion
                            : (Number(item.proportion) * 100).toFixed(2) + '%';
                        return {
                            id: item.id,
                            cdr3s: item.cdr3s,
                            frequency: item.frequency,
                            proportion: proportionValue
                        };
                    });
                    loadClonotypeData(formattedData, 'vdj-t');
                    return;
                }

                loadClonotypeData([], 'vdj-t');
            }

            function loadVdjBClonotypeData() {
                const templateData = '${vdj_b_clonotype_data}';
                let parsedData = null;

                // Try template variable first if it looks like JSON
                if (templateData && templateData.trim().startsWith('[')) {
                    try {
                        parsedData = JSON.parse(templateData);
                    } catch (e) {
                        console.warn('Failed to parse VDJ-B clonotype data from template:', e);
                    }
                }

                // Fallback: extract embedded JSON from the chart script block
                if (!parsedData) {
                    const scriptEl = document.getElementById('script-vdj-b-clonotype-chart');
                    if (scriptEl) {
                        const m = scriptEl.textContent.match(/const\s+vdjBClonoJSON\s*=\s*'([^']*)'/);
                        if (m && m[1] && m[1].trim().startsWith('[')) {
                            try {
                                parsedData = JSON.parse(m[1]);
                            } catch (e) {
                                console.warn('Failed to parse VDJ-B clonotype data from chart script:', e);
                            }
                        }
                    }
                }

                // Populate table if we have data, otherwise show empty state
                if (parsedData && parsedData.length > 0) {
                    const formattedData = parsedData.map(item => {
                        const proportionValue = (typeof item.proportion === 'string' && item.proportion.includes('%'))
                            ? item.proportion
                            : (Number(item.proportion) * 100).toFixed(2) + '%';
                        return {
                            id: item.id,
                            cdr3s: item.cdr3s,
                            frequency: item.frequency,
                            proportion: proportionValue
                        };
                    });
                    loadClonotypeData(formattedData, 'vdj-b');
                    return;
                }

                loadClonotypeData([], 'vdj-b');
            }

            function loadClonotypeData(data, libraryType) {
                const tableBody = document.getElementById('clonotype-table-body');
                const vdjBTableBody = document.getElementById('vdj-b-clonotype-table-body');
                
                // Determine which table to populate based on library type parameter
                const targetTableBody = libraryType === 'vdj-b' ? vdjBTableBody : tableBody;
                
                if (!targetTableBody) return;

                // Clear existing data
                targetTableBody.innerHTML = '';

                // Populate table with data
                if (!data || data.length === 0) {
                    targetTableBody.innerHTML = `<tr><td colspan="4" style="padding: 6px 8px; text-align: center; color: #6c757d;">No clonotype data</td></tr>`;
                    return;
                }

                data.forEach((item) => {
                    const row = document.createElement('tr');
                    row.style.background = 'white';

                    const cdr3Formatted = String(item.cdr3s || '')
                        .split(';')
                        .map(s => s.trim())
                        .filter(Boolean)
                        .join('<br/>');

                    row.innerHTML = `
                        <td style="padding: 6px 8px; color: #495057; border-bottom: 1px solid #dee2e6; font-weight: 600; text-align: center;">${item.id}</td>
                        <td style="padding: 6px 8px; color: #495057; border-bottom: 1px solid #dee2e6; font-family: monospace; font-size: 0.85rem; text-align: left; white-space: normal; overflow-wrap: anywhere; word-break: break-word;">${cdr3Formatted}</td>
                        <td style="padding: 6px 8px; color: #495057; border-bottom: 1px solid #dee2e6; font-weight: 600; text-align: center;">${item.frequency}</td>
                        <td style="padding: 6px 8px; color: #495057; border-bottom: 1px solid #dee2e6; font-weight: 600; text-align: center;">${item.proportion}</td>
                    `;

                    targetTableBody.appendChild(row);
                });
            }
            

        }
    </script>
    <div class="report-footer">
      <p style="margin: 0; opacity: 0.9;">Generated by <a href="https://github.com/MGI-tech-bioinformatics/zUMIs_MGI" target="_blank" style="color: #3b82f6; text-decoration: none; cursor: pointer;" onmouseover="this.style.color='#1d4ed8'" onmouseout="this.style.color='#3b82f6'">zUMIs_MGI</a></p>
      <p style="margin: 0.5rem 0 0 0; font-size: 0.75rem; opacity: 0.7;"> 2026 MGI Tech Co., Ltd. All rights reserved.</p>
    </div>
<script>
document.addEventListener("DOMContentLoaded", function() {
    const plotPlaceholders = document.querySelectorAll('.plot-placeholder');

    const plotObserver = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const placeholder = entry.target;
                const plotId = placeholder.dataset.plotId;

                // Find the script that generates the plot and execute it
                const scriptId = `script-${plotId}`;
                const plotScript = document.getElementById(scriptId);
                if (plotScript) {
                    try {
                        eval(plotScript.innerHTML);
                    } catch (e) {
                        console.error(`Error rendering plot ${plotId}:`, e);
                    }
                }

                // Stop observing the placeholder
                observer.unobserve(placeholder);
            }
        });
    }, { rootMargin: "200px" });

    plotPlaceholders.forEach(placeholder => {
        plotObserver.observe(placeholder);
    });
});
</script>
<script>

</script>
