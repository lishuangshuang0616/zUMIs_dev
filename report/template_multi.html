<!DOCTYPE html>

<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>${samplename} Summary Report</title>
<link rel="icon" href="data:image/png;base64,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" type="image/vnd.microsoft.icon">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet"/>

${plotly_loader_tag}
<style>
        html {
            overflow-y: scroll;
        }
        :root {
            --primary-color: #27AE60; /* Emerald Green */
            --primary-dark: #1E8449; /* Forest Green */
            --secondary-color: #F0FDF4; /* Very Light Mint */
            --accent-color: #2ECC71; /* Vibrant Green */
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --gradient-bg: linear-gradient(135deg, #1E8449 0%, #27AE60 100%);
            --section-gradient: linear-gradient(135deg, #27AE60 0%, #d5e1db 100%);
            --content-max-width: 1000px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        .library-tab-btn { display: inline-flex; }
        [data-library-content] { display: none; }
        [data-library-content="gene-expression"] { display: block; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'PingFang SC', 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.5;
            color: var(--text-primary);
            background: #f1f5f9; /* Light gray background */
            min-height: 100vh;
            font-size: 13px;
        }

        .container {
            max-width: 1080px;
            margin: 0 auto;
            padding: 0 20px;
        }

        header {
            background: var(--gradient-bg);
            color: white;
            padding: 2rem 0;
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
            opacity: 0.3;
        }

        .header-content {
            position: relative;
            z-index: 1;
        }

        h1 {
            font-size: 2rem; /* Slightly smaller h1 */
            font-weight: 700;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            font-weight: 300;
        }

        main {
            padding: 2rem 0;
        }

        .section-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            
            position: relative;
            min-width: 0;
        }
        .section-card.simple-card::before { display: none; }

        .section-card::before {
            display: none;
        }

        .section-card:hover {
            box-shadow: var(--shadow-lg);
        }
        [style*="border-bottom: 2px solid #3498db"] { border-bottom: none !important; }
        /* Default hide VDJ target sections to avoid initial flicker; JS toggles visibility */
        [data-section="vdj-t-target"], [data-section="vdj-b-target"] {
            display: none;
        }

        h2 {
            color: var(--primary-color);
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        h2::before {
            content: '';
            width: 6px;
            height: 2rem;
            background: var(--gradient-bg);
            border-radius: 3px;
        }

        h3 {
            color: var(--text-primary);
            font-size: 1.15rem;
            font-weight: 500;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--secondary-color);
        }

        .plotly-wrapper {
            display: grid;
            gap: 1.5rem;
            margin: 1.5rem 0;
        }

        .plotly-graph {
            background: var(--secondary-color);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            
        }

        .plotly-graph:hover {
            background: #f1f5f9;
        }

        .flex-container {
            display: flex;
            gap: 2rem;
            align-items: stretch;
            flex-wrap: wrap;
        }

        .flex-item {
            flex: 1;
            min-width: 300px;
            background: var(--secondary-color);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            margin: 1rem 0;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .left-half, .right-half {
            flex: 1;
            padding: 1rem;
        }

        .image {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
        }

        /* Marker Table Styles */
        .marker-table-info {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
            color: #64748b;
            line-height: 1.5;
        }

        .marker-table-container {
            overflow-x: auto;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            margin-bottom: 1rem;
            -webkit-overflow-scrolling: touch;
            width: 100%;
            max-width: 100%;
            position: relative;
        }

        .marker-table {
            width: auto;
            border-collapse: collapse;
            font-size: 0.85rem;
            min-width: 100%;
            table-layout: auto;
            white-space: nowrap;
            max-width: none;
        }

        .marker-table th {
            background: #f1f5f9;
            color: #334155;
            font-weight: 600;
            padding: 0.75rem 0.5rem;
            text-align: center;
            border: 1px solid #e2e8f0;
            font-size: 0.8rem;
            white-space: nowrap;
        }

        .marker-table th:first-child,
        .marker-table th:nth-child(2) {
            background: #e2e8f0;
            position: sticky;
            left: 0;
            z-index: 10;
            min-width: 120px;
        }

        .marker-table th:nth-child(2) {
            left: 120px;
        }

        .marker-table td {
            padding: 0.5rem;
            text-align: center;
            border: 1px solid #e2e8f0;
            font-size: 0.8rem;
            white-space: nowrap;
        }

        .marker-table td:first-child,
        .marker-table td:nth-child(2) {
            background: #f8fafc;
            position: sticky;
            left: 0;
            z-index: 5;
            font-weight: 500;
            text-align: left;
            padding-left: 0.75rem;
        }

        .marker-table td:nth-child(2) {
            left: 120px;
        }

        .marker-table .l2fc-value {
            font-weight: 600;
        }

        .marker-table .l2fc-value.significant {
            color: #000000;
            font-weight: bold;
        }

        .marker-table .l2fc-value.not-significant {
            color: #efefef;
        }

        .marker-table .pval-value {
            font-family: 'Courier New', monospace;
        }

        .marker-table .pval-value.significant {
            color: #000000;
            font-weight: bold;
        }

        .marker-table .pval-value.not-significant {
            color: #efefef;
        }

        .marker-table .grayed {
            color: #efefef !important;
            font-weight: normal !important;
        }

        .marker-table tbody tr:hover {
            background: #f8fafc;
        }

        .table-pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: #f8fafc;
            border-top: 1px solid #e2e8f0;
            border-radius: 0 0 8px 8px;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .pagination-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s ease;
        }

        .pagination-btn:hover {
            background: var(--primary-hover);
        }

        .pagination-btn:disabled {
            background: #94a3b8;
            cursor: not-allowed;
            transform: none;
        }

        .pagination-info {
            color: #64748b;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .rows-select {
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 0.5rem;
            font-size: 0.85rem;
            background: white;
            cursor: pointer;
        }

        .rows-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* Force button styles to override any conflicting rules */
        button[id*="toggle"] {
            /* Force unified green theme for help circles */
            background: var(--gradient-bg) !important;
            color: white;
            border: none !important;
            width: 24px !important; /* smaller circle */
            height: 24px !important; /* smaller circle */
            font-size: 12px !important; /* smaller question mark */
            border-radius: 50% !important; /* ensure circle shape */
            box-shadow: 0 2px 8px rgba(13, 148, 136, 0.3) !important;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        button[id*="toggle"]:hover {
            background: var(--primary-dark) !important;
            box-shadow: 0 4px 12px rgba(13, 148, 136, 0.4) !important;
        }

        /* Responsive Design */
        
        @media (max-width: 768px) {
            .sidebar-navigation {
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                z-index: 1000;
                transition: transform 0.3s ease;
                overflow-y: auto;
                width: 260px;
            }
            
            .content-area {
                margin-left: 0;
                padding: 1.5rem;
                width: 100%;
            }
            
            .content-wrapper {
                max-width: var(--content-max-width);
                margin: 0 auto;
            }
        }
        
        /* Tablet and small desktop */
        @media (min-width: 769px) and (max-width: 1200px) {
            .sidebar-navigation {
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                z-index: 1000;
                transition: transform 0.3s ease;
                overflow-y: auto;
                width: 260px;
            }
            
            .content-area {
                margin-left: 0;
                padding: 1.5rem;
                width: 100%;
            }
            
            .content-wrapper {
                max-width: var(--content-max-width);
                margin: 0 auto;
            }
        }
        
        /* Mobile and tablet */
        @media (max-width: 768px) {
            .sidebar-navigation {
                transition: transform 0.3s ease;
                width: 250px;
            }
            
            .content-area {
                margin-left: 0;
                padding: 1rem;
            }
            
            .container {
                padding: 0 15px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .section-card {
                padding: 1.5rem;
                margin-bottom: 1.5rem;
            }
            
            .flex-container {
                flex-direction: column;
                gap: 1rem;
            }
            
            .flex-item {
                min-width: unset;
            }
            
            /* Pipeline Information responsive */
            .pipeline-info-grid {
                grid-template-columns: 1fr !important;
                gap: 1rem !important;
            }
            
            .summary-section {
                padding: 1rem;
                margin-bottom: 1rem;
            }
            
            /* Statistics table responsive */
        .stats-table-container {
            overflow-x: auto;
        }
        
        .stats-table-container table {
            width: 100%;
        }
        
        @media (max-width: 768px) {
            .stats-table-container table {
                font-size: 0.9em;
            }
            
            .stats-table-container td {
                padding: 10px 12px !important;
            }
        }
        
        @media (max-width: 480px) {
            .stats-table-container table {
                font-size: 0.8em;
            }
            
            .stats-table-container td {
                padding: 8px 10px !important;
            }
        }

        /* Tables responsive */
            .table-responsive {
                overflow-x: auto;
            }
            
            table {
                width: 100%;
            }
            
            /* Charts responsive */
            .chart-container {
                margin: 1rem 0;
            }
            
            .plotly-graph {
                width: 100% !important;
                height: auto !important;
            }
            
            /* Tab buttons responsive */
            .tab-list {
                padding: 0 1rem;
            }
            
            .tab-button {
                padding: 0.75rem 1rem;
                font-size: 0.9rem;
                font-weight: bold;
            }
        }
        

        
        /* Mobile overlay */
        .mobile-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
        
        @media (max-width: 768px) {
            .sidebar-navigation {
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                z-index: 1000;
                transition: transform 0.3s ease;
                overflow-y: auto;
                width: 250px;
            }
            
            .content-area {
                margin-left: 0;
                width: 100%;
            }
        }

        /* Small mobile devices */
        @media (max-width: 480px) {
            .content-area {
                padding: 0.5rem;
            }
            
            .summary-section {
                padding: 0.75rem;
                border-radius: 10px;
            }
            
            h1 {
                font-size: 1.5rem;
                margin-bottom: 1rem;
            }
            
            h2 {
                font-size: 1.4rem !important;
                margin-bottom: 1rem !important;
            }
            
            h3 {
                font-size: 1.1rem !important;
                margin-bottom: 0.75rem !important;
            }
            
            .section-card {
                padding: 1rem !important;
                margin-bottom: 1rem !important;
            }
            
            .plotly-wrapper {
                gap: 1rem !important;
                margin: 1rem 0 !important;
            }
            
            .plotly-graph {
                padding: 1rem !important;
                margin-bottom: 1rem !important;
            }
            
            .sidebar-header {
                padding: 0 1rem 1rem 1rem;
            }
            
            .sidebar-title {
                font-size: 1.2rem;
            }
            
            .sidebar-subtitle {
                font-size: 1.0rem;
                font-weight: bold;
            }
            
            /* Make text more compact */
            p {
                font-size: 0.9rem !important;
                line-height: 1.4 !important;
                margin-bottom: 0.75rem !important;
            }
            
            /* Compact table styling */
            .stats-table-container {
                margin: 0.75rem 0 !important;
            }
            
            /* Reduce chart heights for mobile */
            .chart-container {
                margin: 0.75rem 0 !important;
            }
            
            .chart-container, .plotly-graph-div {
                max-height: 250px !important;
            }
            
            /* Make summary cards more compact */
            .summary-card {
                padding: 0.75rem !important;
                margin-bottom: 0.75rem !important;
            }
            
            /* Optimize table display for very small screens */
            .stats-table-container table {
                font-size: 0.75rem !important;
            }
            
            .stats-table-container th,
            .stats-table-container td {
                padding: 6px 8px !important;
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--secondary-color);
        }

        ::-webkit-scrollbar-thumb {
            background: #ccced1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover,
        ::-webkit-scrollbar-thumb:active {
            background: var(--primary-color);
        }

        /* Navigation and Progress Indicator */
        .progress-nav {
            position: sticky;
            top: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 0;
            z-index: 100;
            margin-bottom: 2rem;
        }

        .nav-items {
            display: flex;
            gap: 2rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .nav-item {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            background: var(--secondary-color);
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            
            border: 1px solid var(--border-color);
        }

        .nav-item:hover, .nav-item.active {
            background: var(--primary-color);
            color: white;
            box-shadow: var(--shadow-sm);
        }

        /* New Summary Cards */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .summary-card {
            background-color: #fff;
            border-radius: 16px;
            padding: 2rem 1.5rem;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
            
            text-align: center;
            min-width: 0; /* Allow flex item to shrink below content size */
            overflow: hidden; /* prevent visual overflow */
        }
        .summary-card:hover {
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-color);
        }

        .summary-card-content .value {
            font-size: 3.0rem; /* slightly smaller to fit */
            font-weight: 600;
            color: var(--text-primary);
            line-height: 1.2;
            white-space: normal; /* allow wrapping */
            word-break: break-word; /* break long tokens */
            overflow-wrap: anywhere; /* ensure no overflow */
            max-width: 100%;
        }

        .summary-card-content .label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
            line-height: 1.4;
        }

        /* Enhanced Chart Containers */
        .chart-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
            padding-left: 1rem;
        }

        /* Loading States */
        .loading-placeholder {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 8px;
            height: 200px;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Tooltip Styles */
        .tooltip {
            position: relative;
            cursor: help;
        }

        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 45%;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            color: var(--text-primary);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            font-size: 0.85rem;
            white-space: normal;
            opacity: 0;
            visibility: hidden;
            
            z-index: 1000;
            width: 400px;
            max-width: 95vw;
            text-align: left;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-lg);
        }

        .tooltip:hover::after {
            opacity: 1;
            visibility: visible;
        }

        /* Main Layout Styles */
        .main-layout {
            min-height: 100vh;
            gap: 0;
        }



        .tab-list {
            list-style: none;
            padding: 0;
            margin: 0;
            flex-grow: 1;
        }



        /* Right Content Area */
        .content-area {
            flex: 1;
            margin-left: 0;
            padding: 0 1.5rem 1.5rem 1.5rem;
            background: #f8fafc;
            min-height: 100vh;
            position: relative;
        }

        .content-wrapper {
            max-width: var(--content-max-width);
            margin: 0 auto;
            min-width: 0;
            padding-top: 1rem;
        }

        /* Constrain cards width to avoid overly wide borders */
        .summary-section,
        .chart-container {
            max-width: var(--card-max-width);
            margin-left: auto;
            margin-right: auto;
        }

        .summary-section {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.05);
            border: var(--card-border-width) solid #e2e8f0;
        }

        .tab-content {
            min-height: 0px;
        }

        /* Inline Navigation and Header */
        .content-topbar {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            padding: 8px 0 16px 0;
        }
        .content-topbar .topbar-title {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
        }
        .content-topbar .topbar-subtitle {
            margin: 0;
            font-size: 0.9rem;
            color: #64748b;
        }
        .inline-nav .tab-list {
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            background: #ffffff;
            box-shadow: 0 2px 12px rgba(0,0,0,0.05);
            overflow: hidden;
        }
        .inline-nav .tab-button {
            border-left: none;
            border-bottom: 1px solid #e2e8f0;
            text-align: left;
        }
        .inline-nav .tab-item:last-child .tab-button {
            border-bottom: none;
        }
        .report-footer {
            background: transparent;
            border: none;
            box-shadow: none;
            border-radius: 0;
            padding: 12px 0;
            font-size: 0.8rem;
            color: #64748b;
            margin-top: 24px;
            max-width: var(--content-max-width);
            margin-left: auto;
            margin-right: auto;
            text-align: center;
        }
        @media (min-width: 769px) {
            .content-area { display: block; }
            .inline-nav { position: fixed; top: 120px; left: max(24px, calc((100vw - var(--content-max-width)) / 2 - 204px)); width: 180px; z-index: 100; }
        }

        /* Hide inline nav on mid-width screens to prevent overlap */
        @media (min-width: 769px) and (max-width: 1200px) {
            .inline-nav { display: none !important; }
        }
        @media (max-width: 768px) {
            .sidebar-navigation { display: block; }
            .inline-nav { display: none; }
            .content-topbar { display: block; }
            .report-footer { margin-top: 16px; }
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        /* Cluster Tab Styles */
        .cluster-plots-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-top: 1.5rem;
        }

        .cluster-plot-item {
            background: #f8fafc;
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .cluster-plot-item h3 {
            color: #2d3748;
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .plot-description {
            color: #718096;
            font-size: 0.9rem;
            line-height: 1.5;
            margin-bottom: 1rem;
        }

        .cluster-plot-placeholder {
            min-height: 400px;
            background: white;
            border-radius: 8px;
            border: 2px dashed #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .plot-loading {
            text-align: center;
            color: #718096;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e2e8f0;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive two-column grid class */
        .responsive-two-col-grid {
            display: grid;
            grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
            gap: 20px;
            margin-top: 15px;
        }
        /* Ensure grid children can shrink and not force overflow */
        .responsive-two-col-grid > * {
            min-width: 0;
        }


        @media (max-width: 768px) {
            .responsive-two-col-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
        }

        @media (max-width: 480px) {
            .responsive-two-col-grid {
                gap: 10px;
            }
        }




        /* Force responsive behavior for all screen sizes */
        @media screen and (max-width: 1200px) {
            .content-area {
                margin-left: 0;
            }
            [data-library-content="gene-expression"] .responsive-two-col-grid {
                grid-template-columns: 1fr !important;
                gap: 1rem !important;
            }
            
            .marker-table-container {
                overflow-x: auto !important;
                -webkit-overflow-scrolling: touch !important;
                width: 100% !important;
                max-width: 100% !important;
            }
            
            #marker-table {
                min-width: 100% !important;
                font-size: 0.8rem !important;
            }
        }

        @media (max-width: 768px) {
            .cluster-plots-container {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            /* Force responsive behavior for marker table */
            .marker-table-container {
                overflow-x: auto !important;
                -webkit-overflow-scrolling: touch !important;
            }
            
            #marker-table {
                min-width: 100% !important;
                font-size: 11px !important;
            }
            
            /* Additional mobile optimizations for 768px */
            .section-card {
                padding: 1.25rem !important;
                margin-bottom: 1.25rem !important;
            }
            
            h2 {
                font-size: 1.5rem !important;
                margin-bottom: 1.25rem !important;
            }
            
            h3 {
                font-size: 1.2rem !important;
                margin-bottom: 1rem !important;
            }
            
            .plotly-wrapper {
                gap: 1.25rem !important;
                margin: 1.25rem 0 !important;
            }
            
            .plotly-graph {
                padding: 1.25rem !important;
            }
            
            /* Make charts more mobile-friendly */
            .cluster-plot-placeholder {
                min-height: 300px !important;
            }
            
            /* Optimize chart containers for mobile */
            .chart-container, .plotly-graph-div {
                max-height: 350px !important;
            }
            
            /* Make summary cards more compact on tablets */
            .summary-card {
                padding: 1rem !important;
                margin-bottom: 1rem !important;
            }
            
            /* Reduce text size slightly for better fit */
            p {
                font-size: 0.95rem !important;
                line-height: 1.5 !important;
            }
            
            /* Clonotype section mobile optimization */
            .clonotype-chart-container {
                max-height: 350px !important;
                overflow: hidden !important;
            }
            
            .clonotype-table-container {
                overflow-x: hidden;
            }
            
            .clonotype-table {
                font-size: 0.75rem !important;
                table-layout: fixed;
                width: 100%;
            }

            .clonotype-table th, .clonotype-table td {
                white-space: normal;
                word-wrap: break-word;
            }
        }

        @media (max-width: 480px) {
            /* Marker table responsive styles */
            .marker-table-container {
                padding: 5px !important;
                overflow-x: auto !important;
                -webkit-overflow-scrolling: touch !important;
            }
            
            #marker-table {
                font-size: 9px !important;
                min-width: 100% !important;
            }
            
            #marker-table th,
            #marker-table td {
                padding: 1px 2px !important;
                min-width: 30px !important;
                white-space: normal !important;
                word-break: break-word !important;
            }
            
            /* Remove fixed widths on small screens */
            #marker-table th[style*="width"],
            #marker-table td[style*="width"] {
                width: auto !important;
                min-width: 25px !important;
            }
            
            /* Make the gene expression section more responsive */
            [data-library-content="gene-expression"] .responsive-two-col-grid {
                grid-template-columns: 1fr !important;
            }
            
            /* Keep RNA marker table constrained even on small screens */
            [data-library-content="gene-expression"] .marker-table-container {
                max-width: 720px !important;
                width: 100% !important;
                margin-left: auto !important;
                margin-right: auto !important;
            }
            [data-library-content="gene-expression"] .marker-search-row {
                max-width: 720px !important;
                width: 100% !important;
                margin-left: 0 !important;
                margin-right: 0 !important;
            }
            
            /* Clonotype section mobile optimization for small screens */
            .clonotype-chart-container {
                max-height: 250px !important;
                overflow: hidden !important;
            }
            
            .clonotype-table {
                font-size: 0.75rem !important;
            }
            
            .clonotype-table th,
            .clonotype-table td {
                padding: 6px 8px !important;
            }
        }

        /* Analysis Description Styles */
        .analysis-description {
            background: #f7fafc;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border-left: 4px solid #4299e1;
        }

        .analysis-description p {
            color: #4a5568;
            line-height: 1.6;
            margin-bottom: 1rem;
        }

        .key-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .metric-item {
            background: white;
            padding: 1rem;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }

        .metric-label {
            display: block;
            font-size: 0.85rem;
            color: #718096;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .metric-value {
            display: block;
            font-size: 1rem;
            color: #2d3748;
            font-weight: 600;
        }

        .sample-info-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            background: var(--gradient-bg);
            color: white;
            margin: 0 -1.5rem;
        }
        .brand-info {
            display: inline-flex;
            align-items: flex-start;
        }
        .brand-name {
            color: white;
            font-size: 1.5rem;
            font-weight: 600;
        }
        .brand-tm {
            font-size: 0.6rem;
            font-weight: 700;
            vertical-align: text-top;
            transform: translateY(4px);
            margin-left: 4px;
        }

        /* Library Type Selector Styles */
        .library-selector-container {
            position: sticky;
            top: 0;
            background: #f8fafc; /* Match content area background */
            z-index: 100;
            padding-top: 0; /* Keep content at top edge */
            /* Counteract parent padding to span full width */
            margin-left: -1.5rem;
            margin-right: -1.5rem;
            padding-left: 1.5rem;
            padding-right: 1.5rem;
            margin-bottom: 12px; /* tighter spacing below */
            box-sizing: border-box;
        }

        /* Place library tabs and sample title on the same row */
        .library-topbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            flex-wrap: nowrap; /* keep in one row */
            padding: 6px 0; /* reduce bar height */
            border-bottom: 1px solid #e5e7eb; /* full-width divider */
        }
        .library-topbar-right {
            display: flex;
            align-items: flex-end; /* align items to the bottom edge */
            gap: 8px;
            justify-content: flex-end;
            flex: 0 1 45%;
            min-width: 220px;
            max-width: 45%;
            padding-right: 20px; /* small breathing room from right edge */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .library-topbar-title {
            margin: 0;
            font-size: 2.0rem;
            line-height: 1; /* tighten line height for cleaner bottom alignment */
            font-weight: 600;
            color: white;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .library-topbar-subtitle {
            margin: 0;
            font-size: 1.0rem;
            color: #64748b;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Small green badge for Sample ID label */
        .library-topbar-badge {
            color: white;
            font-weight: 700;
            font-size: 1rem; /* roughly half of 2rem title */
            line-height: 1;
            margin-right: 6px;
            white-space: nowrap;
            position: relative; /* fine-tune vertical offset */
            top: 0; /* neutral offset for flex-end alignment */
        }
        @media (max-width: 900px) {
            .library-topbar-badge { font-size: 0.85rem; }
        }

        .library-selector-title {
            display: none;
        }

        .library-tabs {
            display: flex;
            gap: 0;
            justify-content: flex-start;
            flex-wrap: nowrap; /* prevent second row */
            position: relative;
            flex: 1 1 auto;
            min-width: 0; /* enable shrinking without overflow */
        }

        .top-tab-buttons {
            display: flex;
            gap: 8px;
            align-items: center;
            flex: 0 0 auto;
            white-space: nowrap;
        }

        .top-tab-buttons .tab-button {
            width: auto;
            padding: 8px 12px;
            border-left: none;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            background: white;
            color: #475569;
            font-size: 0.85rem;
            font-weight: 600;
            text-align: center;
            justify-content: center;
            gap: 0;
        }

        .top-tab-buttons .tab-button:hover {
            background: #f8fafc;
            color: #1e293b;
            border-color: var(--primary-color);
        }

        .top-tab-buttons .tab-button.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .library-tab-btn {
            padding: 10px 18px;
            border: none;
            border-radius: 0;
            background: transparent;
            color: #6b7280;
            font-size: 17px;
            font-weight: 550;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: auto;
            text-align: center;
            position: relative;
            border-bottom: 4px solid transparent;
        }

        @media (max-width: 900px) {
            .library-topbar-title { font-size: 1.2rem; }
            .library-topbar-subtitle { font-size: 0.95rem; }
            .library-tab-btn { padding: 8px 12px; font-size: 16px; }
        }

        .library-tab-btn:hover {
            color: #374151;
            background: rgba(0, 0, 0, 0.02);
        }

        .library-tab-btn.active {
            color: #1f2937 !important;
            font-weight: 600 !important;
            border-bottom-color: var(--primary-color) !important;
            background: transparent !important;
        }

        .library-tab-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            color: #d1d5db;
        }

        .library-tab-btn:disabled:hover {
            background: transparent;
            color: #d1d5db;
        }

        /* Content visibility for library types is now handled by JavaScript to support dynamic default views. */

        /* New Info Box Styles */
        .info-box {
            margin-top: 2rem;
            background: #fff; /* Changed from var(--secondary-color) to white */
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
        }
        .info-box-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1rem;
        }
        .info-item {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-left-width: 4px;
            
        }
        .info-item:hover {
            box-shadow: var(--shadow-md);
        }
        .info-item-label {
            display: block;
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-bottom: 0.25rem;
        }
        .info-item-value {
            color: var(--text-primary);
            font-size: 0.9rem;
            font-weight: 600;
        }
        /* Info item border colors */
        .info-item.version { border-left-color: #3498db; }
        .info-item.chemistry { border-left-color: #e74c3c; }
        .info-item.introns { border-left-color: #9b59b6; }
        .info-item.transcriptome { border-left-color: #f39c12; }
        .text-success { color: #3498DB; }
</style>
<script>
    // Normalize fonts across charts: x-axis and annotations
    (function() {
        if (!window.Plotly) { return; }
        const originalNewPlot = Plotly.newPlot;
        Plotly.newPlot = function(gd, data, layout, config) {
            try {
                if (layout && typeof layout === 'object') {
                    // Enforce x-axis fonts
                    Object.keys(layout).forEach(function(key) {
                        if (key.startsWith('xaxis')) {
                            const axis = layout[key] || {};
                            axis.titlefont = { size: 12, color: '#2c3e50' };
                            axis.tickfont = { size: 10, color: '#2c3e50' };
                            axis.title = axis.title || {};
                            axis.title.font = { size: 12, color: '#2c3e50' };
                            layout[key] = axis;
                        }
                    });
                    // Enforce annotation fonts
                    if (Array.isArray(layout.annotations)) {
                        layout.annotations = layout.annotations.map(function(a) {
                            a = a || {};
                            a.font = Object.assign({}, a.font, { size: 12 });
                            return a;
                        });
                    }
                }
            } catch (e) {}
            return originalNewPlot.call(this, gd, data, layout, config);
        };
    })();
</script>
<script>
// Plotly visibility and resize handling to prevent blank charts on navigation
(function() {
    const safeResize = (el) => {
        try { Plotly.Plots.resize(el); } catch (e) {}
        try { Plotly.redraw(el); } catch (e) {}
    };

    const observeTargets = new IntersectionObserver((entries) => {
        entries.forEach((entry) => {
            if (entry.isIntersecting && entry.intersectionRatio > 0) {
                const el = entry.target;
                safeResize(el);
            }
        });
    }, { threshold: [0, 0.1, 0.2] });

    const registerElement = (id) => {
        const el = document.getElementById(id);
        if (!el) return;
        observeTargets.observe(el);
    };

    window.registerPlot = (id, data, layout, config) => {
        return Plotly.newPlot(id, data, layout, config).then(() => {
            registerElement(id);
            const el = document.getElementById(id);
            safeResize(el);
        });
    };

    const registerAllPlaceholders = () => {
        document.querySelectorAll('.plot-placeholder').forEach((el) => {
            observeTargets.observe(el);
        });
    };

    window.addEventListener('DOMContentLoaded', () => {
        registerAllPlaceholders();
        // Initial pass to ensure any loaded plots are sized
        document.querySelectorAll('.plot-placeholder').forEach((el) => safeResize(el));
    });

    window.addEventListener('visibilitychange', () => {
        if (!document.hidden) {
            document.querySelectorAll('.plot-placeholder').forEach((el) => safeResize(el));
        }
    });

    window.addEventListener('hashchange', () => {
        // After anchor navigation, ensure visible plots are resized
        setTimeout(() => {
            document.querySelectorAll('.plot-placeholder').forEach((el) => safeResize(el));
        }, 150);
    });

    window.addEventListener('resize', () => {
        document.querySelectorAll('.plot-placeholder').forEach((el) => safeResize(el));
    });
})();
</script>
<script>
// More robust plot resizing on tab/library switch
(function() {
    const forceResizeAllPlotsIn = (container) => {
        if (!container || !window.Plotly) return;
        setTimeout(() => {
            const plots = container.querySelectorAll('.plot-placeholder, .plotly-graph-div, [data-processed="true"]');
            for (let i = 0; i < plots.length; i++) {
                try {
                    Plotly.Plots.resize(plots[i]);
                } catch (e) {
                    // Ignore errors if element is not a plot
                }
            }
        }, 50); // A small delay to allow the layout to update
    };

    const setupTabListeners = () => {
        document.body.addEventListener('click', function(event) {
            const button = event.target.closest('button');
            if (!button) return;

            let targetContent;
            // Handle main tabs
            if (button.matches('[data-tab]')) {
                const tabId = button.getAttribute('data-tab');
                targetContent = document.getElementById(tabId + '-tab');
            }
            // Handle library tabs
            else if (button.matches('[data-library]')) {
                const libraryId = button.getAttribute('data-library');
                // Find the active tab pane first
                const activeTabPane = document.querySelector('.tab-pane.active');
                if(activeTabPane){
                    targetContent = activeTabPane.querySelector(`[data-library-content="${libraryId}"]`);
                }
            }

            if (targetContent) {
                forceResizeAllPlotsIn(targetContent);
            }
        });
    };

    window.addEventListener('DOMContentLoaded', setupTabListeners);
})();
</script>
</head>
<body><div class="container">

<!-- Mobile overlay -->
<div class="mobile-overlay" id="mobileOverlay"></div>
<div class="main-layout">

<!-- Right Content Area -->
<div class="content-area">
  <!-- Report footer moved to bottom of content column -->

  <!-- Sample Info -->
  <div class="sample-info-container">
      <div class="brand-info">
        <span class="brand-name">MGIEasy Full-length Transcriptome</span>
      </div>
      <div class="library-topbar-right">
        <span class="library-topbar-badge">Sample ID:</span>
        <h1 class="library-topbar-title">${samplename}</h1>
      </div>
  </div>

  <!-- Global Library Type Selector (visible across all tabs) -->
  <div class="library-selector-container">
    <div class="library-topbar">
      <div class="library-tabs">
        <button class="library-tab-btn active" data-tab="summary">Summary</button>
        <button class="library-tab-btn" data-tab="cells">UMI-based</button>
        <button class="library-tab-btn" data-tab="library">Read-based</button>
      </div>
    </div>
  </div>

<div class="content-wrapper">
<!-- Tab Content Areas -->
<div class="tab-content">
<!-- Summary Tab -->
<div class="tab-pane active" id="summary-tab">
<section class="summary-section" data-library-content="gene-expression">
<h2>Summary 
                                <button id="toggle-summary-explanation" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(13, 148, 136, 0.3)'" onmouseover="this.style.transform='scale(1.1)'; this.style.boxShadow='0 4px 12px rgba(13, 148, 136, 0.4)'" style="
                                    background: var(--gradient-bg);
                                    color: white;
                                    border: none;
                                    border-radius: 50%;
                                    width: 28px;
                                    height: 28px;
                                    font-size: 14px;
                                    font-weight: bold;
                                    cursor: pointer;
                                    margin-left: 15px;
                                    box-shadow: 0 2px 8px rgba(13, 148, 136, 0.3);                                    
                                    display: inline-flex;
                                    align-items: center;
                                    justify-content: center;
                                ">?</button>
</h2>
<div id="summary-explanation" style="
                                display: none; 
                                margin-top: 15px; 
                                padding: 20px; 
                                background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
                                border: none;
                                border-radius: 12px;
                                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
                                
                            ">
<h3 style="
                                    color: #2c3e50;
                                    margin-bottom: 15px;
                                    font-size: 1.1em;
                                    border-bottom: 2px solid #3498db;
                                    padding-bottom: 8px;
                                    display: inline-block;
                                ">Summary Parameters Explanation</h3>
<ul style="
                                    list-style: none;
                                    padding: 0;
                                    margin: 0;
                                ">
<li style="
                                        margin-bottom: 12px;
                                    padding: 12px;
                                    background: rgba(255, 255, 255, 0.8);
                                    border-radius: 8px;
                                    border-left: 4px solid #3498db;
                                    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                                "><strong style="color: #2980b9;">Number of cells:</strong> The number of barcodes identified as real cells (not background noise or empty droplets) in the sequencing data. This is predicted using an empty droplet model (EmptyDrops) after merging cell barcodes from the same droplet. Values higher or lower than expected may indicate inaccurate cell counting, cell lysis, or failures in droplet generation.</li>
<li style="
                                    margin-bottom: 12px;
                                    padding: 12px;
                                    background: rgba(255, 255, 255, 0.8);
                                    border-radius: 8px;
                                    border-left: 4px solid #e74c3c;
                                    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                                "><strong style="color: #c0392b;">Median UMI per cell:</strong> The median number of unique molecular identifiers (UMIs) detected per cell among all identified cells.</li>
<li style="
                                    margin-bottom: 12px;
                                    padding: 12px;
                                    background: rgba(255, 255, 255, 0.8);
                                    border-radius: 8px;
                                    border-left: 4px solid #27ae60;
                                    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                                "><strong style="color: #229954;">Median gene per cell:</strong> The median number of unique genes with detectable expression in each cell.</li>
</ul>
</div>
<!-- Summary Stats -->
<div class="summary-cards">
<div class="summary-card">
<div class="summary-card-content">
<div class="value">${rna_estm_Num_cell}</div>
<div class="label">Number of cells</div>
</div>
</div>
<div class="summary-card">
<div class="summary-card-content">
<div class="value">${rna_median_umis_percell}</div>
<div class="label">Median UMI per cell</div>
</div>
</div>
<div class="summary-card">
<div class="summary-card-content">
<div class="value">${rna_median_genes_percell}</div>
<div class="label">Median gene per cell</div>
</div>
</div>
</div>
<!-- Pipeline Information -->
<div class="info-box">
    <h3 class="info-box-title">Information</h3>
    <div class="info-grid">
        <div class="info-item version">
            <strong class="info-item-label">Pipeline Version:</strong>
            <span class="info-item-value">${version}</span>
        </div>
        <div class="info-item transcriptome">
            <strong class="info-item-label">Transcriptome:</strong>
            <span class="info-item-value">${rna_species}</span>
        </div>
    </div>
</div>
<script>
                            const summaryToggle = document.getElementById('toggle-summary-explanation');
                            if (summaryToggle) {
                                summaryToggle.addEventListener('click', function() {
                                    var explanationDiv = document.getElementById('summary-explanation');
                                    if (!explanationDiv) return;
                                    if (explanationDiv.style.display === 'none') {
                                        explanationDiv.style.display = 'block';
                                    } else {
                                        explanationDiv.style.display = 'none';
                                    }
                                });
                            }
                        </script>
</section>

<!-- Sequencing Data Distribution -->
<section class="section-card">
    <h3>Sequencing Data Distribution</h3>
    <div style="
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 420px;
        ">
        <h4 style="color: #2c3e50; margin-bottom: 15px; text-align: center;">Data Distribution</h4>
        <div style="width: 750px; margin: 0 auto; display: flex; flex-direction: column; gap: 12px;">
            <div id="rna-read-distribution-bar" class="plot-placeholder" data-plot-id="rna-read-distribution-bar" style="width: 750px; height: 120px; display: flex; align-items: center; justify-content: center; color: #94a3b8;">
                Chart not available
            </div>
            <div id="rna-read-distribution-box" class="plot-placeholder" data-plot-id="rna-read-distribution-box" style="width: 750px; height: 260px; display: flex; align-items: center; justify-content: center; color: #94a3b8;">
                Chart not available
            </div>
        </div>
    </div>
    <!-- Data Values -->
    <div class="key-metrics" id="data_distribution_values" style="margin-top: 1rem;">
         <div class="metric-item">
            <span class="metric-label">Exonic</span>
            <span class="metric-value" data-metric="exon">N/A</span>
        </div>
        <div class="metric-item">
            <span class="metric-label">Intronic</span> 
            <span class="metric-value" data-metric="intron">N/A</span>
        </div>
        <div class="metric-item">
            <span class="metric-label">Intergenic</span>
            <span class="metric-value" data-metric="intergenic">N/A</span>
        </div>
        <div class="metric-item">
            <span class="metric-label">Unmapped</span>
            <span class="metric-value" data-metric="unmapped">N/A</span>
        </div>
        <div class="metric-item">
            <span class="metric-label">Ambiguity</span>
            <span class="metric-value" data-metric="ambiguity">N/A</span>
        </div>
        <div class="metric-item">
            <span class="metric-label">Unused BC</span>
            <span class="metric-value" data-metric="unused_bc">N/A</span>
        </div>
    </div>
    <script>
        (function() {
            try {
                const rawBar = '${rna_read_distribution_bar_data}';
                const rawBox = '${rna_read_distribution_box_data}';

                const parseObject = (raw) => {
                    if (!raw) return null;
                    const s = String(raw).trim();
                    if (!s.startsWith('{')) return null;
                    try { return JSON.parse(s); } catch (e) { return null; }
                };

                const barPayload = parseObject(rawBar);
                const boxPayload = parseObject(rawBox);

                const barEl = document.getElementById('rna-read-distribution-bar');
                const boxEl = document.getElementById('rna-read-distribution-box');
                if (!barEl || !boxEl) return;

                if (typeof Plotly === 'undefined') {
                    barEl.innerHTML = '<div style="text-align:center;color:#e74c3c;">Plotly library failed to load</div>';
                    boxEl.innerHTML = '<div style="text-align:center;color:#e74c3c;">Plotly library failed to load</div>';
                    return;
                }

                const formatPct = (v) => {
                    const num = Number(v);
                    if (!Number.isFinite(num)) return 'N/A';
                    return num.toFixed(1) + '%';
                };

                const metricExon = document.querySelector('[data-metric="exon"]');
                const metricIntron = document.querySelector('[data-metric="intron"]');
                const metricIntergenic = document.querySelector('[data-metric="intergenic"]');
                if (barPayload && barPayload.values) {
                    if (metricExon) metricExon.textContent = formatPct(barPayload.values.Exon);
                    if (metricIntron) metricIntron.textContent = formatPct(barPayload.values.Intron);
                    if (metricIntergenic) metricIntergenic.textContent = formatPct(barPayload.values.Intergenic);
                }

                if (!barPayload || !barPayload.order || !barPayload.values) {
                    barEl.innerHTML = '<div style="text-align:center;color:#94a3b8;">No available data</div>';
                } else {
                    const order = Array.isArray(barPayload.order) ? barPayload.order : [];
                    const colors = barPayload.colors || {};
                    const traces = [];
                    for (const c of order) {
                        const v = Number((barPayload.values || {})[c]);
                        if (!Number.isFinite(v) || v <= 0) continue;
                        traces.push({
                            type: 'bar',
                            orientation: 'h',
                            x: [v],
                            y: [''],
                            name: c,
                            marker: { color: colors[c] || '#94a3b8' },
                            hovertemplate: '%{x:.2f}%<extra>' + c + '</extra>'
                        });
                    }

                    if (!traces.length) {
                        barEl.innerHTML = '<div style="text-align:center;color:#94a3b8;">No available data</div>';
                    } else {
                        const barLayout = {
                            barmode: 'stack',
                            xaxis: { title: { text: '% of total reads' }, range: [0, 100], fixedrange: true, gridcolor: 'lightgray' },
                            yaxis: { showticklabels: false, fixedrange: true },
                            legend: { orientation: 'h', x: 0.5, y: -0.25, xanchor: 'center', yanchor: 'top' },
                            margin: { l: 10, r: 10, t: 10, b: 55 },
                            height: 120,
                            hovermode: 'closest',
                            plot_bgcolor: 'rgba(0,0,0,0)',
                            paper_bgcolor: 'rgba(0,0,0,0)'
                        };
                        Plotly.newPlot(barEl, traces, barLayout, { responsive: true, displayModeBar: false });
                    }
                }

                if (!boxPayload || !boxPayload.order || !boxPayload.values) {
                    boxEl.innerHTML = '<div style="text-align:center;color:#94a3b8;">No available data</div>';
                } else {
                    const order = Array.isArray(boxPayload.order) ? boxPayload.order : [];
                    const values = boxPayload.values || {};
                    const colors = boxPayload.colors || {};
                    const traces = [];
                    for (const c of order) {
                        const arr = Array.isArray(values[c]) ? values[c] : [];
                        if (!arr.length) continue;
                        traces.push({
                            type: 'box',
                            name: c,
                            y: arr,
                            boxpoints: false,
                            fillcolor: colors[c] || '#94a3b8',
                            marker: { color: colors[c] || '#94a3b8' },
                            line: { color: colors[c] || '#94a3b8' },
                            hovertemplate: '%{y:.2f}%<extra>' + c + '</extra>'
                        });
                    }

                    if (!traces.length) {
                        boxEl.innerHTML = '<div style="text-align:center;color:#94a3b8;">No available data</div>';
                    } else {
                        const boxLayout = {
                            yaxis: { title: { text: '% reads/cell' }, fixedrange: true, gridcolor: 'lightgray' },
                            xaxis: { fixedrange: true },
                            margin: { l: 60, r: 10, t: 10, b: 40 },
                            height: 260,
                            hovermode: 'closest',
                            plot_bgcolor: 'rgba(0,0,0,0)',
                            paper_bgcolor: 'rgba(0,0,0,0)'
                        };
                        Plotly.newPlot(boxEl, traces, boxLayout, { responsive: true, displayModeBar: false });
                    }
                }
            } catch (e) {
                console.error('Error rendering read distribution plots:', e);
            }
        })();
    </script>
</section>

<!-- Saturation and Gene Body Coverage -->
<section class="section-card">
    <h3>Saturation & Gene Body Coverage</h3>
    <div class="responsive-two-col-grid">
        <div>
            <div style="
                    background: white;
                    border-radius: 8px;
                    padding: 15px;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    height: 100%;
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                    align-items: center;
                    min-height: 420px;
                ">
                <h4 style="color: #2c3e50; margin-bottom: 15px; text-align: center;">Sequencing Saturation</h4>
                <div id="saturation_plot" class="plot-placeholder" data-plot-id="saturation_plot" style="width: 400px; height: 360px;"></div>
            </div>
        </div>
        <div>
            <div style="
                    background: white;
                    border-radius: 8px;
                    padding: 15px;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    height: 100%;
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                    align-items: center;
                    min-height: 420px;
                ">
                <h4 style="color: #2c3e50; margin-bottom: 15px; text-align: center;">Gene Body Coverage</h4>
                <div id="gene_body_coverage_plot" class="plot-placeholder" data-plot-id="gene_body_coverage_plot" style="width: 400px; height: 360px; display: flex; align-items: center; justify-content: center; color: #94a3b8;">
                    Chart not available
                </div>
            </div>
        </div>
    </div>
    <script>
        (function() {
            try {
                const satXJSON = '${rna_saturation_fraction}';
                const satLibJSON = '${rna_saturation_lib_pct}';
                const satGeneJSON = '${rna_saturation_gene_pct}';
                const medUmiJSON = '${rna_saturation_median_genes_umi}';
                const medReadJSON = '${rna_saturation_median_genes_read}';

                const parseArray = (raw) => {
                    if (!raw) return [];
                    const s = String(raw).trim();
                    if (!s.startsWith('[')) return [];
                    try { return JSON.parse(s); } catch (e) { return []; }
                };

                let sat_x = parseArray(satXJSON);
                let sat_lib = parseArray(satLibJSON);
                let sat_gene = parseArray(satGeneJSON);
                let med_umi = parseArray(medUmiJSON);
                let med_read = parseArray(medReadJSON);

                if (!sat_x.length) sat_x = parseArray('${rna_saturation_sampling_fraction}');
                if (!sat_lib.length) sat_lib = parseArray('${rna_saturation_seq_pct}');
                if (!med_umi.length) med_umi = parseArray('${rna_saturation_median_genes}');

                const container = document.getElementById('saturation_plot');
                const hasData = sat_x.length > 0 && sat_x.length === sat_lib.length && sat_x.length === sat_gene.length;

                if (!container) return;

                if (!hasData) {
                    container.innerHTML = '<div style="text-align: center; color: #94a3b8; padding-top: 50px;">No available data</div>';
                    return;
                }

                if (typeof Plotly === 'undefined') {
                    container.innerHTML = '<div style="text-align:center;color:#e74c3c;padding-top:50px;">Plotly library failed to load</div>';
                    return;
                }

                const traces = [];

                traces.push({
                    x: sat_x,
                    y: sat_lib,
                    name: 'Sat (Library)',
                    type: 'scatter',
                    mode: 'lines+markers',
                    line: { color: '#2ECC71', width: 2 },
                    marker: { size: 6 }
                });

                traces.push({
                    x: sat_x,
                    y: sat_gene,
                    name: 'Sat (Gene)',
                    type: 'scatter',
                    mode: 'lines+markers',
                    line: { color: '#E67E22', width: 2, dash: 'dash' },
                    marker: { size: 6 }
                });

                if (med_umi.length === sat_x.length) {
                    traces.push({
                        x: sat_x,
                        y: med_umi,
                        name: 'Median Genes (UMI)',
                        yaxis: 'y2',
                        type: 'scatter',
                        mode: 'lines+markers',
                        line: { color: '#3498DB', width: 2 },
                        marker: { size: 6 }
                    });
                }

                if (med_read.length === sat_x.length) {
                    const hasAny = med_read.some(v => Number(v) > 0);
                    if (hasAny) {
                        traces.push({
                            x: sat_x,
                            y: med_read,
                            name: 'Median Genes (Read)',
                            yaxis: 'y2',
                            type: 'scatter',
                            mode: 'lines+markers',
                            line: { color: '#16A085', width: 2, dash: 'dash' },
                            marker: { size: 6 }
                        });
                    }
                }

                const layout = {
                    xaxis: { title: { text: 'Sequencing Depth (Fraction)' }, fixedrange: true },
                    yaxis: { title: { text: 'Sequencing Saturation (%)' }, range: [0, 105], fixedrange: true },
                    yaxis2: {
                        title: { text: 'Median Genes' },
                        overlaying: 'y',
                        side: 'right',
                        fixedrange: true
                    },
                    legend: {
                        orientation: 'h',
                        x: 0.5,
                        y: -0.2,
                        xanchor: 'center',
                        yanchor: 'top'
                    },
                    margin: { l: 50, r: 60, t: 20, b: 60 },
                    hovermode: 'closest',
                    plot_bgcolor: 'rgba(0,0,0,0)',
                    paper_bgcolor: 'rgba(0,0,0,0)'
                };

                Plotly.newPlot('saturation_plot', traces, layout, { responsive: true, displayModeBar: false });
            } catch (e) {
                console.error("Error rendering saturation plot:", e);
            }
        })();

        (function() {
            try {
                const xJSON = '${rna_gene_body_percentile}';
                const umiJSON = '${rna_gene_body_umi_maxnorm}';
                const intJSON = '${rna_gene_body_internal_maxnorm}';

                const parseArray = (raw) => {
                    if (!raw) return [];
                    const s = String(raw).trim();
                    if (!s.startsWith('[')) return [];
                    try { return JSON.parse(s); } catch (e) { return []; }
                };

                const x = parseArray(xJSON);
                const umi = parseArray(umiJSON);
                const internal = parseArray(intJSON);

                const container = document.getElementById('gene_body_coverage_plot');
                const hasData = x.length > 0 && x.length === umi.length && x.length === internal.length;
                if (!container) return;

                if (!hasData) {
                    container.innerHTML = '<div style="text-align: center; color: #94a3b8; padding-top: 50px;">No available data</div>';
                    return;
                }

                if (typeof Plotly === 'undefined') {
                    container.innerHTML = '<div style="text-align:center;color:#e74c3c;padding-top:50px;">Plotly library failed to load</div>';
                    return;
                }

                const smooth = (arr, window) => {
                    const y = Array.isArray(arr) ? arr.map(v => Number(v)) : [];
                    const w = Number(window);
                    if (!y.length || !Number.isFinite(w) || w <= 1) return y;
                    const ww = (w % 2 === 0) ? (w + 1) : w;
                    if (y.length < ww) return y;
                    const pad = Math.floor(ww / 2);
                    const yPad = [];
                    for (let i = 0; i < pad; i++) yPad.push(y[0]);
                    for (let i = 0; i < y.length; i++) yPad.push(y[i]);
                    for (let i = 0; i < pad; i++) yPad.push(y[y.length - 1]);
                    const out = [];
                    const denom = ww;
                    for (let i = 0; i <= yPad.length - ww; i++) {
                        let s = 0;
                        for (let j = 0; j < ww; j++) s += (Number.isFinite(yPad[i + j]) ? yPad[i + j] : 0);
                        out.push(s / denom);
                    }
                    return out;
                };

                const umiS = smooth(umi, 7);
                const intS = smooth(internal, 7);

                const traceInt = {
                    x: x,
                    y: intS,
                    name: 'Inter Coverage',
                    type: 'scatter',
                    mode: 'lines',
                    line: { color: 'blue', width: 2 }
                };

                const traceUmi = {
                    x: x,
                    y: umiS,
                    name: 'UMI Coverage',
                    type: 'scatter',
                    mode: 'lines',
                    line: { color: 'red', width: 2 }
                };

                const layout = {
                    xaxis: { title: { text: "Gene Body Percentile (5'->3')" }, fixedrange: true },
                    yaxis: { title: { text: 'Coverage' }, range: [0, 1.05], fixedrange: true },
                    legend: { orientation: 'h', x: 0.5, y: -0.2, xanchor: 'center', yanchor: 'top' },
                    margin: { l: 55, r: 20, t: 20, b: 60 },
                    hovermode: 'closest',
                    plot_bgcolor: 'rgba(0,0,0,0)',
                    paper_bgcolor: 'rgba(0,0,0,0)'
                };

                Plotly.newPlot('gene_body_coverage_plot', [traceInt, traceUmi], layout, { responsive: true, displayModeBar: false });
            } catch (e) {
                console.error('Error rendering gene body coverage plot:', e);
            }
        })();
    </script>
</section>

<!-- zUMIs Stats Table -->
<section class="section-card" data-library-content="gene-expression">
<h3 class="tooltip" data-tooltip="Per-well zUMIs stats table generated by generate_stats.py">zUMIs Stats Table</h3>
<div class="marker-search-row" style="
                                display: flex;
                                justify-content: flex-end;
                                margin: 20px 0 10px 0;
                            ">
<div style="
                                    display: flex;
                                    align-items: center;
                                    gap: 10px;
                                ">
<label for="rna-stats-search" style="
                                        font-weight: 500;
                                        color: #333;
                                        font-size: 14px;
                                    ">Search:</label>
<input id="rna-stats-search" placeholder="Search wells..." style="
                                        padding: 8px 12px;
                                        border: 2px solid #ddd;
                                        border-radius: 6px;
                                        font-size: 14px;
                                        width: 200px;
                                        transition: border-color 0.3s ease;
                                    " type="text"/>
</div>
</div>
<div class="marker-table-container" style="
                                background: white;
                                border-radius: 8px;
                                padding: 20px;
                                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                                overflow-x: auto;
                                -webkit-overflow-scrolling: touch;
                            ">
<table id="rna-stats-table" style="
                                    min-width: 100%;
                                    width: max-content;
                                    border-collapse: collapse;
                                    font-size: 12px;
                                    background: white;
                                ">
<thead id="rnaStatsTableHeader">
<!-- Dynamic headers will be generated by JavaScript -->
</thead>
<tbody id="rna-stats-table-body">
<!-- Data will be populated by JavaScript -->
</tbody>
</table>
</div>
<div style="
                                    display: flex;
                                    justify-content: space-between;
                                    align-items: center;
                                    margin-top: 20px;
                                    padding: 15px 0;
                                    border-top: 1px solid #dee2e6;
                                ">
<div style="color: #6c757d; font-size: 14px;">
                                        Showing <span id="rna-stats-table-start">0</span>-<span id="rna-stats-table-end">0</span> of <span id="rna-stats-table-total">0</span> entries
                                    </div>
<div style="display: flex; align-items: center; gap: 10px;">
<span style="color: #495057; font-size: 14px;">Show</span>
<select id="rna-stats-rows-selector" style="
                                            padding: 6px 10px;
                                            border: 1px solid #dee2e6;
                                            border-radius: 4px;
                                            background: white;
                                            color: #495057;
                                            font-size: 14px;
                                            cursor: pointer;
                                        ">
<option value="10">10</option>
<option selected="" value="50">50</option>
<option value="100">100</option>
<option value="500">500</option>
</select>
<span style="color: #495057; font-size: 14px;">entries</span>
</div>
<div style="display: flex; gap: 5px;">
<button disabled="" id="rna-stats-prev-btn" style="
                                            padding: 8px 12px;
                                            border: 1px solid #dee2e6;
                                            background: white;
                                            color: #495057;
                                            border-radius: 4px;
                                            cursor: pointer;
                                            font-size: 14px;
                                        ">Previous</button>
<button id="rna-stats-next-btn" style="
                                            padding: 8px 12px;
                                            border: 1px solid #dee2e6;
                                            background: white;
                                            color: #495057;
                                            border-radius: 4px;
                                            cursor: pointer;
                                            font-size: 14px;
                                        ">Next</button>
</div>
</div>
</section>

<!-- Configuration Section -->
<section class="section-card simple-card">
<div style="display: flex; align-items: center; justify-content: space-between;">
    <span style="font-size: 14px; font-weight: 400; color: #334155;">Configuration Parameters</span>
    <button id="toggle-parameters" aria-label="Toggle parameters" style="
        width: 28px;
        height: 28px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        background: #ffffff;
        color: #334155;
        cursor: pointer;
        transition: all 0.2s ease;
    ">
        <svg id="toggle-parameters-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="6 9 12 15 18 9"></polyline>
        </svg>
    </button>
</div>
<div id="parameters-content" style="display: none; margin-top: 10px;">
    <div id="csv-title" style="font-size: 13px; font-weight: 500; color: #475569; margin-bottom: 6px;">Config yaml</div>
    <div class="marker-table-container" id="csv-table-container" style="border: 1px solid #e2e8f0; border-radius: 8px; background: #ffffff;">
        <p style="padding: 12px; color: #64748b;">Not available or empty.</p>
    </div>
</div>
<script>
    (function() {
        var btn = document.getElementById('toggle-parameters');
        var icon = document.getElementById('toggle-parameters-icon');
        var content = document.getElementById('parameters-content');
        btn.addEventListener('click', function() {
            var open = content.style.display === 'block';
            content.style.display = open ? 'none' : 'block';
            icon.style.transform = open ? 'rotate(0deg)' : 'rotate(180deg)';
        });
        btn.addEventListener('mouseover', function() {
            btn.style.background = '#f8fafc';
        });
        btn.addEventListener('mouseout', function() {
            btn.style.background = '#ffffff';
        });
    })();
</script>
</section>
</div>
<!-- Cells Tab -->
<div class="tab-pane" id="cells-tab">
<!-- Library Type Selector removed; using global selector above -->
<!-- Sample Statistics and Violin Plot Section -->
<section class="section-card" data-library-content="gene-expression">
<h3 class="tooltip" data-tooltip="Key quality metrics for the single-cell RNA sequencing sample">RNA Quality Metrics
                                <button id="toggle-cells-explanation" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(59, 130, 246, 0.3)'; this.style.background='#3b82f6'" onmouseover="this.style.transform='scale(1.1)'; this.style.boxShadow='0 4px 12px rgba(59, 130, 246, 0.4)'; this.style.background='#2563eb'" style="
                                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                    color: white;
                                    border: none;
                                    border-radius: 50%;
                                    width: 28px;
                                    height: 28px;
                                    font-size: 14px;
                                    font-weight: bold;
                                    cursor: pointer;
                                    margin-left: 15px;
                                    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);                                   
                                    display: inline-flex;
                                    align-items: center;
                                    justify-content: center;
                                ">?</button>
</h3>
<div id="cells-explanation" style="
                                display: none; 
                                margin-top: 15px; 
                                padding: 20px; 
                                background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
                                border: none;
                                border-radius: 12px;
                                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
                                
                            ">
<h4 style="
                                    color: #2c3e50;
                                    margin-bottom: 15px;
                                    font-size: 1.1em;
                                    border-bottom: 2px solid #3498db;
                                    padding-bottom: 8px;
                                    display: inline-block;
                                ">Cell Quality Metrics Explanation</h4>
<ul style="
                                    list-style: none;
                                    padding: 0;
                                    margin: 0;
                                ">
<li style="
                                        margin-bottom: 12px;
                                        padding: 12px;
                                        background: rgba(255, 255, 255, 0.8);
                                        border-radius: 8px;
                                        border-left: 4px solid #e74c3c;
                                        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                                    "><strong style="color: #C0392B;">Mean reads per cell:</strong> The average number of raw sequencing reads per cell, calculated by dividing the total raw reads by the number of identified cells.</li>
<li style="
                                        margin-bottom: 12px;
                                        padding: 12px;
                                        background: rgba(255, 255, 255, 0.8);
                                        border-radius: 8px;
                                        border-left: 4px solid #27AE60;
                                        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                                    "><strong style="color: #229954;">UMI counts per cell:</strong>  The number of unique transcript molecules captured per cell after UMI deduplication. Both mean and median values shown.</li>
<li style="
                                        margin-bottom: 12px;
                                        padding: 12px;
                                        background: rgba(255, 255, 255, 0.8);
                                        border-radius: 8px;
                                        border-left: 4px solid #f39c12;
                                        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                                    "><strong style="color: #e67e22;">Total genes detected:</strong> The total number of distinct genes detected across all cells in the dataset. This serves as an indicator of the biological diversity and overall sensitivity of the experiment.</li>
<li style="
                                        margin-bottom: 12px;
                                        padding: 12px;
                                        background: rgba(255, 255, 255, 0.8);
                                        border-radius: 8px;
                                        border-left: 4px solid #9b59b6;
                                        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                                    "><strong style="color: #8e44ad;">Genes per cell:</strong> Number of detected genes reflects cell viability and transcriptional complexity. Both mean and median values shown.</li>
<li style="
                                        margin-bottom: 12px;
                                        padding: 12px;
                                        background: rgba(255, 255, 255, 0.8);
                                        border-radius: 8px;
                                        border-left: 4px solid #34495e;
                                        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                                    "><strong style="color: #2c3e50;">Fraction reads in cells:</strong> The proportion of reads that are uniquely mapped to the transcriptome and associated with a valid cell barcode, indicating the efficiency of cell capture.</li>
<li style="
                                        margin-bottom: 0;
                                        padding: 12px;
                                        background: rgba(255, 255, 255, 0.8);
                                        border-radius: 8px;
                                        border-left: 4px solid #6366F1;
                                        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                                    "><strong style="color: #1D4ED8;">RNA Violin Plot:</strong> A violin plot illustrating the distribution of Genes (number of genes detected), UMIs (number of UMIs) and Mito.percent across all cells, providing insights into data quality and variability.</li>
</ul>
</div>
<div class="responsive-two-col-grid">
<!-- Left side: Statistics Table -->
<div>
<div class="stats-table-container" style="overflow-x: auto;">
<table style="
                                            width: 100%;
                                            border-collapse: collapse;
                                            background: white;
                                            border-radius: 8px;
                                            overflow: hidden;
                                            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                                        ">
<tbody>
<tr style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
<td style="padding: 12px 15px; font-weight: 600; color: #2c3e50; border-bottom: 1px solid #dee2e6;">
                                                        Mean reads per cell
</td>
<td style="padding: 12px 15px; color: #495057; border-bottom: 1px solid #dee2e6; font-weight: 600; text-align: right;">${rna_mean_reads_percell}</td>
</tr>
<tr style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
<td style="padding: 12px 15px; font-weight: 600; color: #2c3e50; border-bottom: 1px solid #dee2e6;">
                                                        Mean UMI counts per cell
</td>
<td style="padding: 12px 15px; color: #495057; border-bottom: 1px solid #dee2e6; font-weight: 600; text-align: right;">${rna_mean_umis_percell}</td>
</tr>
<tr style="background: white;">
<td style="padding: 12px 15px; font-weight: 600; color: #2c3e50; border-bottom: 1px solid #dee2e6;">
                                                        Median UMI counts per cell
</td>
<td style="padding: 12px 15px; color: #495057; border-bottom: 1px solid #dee2e6; font-weight: 600; text-align: right;">${rna_median_umis_percell}</td>
</tr>
<tr style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
<td style="padding: 12px 15px; font-weight: 600; color: #2c3e50; border-bottom: 1px solid #dee2e6;">
                                                        Total genes detected
</td>
<td style="padding: 12px 15px; color: #495057; border-bottom: 1px solid #dee2e6; font-weight: 600; text-align: right;">${rna_total_gene}</td>
</tr>
<tr style="background: white;">
<td style="padding: 12px 15px; font-weight: 600; color: #2c3e50; border-bottom: 1px solid #dee2e6;">
                                                        Mean Genes per cell
</td>
<td style="padding: 12px 15px; color: #495057; border-bottom: 1px solid #dee2e6; font-weight: 600; text-align: right;">${rna_mean_genes_percell}</td>
</tr>
<tr style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
<td style="padding: 12px 15px; font-weight: 600; color: #2c3e50; border-bottom: 1px solid #dee2e6;">
                                                        Median Genes per cell
</td>
<td style="padding: 12px 15px; color: #495057; border-bottom: 1px solid #dee2e6; font-weight: 600; text-align: right;">${rna_median_genes_percell}</td>
</tr>
</tbody>
</table>
</div>
</div>
<!-- Right side: Genes and UMIs Box Plot -->
<div>
<div style="
        background: white;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        min-height: 300px;
    ">
<h4 style="color: #2c3e50; margin-bottom: 8px; text-align: center;">Gene and UMI Counts by Type</h4>
                                        <div id="gene-umi-counts-by-type" class="plot-placeholder" data-plot-id="gene-umi-counts-by-type" style="width: 430px; height: 300px;"></div>
                                        <script id="script-gene-umi-counts-by-type">
                                            (function() {
                                                const targetId = 'gene-umi-counts-by-type';
                                                const target = document.getElementById(targetId);
                                                if (!target || !window.Plotly) return;

                                                const statsJson = '${rna_stats_table_data}';
                                                let records = [];
                                                try {
                                                    const parsed = JSON.parse(statsJson);
                                                    records = Array.isArray(parsed) ? parsed : [];
                                                } catch (e) {
                                                    records = [];
                                                }

                                                const toNumber = (v) => {
                                                    if (v === null || v === undefined) return null;
                                                    if (typeof v === 'number') return Number.isFinite(v) ? v : null;
                                                    const s = String(v).trim();
                                                    if (!s) return null;
                                                    const n = Number(s.replace(/,/g, ''));
                                                    return Number.isFinite(n) ? n : null;
                                                };

                                                const types = [
                                                    { label: 'Exon', geneKey: 'Exon_genes', umiKey: 'Exon_umis', color: '#1A5084' },
                                                    { label: 'Intron+Exon', geneKey: 'Intron_Exon_genes', umiKey: 'Intron_Exon_umis', color: '#914614' },
                                                    { label: 'Intron', geneKey: 'Intron_genes', umiKey: 'Intron_umis', color: '#118730' }
                                                ];

                                                const geneTraces = types.map(t => {
                                                    const ys = records
                                                        .map(r => toNumber(r ? r[t.geneKey] : null))
                                                        .filter(v => v !== null);
                                                    return {
                                                        type: 'box',
                                                        x: Array(ys.length).fill(t.label),
                                                        y: ys,
                                                        marker: { color: t.color },
                                                        line: { color: t.color, width: 1 },
                                                        boxpoints: false,
                                                        boxmean: true,
                                                        xaxis: 'x',
                                                        yaxis: 'y',
                                                        hovertemplate: '%{y}<extra></extra>',
                                                        name: t.label
                                                    };
                                                });

                                                const umiTraces = types.map(t => {
                                                    const ys = records
                                                        .map(r => toNumber(r ? r[t.umiKey] : null))
                                                        .filter(v => v !== null);
                                                    return {
                                                        type: 'box',
                                                        x: Array(ys.length).fill(t.label),
                                                        y: ys,
                                                        marker: { color: t.color },
                                                        line: { color: t.color, width: 1 },
                                                        boxpoints: false,
                                                        boxmean: true,
                                                        xaxis: 'x2',
                                                        yaxis: 'y2',
                                                        hovertemplate: '%{y}<extra></extra>',
                                                        name: t.label
                                                    };
                                                });

                                                const anyGene = geneTraces.some(t => (t.y || []).length > 0);
                                                const anyUmi = umiTraces.some(t => (t.y || []).length > 0);
                                                if (!anyGene && !anyUmi) {
                                                    target.innerHTML = '<div style="color:#6c757d;">No available data</div>';
                                                    return;
                                                }

                                                const layout = {
                                                    grid: { rows: 1, columns: 2, pattern: 'independent' },
                                                    boxmode: 'group',
                                                    margin: { l: 45, r: 15, t: 40, b: 35 },
                                                    height: 300,
                                                    paper_bgcolor: 'white',
                                                    plot_bgcolor: 'white',
                                                    showlegend: false,
                                                    xaxis: { title: '', tickfont: { size: 11, color: '#2c3e50' } },
                                                    yaxis: { title: { text: 'Genes', font: { size: 12, color: '#2c3e50' } }, gridcolor: 'rgba(0,0,0,0.1)' },
                                                    xaxis2: { title: '', tickfont: { size: 11, color: '#2c3e50' } },
                                                    yaxis2: { title: { text: 'UMIs', font: { size: 12, color: '#2c3e50' } }, gridcolor: 'rgba(0,0,0,0.1)' },
                                                    annotations: [
                                                        { text: 'Number of Genes', x: 0.23, y: 1.12, xref: 'paper', yref: 'paper', showarrow: false, font: { size: 12, color: '#2c3e50' } },
                                                        { text: 'Number of UMIs', x: 0.77, y: 1.12, xref: 'paper', yref: 'paper', showarrow: false, font: { size: 12, color: '#2c3e50' } }
                                                    ]
                                                };

                                                Plotly.newPlot(targetId, [...geneTraces, ...umiTraces], layout, {
                                                    displayModeBar: false,
                                                    displaylogo: false,
                                                    responsive: true
                                                });
                                            })();
                                        </script>
                                    </div>
                                </div>
    </div>
</section>

<section class="section-card" data-library-content="gene-expression">
<h3 class="tooltip" data-tooltip="Analysis of bead-to-cell mapping and barcode rank distribution for RNA">RNA Beads to Cells
                                <button id="toggle-rna-beads-explanation" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(59, 130, 246, 0.3)'; this.style.background='#3b82f6'" onmouseover="this.style.transform='scale(1.1)'; this.style.boxShadow='0 4px 12px rgba(59, 130, 246, 0.4)'; this.style.background='#2563eb'" style="
                                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                    color: white;
                                    border: none;
                                    border-radius: 50%;
                                    width: 28px;
                                    height: 28px;
                                    font-size: 14px;
                                    font-weight: bold;
                                    cursor: pointer;
                                    margin-left: 15px;
                                    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);                                    
                                    display: inline-flex;
                                    align-items: center;
                                    justify-content: center;
                                ">?</button>
</h3>
<div id="rna-beads-explanation" style="
                                display: none; 
                                margin-top: 15px; 
                                padding: 20px; 
                                background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
                                border: none;
                                border-radius: 12px;
                                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
                                
                            ">
<h4 style="
                                    color: #2c3e50;
                                    margin-bottom: 15px;
                                    font-size: 1.1em;
                                    border-bottom: 2px solid #3498db;
                                    padding-bottom: 8px;
                                    display: inline-block;
                                ">RNA Beads to Cells Analysis Explanation</h4>
<ul style="
                                    list-style: none;
                                    padding: 0;
                                    margin: 0;
                                ">
<li style="
                                        margin-bottom: 12px;
                                        padding: 12px;
                                        background: rgba(255, 255, 255, 0.8);
                                        border-radius: 8px;
                                        border-left: 4px solid #3498db;
                                        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                                    "><strong style="color: #2980b9;">RNA Barcode Rank Plot (left):</strong> In the library, transcripts from the same cell are grouped under a unified cell ID, each tagged with unique molecular identifiers (UMIs). However, RNA from ambient sources or dying cells may also be captured during library preparation. This barcode rank plot visualizes the distribution of total UMI counts per cell ID (x-axis: cell ID rank; y-axis: UMI count, both in log scale). Cell IDs with higher UMI counts (on the left) are more likely to represent real cells, while lower-count IDs (on the right) are often background. Blue points indicate high-confidence cells, gray points represent background (e.g., empty droplets), and the blue gradient region marks a transitional zone identified by an ambient RNA model. Hovering over each point reveals its rank, UMI count, and the percentage of real cells in its neighborhood, aiding in the distinction between true cells and noise.</li>
<li style="
                                        margin-bottom: 0;
                                        padding: 12px;
                                        background: rgba(255, 255, 255, 0.8);
                                        border-radius: 8px;
                                        border-left: 4px solid #e74c3c;
                                        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                                    "><strong style="color: #c0392b;">Bead Count Distribution (right):</strong> This plot displays the distribution of barcoded bead counts per droplet among identified real cells. While the number of beads per droplet is theoretically expected to follow a Poisson distribution, deviations may occur due to factors such as low RNA capture or inefficient bead merging. The distribution is affected by cell filtering thresholds and dynamically updates accordingly. If most droplets contain only one bead, it is advisable to check whether the oligo library has sufficient sequencing depth (recommended >50M reads) and whether it is properly matched to the cDNA library, as these factors can impact overall data quality and cell recovery.</li>
</ul>
</div>
<div class="responsive-two-col-grid">
<!-- Left side: Histogram -->
<div>
<div style="
                                        background: white;
                                        border-radius: 8px;
                                        padding: 15px;
                                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                                        height: 100%;
                                        display: flex;
                                        flex-direction: column;
                                        justify-content: center;
                                        align-items: center;
                                        min-height: 400px;
                                    ">
<div style="width: 100%; display: flex; justify-content: flex-end; align-items: center; gap: 10px; margin-bottom: 8px;">
<span style="color: #495057; font-size: 14px;">Metric</span>
<select id="rna-hist-metric" style="padding: 6px 10px; border: 1px solid #dee2e6; border-radius: 4px; background: white; color: #495057; font-size: 14px; cursor: pointer;">
<option value="mappingratio">MappingRatio</option>
<option value="exonintronratio">ExonIntronRatio</option>
<option value="umifrac">UMIfrac</option>
<option value="allreads">AllReads</option>
<option value="genes">Genes</option>
<option value="umis">UMIs</option>
</select>
</div>
<div id="rna-histogram-plot" class="plot-placeholder" data-plot-id="rna-histogram-plot" style="width: 400px; height: 360px; margin: 0 auto;"></div>
<script id="script-rna-histogram-plot">
                                            (function() {
                                                const el = document.getElementById('rna-histogram-plot');
                                                const selectEl = document.getElementById('rna-hist-metric');
                                                if (!el || !selectEl) return;
                                                if (typeof Plotly === 'undefined') {
                                                    el.innerHTML = '<div style="text-align:center;color:#e74c3c;padding-top:50px;">Plotly library failed to load</div>';
                                                    return;
                                                }

                                                const statsJson = '${rna_stats_table_data}';
                                                let rows = [];
                                                try {
                                                    const parsed = JSON.parse(statsJson);
                                                    rows = Array.isArray(parsed) ? parsed : [];
                                                } catch (e) {
                                                    rows = [];
                                                }

                                                const toNumber = (v) => {
                                                    if (v === null || v === undefined) return null;
                                                    if (typeof v === 'number') return Number.isFinite(v) ? v : null;
                                                    const s = String(v).trim();
                                                    if (!s) return null;
                                                    const n = Number(s.replace(/,/g, ''));
                                                    return Number.isFinite(n) ? n : null;
                                                };

                                                const safeDiv = (a, b) => {
                                                    const aa = toNumber(a);
                                                    const bb = toNumber(b);
                                                    if (aa === null || bb === null || bb === 0) return null;
                                                    return aa / bb;
                                                };

                                                const getVal = (r, keys) => {
                                                    for (let i = 0; i < keys.length; i++) {
                                                        const v = r ? r[keys[i]] : null;
                                                        const n = toNumber(v);
                                                        if (n !== null) return n;
                                                    }
                                                    return null;
                                                };

                                                const arrays = {
                                                    mappingratio: [],
                                                    exonintronratio: [],
                                                    umifrac: [],
                                                    allreads: [],
                                                    genes: [],
                                                    umis: []
                                                };

                                                for (let i = 0; i < rows.length; i++) {
                                                    const r = rows[i] || {};
                                                    const internalReads = getVal(r, ['internal_reads']);
                                                    const umiReads = getVal(r, ['umi_reads']);
                                                    const allReads = (internalReads || 0) + (umiReads || 0);

                                                    const exonReads = getVal(r, ['Exon_reads']);
                                                    const intronReads = getVal(r, ['intron_reads', 'Intron_reads']);
                                                    const intergenicReads = getVal(r, ['Intergenic_reads']);
                                                    const ambiguityReads = getVal(r, ['Ambiguity_reads']);
                                                    const unmappedReads = getVal(r, ['Unmapped_reads']);

                                                    const mapped = (exonReads || 0) + (intronReads || 0) + (intergenicReads || 0) + (ambiguityReads || 0);
                                                    const denom = mapped + (unmappedReads || 0);
                                                    const mappingRatio = denom > 0 ? mapped / denom : null;

                                                    const exonIntronRatio = safeDiv(exonReads, intronReads);
                                                    const umiFrac = allReads > 0 ? (umiReads || 0) / allReads : null;

                                                    const genes = getVal(r, ['Intron_Exon_genes', 'Exon_genes']);
                                                    const umis = getVal(r, ['Intron_Exon_umis', 'Exon_umis']);

                                                    if (mappingRatio !== null && Number.isFinite(mappingRatio)) arrays.mappingratio.push(mappingRatio);
                                                    if (exonIntronRatio !== null && Number.isFinite(exonIntronRatio)) arrays.exonintronratio.push(exonIntronRatio);
                                                    if (umiFrac !== null && Number.isFinite(umiFrac)) arrays.umifrac.push(umiFrac);
                                                    if (Number.isFinite(allReads) && allReads > 0) arrays.allreads.push(allReads);
                                                    if (genes !== null && Number.isFinite(genes) && genes > 0) arrays.genes.push(genes);
                                                    if (umis !== null && Number.isFinite(umis) && umis > 0) arrays.umis.push(umis);
                                                }

                                                const meta = {
                                                    mappingratio: { title: 'Distribution of: MappingRatio', xTitle: 'Mapping Ratio', xType: 'linear' },
                                                    exonintronratio: { title: 'Distribution of: ExonIntronRatio', xTitle: 'Exon/Intron Ratio', xType: 'linear' },
                                                    umifrac: { title: 'Distribution of: UMIfrac', xTitle: 'UMI Fraction', xType: 'linear' },
                                                    allreads: { title: 'Distribution of: AllReads', xTitle: 'All Reads', xType: 'log' },
                                                    genes: { title: 'Distribution of: Genes', xTitle: 'Genes', xType: 'log' },
                                                    umis: { title: 'Distribution of: UMIs', xTitle: 'UMIs', xType: 'log' }
                                                };

                                                const draw = (key) => {
                                                    const x = Array.isArray(arrays[key]) ? arrays[key] : [];
                                                    if (!x.length) {
                                                        el.innerHTML = '<div style="text-align: center; color: #6c757d; padding-top: 50px;">No available data</div>';
                                                        return;
                                                    }
                                                    const m = meta[key] || meta.mappingratio;
                                                    const trace = {
                                                        type: 'histogram',
                                                        x: x,
                                                        nbinsx: 120,
                                                        marker: { color: '#1a5084', line: { color: '#1a5084', width: 1 } },
                                                        hovertemplate: 'Value=%{x}<br>Count=%{y}<extra></extra>'
                                                    };
                                                    const layout = {
                                                        title: { text: m.title, font: { size: 12, color: '#2c3e50' } },
                                                        height: 360,
                                                        width: 400,
                                                        plot_bgcolor: 'rgba(0,0,0,0)',
                                                        paper_bgcolor: 'rgba(0,0,0,0)',
                                                        margin: { l: 40, r: 20, t: 36, b: 40 },
                                                        xaxis: {
                                                            title: { text: m.xTitle, font: { size: 12, color: '#2c3e50' } },
                                                            type: m.xType,
                                                            showgrid: false,
                                                            zeroline: false,
                                                            tickfont: { size: 10, color: '#2c3e50' }
                                                        },
                                                        yaxis: {
                                                            title: { text: 'Count', font: { size: 12, color: '#2c3e50' } },
                                                            showgrid: true,
                                                            gridcolor: 'rgba(0,0,0,0.1)',
                                                            zeroline: false,
                                                            tickfont: { size: 10, color: '#2c3e50' }
                                                        },
                                                        showlegend: false
                                                    };
                                                    Plotly.react('rna-histogram-plot', [trace], layout, { displayModeBar: false, responsive: true });
                                                };

                                                selectEl.addEventListener('change', function() {
                                                    draw(String(this.value || 'mappingratio'));
                                                });

                                                draw(String(selectEl.value || 'mappingratio'));
                                            })();
                                        </script>

</div>
</div>
<!-- Right side: Density -->
<div>
<div style="
                                        background: white;
                                        border-radius: 8px;
                                        padding: 15px;
                                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                                        height: 100%;
                                        display: flex;
                                        flex-direction: column;
                                        justify-content: center;
                                        align-items: center;
                                        min-height: 400px;
                                    ">
<div style="width: 100%; display: flex; justify-content: flex-end; align-items: center; gap: 10px; margin-bottom: 8px;">
<span style="color: #495057; font-size: 14px;">Metric</span>
<select id="rna-density-metric" style="padding: 6px 10px; border: 1px solid #dee2e6; border-radius: 4px; background: white; color: #495057; font-size: 14px; cursor: pointer;">
<option value="mappingratio">MappingRatio</option>
<option value="exonintronratio">ExonIntronRatio</option>
<option value="umifrac">UMIfrac</option>
<option value="umis">UMIs</option>
<option value="genes">Genes</option>
</select>
<span style="color: #495057; font-size: 14px;">X</span>
<select id="rna-density-xscale" style="padding: 6px 10px; border: 1px solid #dee2e6; border-radius: 4px; background: white; color: #495057; font-size: 14px; cursor: pointer;">
<option value="log" selected="">Log</option>
<option value="linear">Linear</option>
</select>
</div>
<div id="rna-density-plot" class="plot-placeholder" data-plot-id="rna-density-plot" style="width: 400px; height: 360px; margin: 0 auto;"></div>
<script id="script-rna-density-plot">
                                            (function() {
                                                const el = document.getElementById('rna-density-plot');
                                                const metricEl = document.getElementById('rna-density-metric');
                                                const xScaleEl = document.getElementById('rna-density-xscale');
                                                if (!el || !metricEl || !xScaleEl) return;
                                                if (typeof Plotly === 'undefined') {
                                                    el.innerHTML = '<div style="text-align:center;color:#e74c3c;padding-top:50px;">Plotly library failed to load</div>';
                                                    return;
                                                }

                                                const statsJson = '${rna_stats_table_data}';
                                                let rows = [];
                                                try {
                                                    const parsed = JSON.parse(statsJson);
                                                    rows = Array.isArray(parsed) ? parsed : [];
                                                } catch (e) {
                                                    rows = [];
                                                }

                                                const toNumber = (v) => {
                                                    if (v === null || v === undefined) return null;
                                                    if (typeof v === 'number') return Number.isFinite(v) ? v : null;
                                                    const s = String(v).trim();
                                                    if (!s) return null;
                                                    const n = Number(s.replace(/,/g, ''));
                                                    return Number.isFinite(n) ? n : null;
                                                };

                                                const safeDiv = (a, b) => {
                                                    const aa = toNumber(a);
                                                    const bb = toNumber(b);
                                                    if (aa === null || bb === null || bb === 0) return null;
                                                    return aa / bb;
                                                };

                                                const getVal = (r, keys) => {
                                                    for (let i = 0; i < keys.length; i++) {
                                                        const v = r ? r[keys[i]] : null;
                                                        const n = toNumber(v);
                                                        if (n !== null) return n;
                                                    }
                                                    return null;
                                                };

                                                const buildXY = () => {
                                                    const x = [];
                                                    const mappingratio = [];
                                                    const exonintronratio = [];
                                                    const umifrac = [];
                                                    const genes = [];
                                                    const umis = [];

                                                    for (let i = 0; i < rows.length; i++) {
                                                        const r = rows[i] || {};
                                                        const internalReads = getVal(r, ['internal_reads']);
                                                        const umiReads = getVal(r, ['umi_reads']);
                                                        const allReads = (internalReads || 0) + (umiReads || 0);
                                                        if (!Number.isFinite(allReads) || allReads <= 0) continue;

                                                        const exonReads = getVal(r, ['Exon_reads']);
                                                        const intronReads = getVal(r, ['intron_reads', 'Intron_reads']);
                                                        const intergenicReads = getVal(r, ['Intergenic_reads']);
                                                        const ambiguityReads = getVal(r, ['Ambiguity_reads']);
                                                        const unmappedReads = getVal(r, ['Unmapped_reads']);

                                                        const mapped = (exonReads || 0) + (intronReads || 0) + (intergenicReads || 0) + (ambiguityReads || 0);
                                                        const denom = mapped + (unmappedReads || 0);
                                                        const mr = denom > 0 ? mapped / denom : null;
                                                        const eir = safeDiv(exonReads, intronReads);
                                                        const uf = allReads > 0 ? (umiReads || 0) / allReads : null;

                                                        const g = getVal(r, ['Intron_Exon_genes', 'Exon_genes']);
                                                        const u = getVal(r, ['Intron_Exon_umis', 'Exon_umis']);

                                                        x.push(allReads);
                                                        mappingratio.push(mr);
                                                        exonintronratio.push(eir);
                                                        umifrac.push(uf);
                                                        genes.push(g);
                                                        umis.push(u);
                                                    }

                                                    return { x, mappingratio, exonintronratio, umifrac, genes, umis };
                                                };

                                                const data = buildXY();
                                                const meta = {
                                                    mappingratio: { title: 'Point Density Plot: MappingRatio', yTitle: 'Mapping Ratio' },
                                                    exonintronratio: { title: 'Point Density Plot: ExonIntronRatio', yTitle: 'Exon/Intron Ratio' },
                                                    umifrac: { title: 'Point Density Plot: UMIfrac', yTitle: 'UMI Fraction' },
                                                    umis: { title: 'Point Density Plot: UMIs', yTitle: 'UMIs' },
                                                    genes: { title: 'Point Density Plot: Genes', yTitle: 'Genes' }
                                                };

                                                const computeDensity = (xs, ys, xScale) => {
                                                    const pairs = [];
                                                    for (let i = 0; i < xs.length; i++) {
                                                        const x = xs[i];
                                                        const y = ys[i];
                                                        if (!Number.isFinite(x) || !Number.isFinite(y)) continue;
                                                        if (xScale === 'log' && x <= 0) continue;
                                                        const xx = (xScale === 'log') ? Math.log10(x) : x;
                                                        pairs.push({ xx, y });
                                                    }
                                                    if (!pairs.length) return [];

                                                    let minX = pairs[0].xx, maxX = pairs[0].xx, minY = pairs[0].y, maxY = pairs[0].y;
                                                    for (let i = 1; i < pairs.length; i++) {
                                                        const p = pairs[i];
                                                        if (p.xx < minX) minX = p.xx;
                                                        if (p.xx > maxX) maxX = p.xx;
                                                        if (p.y < minY) minY = p.y;
                                                        if (p.y > maxY) maxY = p.y;
                                                    }
                                                    if (minX === maxX) { minX -= 1; maxX += 1; }
                                                    if (minY === maxY) { minY -= 1; maxY += 1; }

                                                    const nx = 60;
                                                    const ny = 60;
                                                    const dx = (maxX - minX) / nx;
                                                    const dy = (maxY - minY) / ny;
                                                    const grid = new Array(nx * ny).fill(0);

                                                    const idx = (ix, iy) => (iy * nx + ix);
                                                    const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));

                                                    for (let i = 0; i < pairs.length; i++) {
                                                        const p = pairs[i];
                                                        const ix = clamp(Math.floor((p.xx - minX) / dx), 0, nx - 1);
                                                        const iy = clamp(Math.floor((p.y - minY) / dy), 0, ny - 1);
                                                        grid[idx(ix, iy)] += 1;
                                                    }

                                                    const z = [];
                                                    for (let i = 0; i < xs.length; i++) {
                                                        const x = xs[i];
                                                        const y = ys[i];
                                                        if (!Number.isFinite(x) || !Number.isFinite(y)) {
                                                            z.push(null);
                                                            continue;
                                                        }
                                                        if (xScale === 'log' && x <= 0) {
                                                            z.push(null);
                                                            continue;
                                                        }
                                                        const xx = (xScale === 'log') ? Math.log10(x) : x;
                                                        const ix = clamp(Math.floor((xx - minX) / dx), 0, nx - 1);
                                                        const iy = clamp(Math.floor((y - minY) / dy), 0, ny - 1);
                                                        z.push(grid[idx(ix, iy)]);
                                                    }
                                                    return z;
                                                };

                                                const draw = (metricKey, xScale) => {
                                                    const yArr = Array.isArray(data[metricKey]) ? data[metricKey] : [];
                                                    if (!data.x.length || !yArr.length) {
                                                        el.innerHTML = '<div style="text-align: center; color: #6c757d; padding-top: 50px;">No available data</div>';
                                                        return;
                                                    }
                                                    const z = computeDensity(data.x, yArr, xScale);
                                                    const m = meta[metricKey] || meta.mappingratio;
                                                    const trace = {
                                                        type: 'scatter',
                                                        mode: 'markers',
                                                        x: data.x,
                                                        y: yArr,
                                                        marker: { size: 5, color: z, colorscale: 'Viridis', showscale: false, opacity: 0.9 },
                                                        hovertemplate: 'AllReads=%{x}<br>Value=%{y}<extra></extra>'
                                                    };
                                                    const layout = {
                                                        title: { text: m.title, font: { size: 12, color: '#2c3e50' } },
                                                        height: 360,
                                                        width: 400,
                                                        plot_bgcolor: 'rgba(0,0,0,0)',
                                                        paper_bgcolor: 'rgba(0,0,0,0)',
                                                        margin: { l: 40, r: 20, t: 36, b: 40 },
                                                        xaxis: {
                                                            title: { text: 'All reads', font: { size: 12, color: '#2c3e50' } },
                                                            type: xScale === 'log' ? 'log' : 'linear',
                                                            showgrid: true,
                                                            gridcolor: 'rgba(0,0,0,0.08)',
                                                            zeroline: false,
                                                            tickfont: { size: 10, color: '#2c3e50' }
                                                        },
                                                        yaxis: {
                                                            title: { text: m.yTitle, font: { size: 12, color: '#2c3e50' } },
                                                            showgrid: true,
                                                            gridcolor: 'rgba(0,0,0,0.08)',
                                                            zeroline: false,
                                                            tickfont: { size: 10, color: '#2c3e50' }
                                                        },
                                                        showlegend: false
                                                    };
                                                    Plotly.react('rna-density-plot', [trace], layout, { displayModeBar: false, responsive: true });
                                                };

                                                const redraw = () => {
                                                    draw(String(metricEl.value || 'mappingratio'), String(xScaleEl.value || 'log'));
                                                };

                                                metricEl.addEventListener('change', redraw);
                                                xScaleEl.addEventListener('change', redraw);

                                                redraw();
                                            })();
                                        </script>
</div>
</div>
</div>
</section>
<script>
                            const rnaBeadsToggle = document.getElementById('toggle-rna-beads-explanation');
                            if (rnaBeadsToggle) {
                                rnaBeadsToggle.addEventListener('click', function() {
                                    const explanation = document.getElementById('rna-beads-explanation');
                                    if (!explanation) return;
                                    if (explanation.style.display === 'none' || explanation.style.display === '') {
                                        explanation.style.display = 'block';
                                    } else {
                                        explanation.style.display = 'none';
                                    }
                                });
                            }
                        </script>

<section class="section-card" data-library-content="gene-expression" id="plate-384-card">
<h3 class="tooltip" data-tooltip="384-well plate QC plot (auto samples only)">384-Well Plate
</h3>
<div style="
                                        background: white;
                                        border-radius: 8px;
                                        padding: 15px;
                                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                                        height: 100%;
                                        display: flex;
                                        flex-direction: column;
                                        justify-content: center;
                                        align-items: center;
                                        min-height: 460px;
                                    ">
<div style="width: 100%; display: flex; justify-content: space-between; align-items: center; gap: 10px; margin-bottom: 10px;">
<div style="display: flex; align-items: center; gap: 8px;">
<span style="color: #495057; font-size: 14px;">Plate</span>
<select id="plate384-plate-select" style="padding: 6px 10px; border: 1px solid #dee2e6; border-radius: 4px; background: white; color: #495057; font-size: 14px; cursor: pointer;"></select>
</div>
<div style="display: flex; align-items: center; gap: 8px;">
<span style="color: #495057; font-size: 14px;">Metric</span>
<select id="plate384-metric-select" style="padding: 6px 10px; border: 1px solid #dee2e6; border-radius: 4px; background: white; color: #495057; font-size: 14px; cursor: pointer;">
<option value="mappingratio">MappingRatio</option>
<option value="exonintronratio">ExonIntronRatio</option>
<option value="umifrac">UMIfrac</option>
<option value="allreads">AllReads</option>
<option value="genes">Genes</option>
<option value="umis">UMIs</option>
</select>
</div>
</div>
<div id="plate-384-plot" class="plot-placeholder" data-plot-id="plate-384-plot" style="width: 900px; height: 420px;"></div>
<script id="script-plate-384-plot">
                                            (function() {
                                                const cardEl = document.getElementById('plate-384-card');
                                                const plotEl = document.getElementById('plate-384-plot');
                                                const plateSelect = document.getElementById('plate384-plate-select');
                                                const metricSelect = document.getElementById('plate384-metric-select');
                                                if (!cardEl || !plotEl || !plateSelect || !metricSelect) return;

                                                const sampleType = String('${sample_type}' || '').trim().toLowerCase();
                                                if (sampleType !== 'auto') {
                                                    cardEl.parentNode && cardEl.parentNode.removeChild(cardEl);
                                                    return;
                                                }

                                                if (typeof Plotly === 'undefined') {
                                                    plotEl.innerHTML = '<div style="text-align:center;color:#e74c3c;padding-top:50px;">Plotly library failed to load</div>';
                                                    return;
                                                }

                                                const statsJson = '${rna_stats_table_data}';
                                                let rows = [];
                                                try {
                                                    const parsed = JSON.parse(statsJson);
                                                    rows = Array.isArray(parsed) ? parsed : [];
                                                } catch (e) {
                                                    rows = [];
                                                }

                                                const toNumber = (v) => {
                                                    if (v === null || v === undefined) return null;
                                                    if (typeof v === 'number') return Number.isFinite(v) ? v : null;
                                                    const s = String(v).trim();
                                                    if (!s) return null;
                                                    const n = Number(s.replace(/,/g, ''));
                                                    return Number.isFinite(n) ? n : null;
                                                };

                                                const getVal = (r, keys) => {
                                                    for (let i = 0; i < keys.length; i++) {
                                                        const v = r ? r[keys[i]] : null;
                                                        const n = toNumber(v);
                                                        if (n !== null) return n;
                                                    }
                                                    return null;
                                                };

                                                const parsedWells = [];
                                                for (let i = 0; i < rows.length; i++) {
                                                    const wellID = String((rows[i] || {}).wellID || '').trim();
                                                    const m = wellID.match(/^P(\\d+)([A-P])(\\d+)$/);
                                                    if (!m) continue;
                                                    const plate = m[1];
                                                    const row = m[2];
                                                    const col = Number(m[3]);
                                                    if (!Number.isFinite(col)) continue;

                                                    const internalReads = getVal(rows[i], ['internal_reads']) || 0;
                                                    const umiReads = getVal(rows[i], ['umi_reads']) || 0;
                                                    const allReads = internalReads + umiReads;

                                                    const exonReads = getVal(rows[i], ['Exon_reads']) || 0;
                                                    const intronReads = getVal(rows[i], ['intron_reads', 'Intron_reads']) || 0;
                                                    const intergenicReads = getVal(rows[i], ['Intergenic_reads']) || 0;
                                                    const ambiguityReads = getVal(rows[i], ['Ambiguity_reads']) || 0;
                                                    const unmappedReads = getVal(rows[i], ['Unmapped_reads']) || 0;
                                                    const mapped = exonReads + intronReads + intergenicReads + ambiguityReads;
                                                    const denom = mapped + unmappedReads;
                                                    const mappingratio = denom > 0 ? mapped / denom : null;
                                                    const exonintronratio = intronReads > 0 ? exonReads / intronReads : null;
                                                    const umifrac = allReads > 0 ? umiReads / allReads : null;

                                                    const genes = getVal(rows[i], ['Intron_Exon_genes', 'Exon_genes']);
                                                    const umis = getVal(rows[i], ['Intron_Exon_umis', 'Exon_umis']);

                                                    parsedWells.push({
                                                        plate,
                                                        row,
                                                        col,
                                                        wellID,
                                                        mappingratio,
                                                        exonintronratio,
                                                        umifrac,
                                                        allreads: allReads,
                                                        genes,
                                                        umis
                                                    });
                                                }

                                                const plates = Array.from(new Set(parsedWells.map(w => w.plate))).sort((a, b) => Number(a) - Number(b));
                                                if (!plates.length) {
                                                    plotEl.innerHTML = '<div style="text-align: center; color: #6c757d; padding-top: 50px;">No available data</div>';
                                                    return;
                                                }

                                                plateSelect.innerHTML = '';
                                                for (let i = 0; i < plates.length; i++) {
                                                    const opt = document.createElement('option');
                                                    opt.value = plates[i];
                                                    opt.textContent = plates[i];
                                                    plateSelect.appendChild(opt);
                                                }

                                                const yOrder = [];
                                                for (let c = 'P'.charCodeAt(0); c >= 'A'.charCodeAt(0); c--) yOrder.push(String.fromCharCode(c));

                                                const draw = () => {
                                                    const plate = String(plateSelect.value || plates[0]);
                                                    const metric = String(metricSelect.value || 'mappingratio');
                                                    const wells = parsedWells.filter(w => w.plate === plate);
                                                    if (!wells.length) {
                                                        plotEl.innerHTML = '<div style="text-align: center; color: #6c757d; padding-top: 50px;">No available data</div>';
                                                        return;
                                                    }

                                                    const x = wells.map(w => w.col);
                                                    const y = wells.map(w => w.row);
                                                    const c = wells.map(w => {
                                                        const v = w[metric];
                                                        return (v !== null && v !== undefined && Number.isFinite(v)) ? v : null;
                                                    });
                                                    const text = wells.map(w => w.wellID);

                                                    const titleMap = {
                                                        mappingratio: 'MappingRatio',
                                                        exonintronratio: 'ExonIntronRatio',
                                                        umifrac: 'UMIfrac',
                                                        allreads: 'AllReads',
                                                        genes: 'Genes',
                                                        umis: 'UMIs'
                                                    };
                                                    const titleMetric = titleMap[metric] || metric;

                                                    const trace = {
                                                        type: 'scatter',
                                                        mode: 'markers',
                                                        x: x,
                                                        y: y,
                                                        text: text,
                                                        marker: {
                                                            size: 20,
                                                            color: c,
                                                            colorscale: 'Viridis',
                                                            showscale: true,
                                                            colorbar: { title: '' },
                                                            line: { width: 1, color: 'DarkSlateGrey' }
                                                        },
                                                        hovertemplate: '<b>%{text}</b><br>Col=%{x}<br>Row=%{y}<br>Value=%{marker.color}<extra></extra>'
                                                    };

                                                    const layout = {
                                                        title: { text: `384-Well Plate Plot: ${titleMetric} (Plate: ${plate})`, font: { size: 12, color: '#2c3e50' } },
                                                        height: 420,
                                                        width: 900,
                                                        plot_bgcolor: 'rgba(0,0,0,0)',
                                                        paper_bgcolor: 'rgba(0,0,0,0)',
                                                        margin: { l: 40, r: 40, t: 40, b: 40 },
                                                        xaxis: { title: 'Column', dtick: 1, tick0: 1, showgrid: false, zeroline: false },
                                                        yaxis: { title: 'Row', categoryorder: 'array', categoryarray: yOrder, autorange: false },
                                                        showlegend: false
                                                    };

                                                    Plotly.react('plate-384-plot', [trace], layout, { displayModeBar: false, responsive: true });
                                                };

                                                plateSelect.addEventListener('change', draw);
                                                metricSelect.addEventListener('change', draw);
                                                draw();
                                            })();
                                        </script>
</div>
</section>
</div>

</div>
<!-- Library Tab -->
<div class="tab-pane" id="library-tab" style="padding-top: 0;">
<!-- Library Type Selector removed; using global selector above -->
<!-- Rewritten to match UMI-based layout -->
<section class="section-card" data-library-content="gene-expression">
<h3 class="tooltip" data-tooltip="Key quality metrics for the single-cell RNA sequencing sample">RNA Quality Metrics
                                <button id="toggle-library-cells-explanation" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(59, 130, 246, 0.3)'; this.style.background='#3b82f6'" onmouseover="this.style.transform='scale(1.1)'; this.style.boxShadow='0 4px 12px rgba(59, 130, 246, 0.4)'; this.style.background='#2563eb'" style="
                                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                    color: white;
                                    border: none;
                                    border-radius: 50%;
                                    width: 28px;
                                    height: 28px;
                                    font-size: 14px;
                                    font-weight: bold;
                                    cursor: pointer;
                                    margin-left: 15px;
                                    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);                                   
                                    display: inline-flex;
                                    align-items: center;
                                    justify-content: center;
                                ">?</button>
</h3>
<div id="library-cells-explanation" style="
                                display: none; 
                                margin-top: 15px; 
                                padding: 20px; 
                                background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
                                border: none;
                                border-radius: 12px;
                                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
                                
                            ">
<h4 style="
                                    color: #2c3e50;
                                    margin-bottom: 15px;
                                    font-size: 1.1em;
                                    border-bottom: 2px solid #3498db;
                                    padding-bottom: 8px;
                                    display: inline-block;
                                ">Cell Quality Metrics Explanation</h4>
<ul style="
                                    list-style: none;
                                    padding: 0;
                                    margin: 0;
                                ">
<li style="
                                        margin-bottom: 12px;
                                        padding: 12px;
                                        background: rgba(255, 255, 255, 0.8);
                                        border-radius: 8px;
                                        border-left: 4px solid #e74c3c;
                                        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                                    "><strong style="color: #C0392B;">Mean reads per cell:</strong> The average number of raw sequencing reads per cell, calculated by dividing the total raw reads by the number of identified cells.</li>
<li style="
                                        margin-bottom: 12px;
                                        padding: 12px;
                                        background: rgba(255, 255, 255, 0.8);
                                        border-radius: 8px;
                                        border-left: 4px solid #27AE60;
                                        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                                    "><strong style="color: #229954;">UMI counts per cell:</strong>  The number of unique transcript molecules captured per cell after UMI deduplication. Both mean and median values shown.</li>
<li style="
                                        margin-bottom: 12px;
                                        padding: 12px;
                                        background: rgba(255, 255, 255, 0.8);
                                        border-radius: 8px;
                                        border-left: 4px solid #f39c12;
                                        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                                    "><strong style="color: #e67e22;">Total genes detected:</strong> The total number of distinct genes detected across all cells in the dataset. This serves as an indicator of the biological diversity and overall sensitivity of the experiment.</li>
<li style="
                                        margin-bottom: 12px;
                                        padding: 12px;
                                        background: rgba(255, 255, 255, 0.8);
                                        border-radius: 8px;
                                        border-left: 4px solid #9b59b6;
                                        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                                    "><strong style="color: #8e44ad;">Genes per cell:</strong> Number of detected genes reflects cell viability and transcriptional complexity. Both mean and median values shown.</li>
<li style="
                                        margin-bottom: 12px;
                                        padding: 12px;
                                        background: rgba(255, 255, 255, 0.8);
                                        border-radius: 8px;
                                        border-left: 4px solid #34495e;
                                        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                                    "><strong style="color: #2c3e50;">Fraction reads in cells:</strong> The proportion of reads that are uniquely mapped to the transcriptome and associated with a valid cell barcode, indicating the efficiency of cell capture.</li>
<li style="
                                        margin-bottom: 0;
                                        padding: 12px;
                                        background: rgba(255, 255, 255, 0.8);
                                        border-radius: 8px;
                                        border-left: 4px solid #6366F1;
                                        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                                    "><strong style="color: #1D4ED8;">Gene and UMI Counts by Type:</strong> Boxplots show per-cell distributions by feature type.</li>
</ul>
</div>
<div class="responsive-two-col-grid">
<div>
<div class="stats-table-container" style="overflow-x: auto;">
<table style="
                                            width: 100%;
                                            border-collapse: collapse;
                                            background: white;
                                            border-radius: 8px;
                                            overflow: hidden;
                                            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                                        ">
<tbody>
<tr style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
<td style="padding: 12px 15px; font-weight: 600; color: #2c3e50; border-bottom: 1px solid #dee2e6;">Mean reads per cell</td>
<td style="padding: 12px 15px; color: #495057; border-bottom: 1px solid #dee2e6; font-weight: 600; text-align: right;">${rna_mean_reads_percell}</td>
</tr>
<tr style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
<td style="padding: 12px 15px; font-weight: 600; color: #2c3e50; border-bottom: 1px solid #dee2e6;">Mean Read counts per cell</td>
<td style="padding: 12px 15px; color: #495057; border-bottom: 1px solid #dee2e6; font-weight: 600; text-align: right;">${rna_mean_umis_percell}</td>
</tr>
<tr style="background: white;">
<td style="padding: 12px 15px; font-weight: 600; color: #2c3e50; border-bottom: 1px solid #dee2e6;">Median Read counts per cell</td>
<td style="padding: 12px 15px; color: #495057; border-bottom: 1px solid #dee2e6; font-weight: 600; text-align: right;">${rna_median_umis_percell}</td>
</tr>
<tr style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
<td style="padding: 12px 15px; font-weight: 600; color: #2c3e50; border-bottom: 1px solid #dee2e6;">Total genes detected</td>
<td style="padding: 12px 15px; color: #495057; border-bottom: 1px solid #dee2e6; font-weight: 600; text-align: right;">${rna_total_gene}</td>
</tr>
<tr style="background: white;">
<td style="padding: 12px 15px; font-weight: 600; color: #2c3e50; border-bottom: 1px solid #dee2e6;">Mean Genes per cell</td>
<td style="padding: 12px 15px; color: #495057; border-bottom: 1px solid #dee2e6; font-weight: 600; text-align: right;">${rna_mean_genes_percell}</td>
</tr>
<tr style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
<td style="padding: 12px 15px; font-weight: 600; color: #2c3e50; border-bottom: 1px solid #dee2e6;">Median Genes per cell</td>
<td style="padding: 12px 15px; color: #495057; border-bottom: 1px solid #dee2e6; font-weight: 600; text-align: right;">${rna_median_genes_percell}</td>
</tr>
</tbody>
</table>
</div>
</div>
<div>
<div style="
        background: white;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        min-height: 300px;
    ">
<h4 style="color: #2c3e50; margin-bottom: 8px; text-align: center;">Gene and UMI Counts by Type</h4>
                                        <div id="gene-umi-counts-by-type-read" class="plot-placeholder" data-plot-id="gene-umi-counts-by-type-read" style="width: 430px; height: 300px;"></div>
                                        <script id="script-gene-umi-counts-by-type-read">
                                            (function() {
                                                const targetId = 'gene-umi-counts-by-type-read';
                                                const target = document.getElementById(targetId);
                                                if (!target || !window.Plotly) return;

                                                const statsJson = '${rna_stats_table_data}';
                                                let records = [];
                                                try {
                                                    const parsed = JSON.parse(statsJson);
                                                    records = Array.isArray(parsed) ? parsed : [];
                                                } catch (e) {
                                                    records = [];
                                                }

                                                const toNumber = (v) => {
                                                    if (v === null || v === undefined) return null;
                                                    if (typeof v === 'number') return Number.isFinite(v) ? v : null;
                                                    const s = String(v).trim();
                                                    if (!s) return null;
                                                    const n = Number(s.replace(/,/g, ''));
                                                    return Number.isFinite(n) ? n : null;
                                                };

                                                const types = [
                                                    { label: 'Exon', geneKey: 'Exon_genes', umiKey: 'Exon_umis', color: '#1A5084' },
                                                    { label: 'Intron+Exon', geneKey: 'Intron_Exon_genes', umiKey: 'Intron_Exon_umis', color: '#914614' },
                                                    { label: 'Intron', geneKey: 'Intron_genes', umiKey: 'Intron_umis', color: '#118730' }
                                                ];

                                                const geneTraces = types.map(t => {
                                                    const ys = records
                                                        .map(r => toNumber(r ? r[t.geneKey] : null))
                                                        .filter(v => v !== null);
                                                    return {
                                                        type: 'box',
                                                        x: Array(ys.length).fill(t.label),
                                                        y: ys,
                                                        marker: { color: t.color },
                                                        line: { color: t.color, width: 1 },
                                                        boxpoints: false,
                                                        boxmean: true,
                                                        xaxis: 'x',
                                                        yaxis: 'y',
                                                        hovertemplate: '%{y}<extra></extra>',
                                                        name: t.label
                                                    };
                                                });

                                                const umiTraces = types.map(t => {
                                                    const ys = records
                                                        .map(r => toNumber(r ? r[t.umiKey] : null))
                                                        .filter(v => v !== null);
                                                    return {
                                                        type: 'box',
                                                        x: Array(ys.length).fill(t.label),
                                                        y: ys,
                                                        marker: { color: t.color },
                                                        line: { color: t.color, width: 1 },
                                                        boxpoints: false,
                                                        boxmean: true,
                                                        xaxis: 'x2',
                                                        yaxis: 'y2',
                                                        hovertemplate: '%{y}<extra></extra>',
                                                        name: t.label
                                                    };
                                                });

                                                const anyGene = geneTraces.some(t => (t.y || []).length > 0);
                                                const anyUmi = umiTraces.some(t => (t.y || []).length > 0);
                                                if (!anyGene && !anyUmi) {
                                                    target.innerHTML = '<div style="color:#6c757d;">No available data</div>';
                                                    return;
                                                }

                                                const layout = {
                                                    grid: { rows: 1, columns: 2, pattern: 'independent' },
                                                    boxmode: 'group',
                                                    margin: { l: 45, r: 15, t: 40, b: 35 },
                                                    height: 300,
                                                    paper_bgcolor: 'white',
                                                    plot_bgcolor: 'white',
                                                    showlegend: false,
                                                    xaxis: { title: '', tickfont: { size: 11, color: '#2c3e50' } },
                                                    yaxis: { title: { text: 'Genes', font: { size: 12, color: '#2c3e50' } }, gridcolor: 'rgba(0,0,0,0.1)' },
                                                    xaxis2: { title: '', tickfont: { size: 11, color: '#2c3e50' } },
                                                    yaxis2: { title: { text: 'UMIs', font: { size: 12, color: '#2c3e50' } }, gridcolor: 'rgba(0,0,0,0.1)' },
                                                    annotations: [
                                                        { text: 'Number of Genes', x: 0.23, y: 1.12, xref: 'paper', yref: 'paper', showarrow: false, font: { size: 12, color: '#2c3e50' } },
                                                        { text: 'Number of UMIs', x: 0.77, y: 1.12, xref: 'paper', yref: 'paper', showarrow: false, font: { size: 12, color: '#2c3e50' } }
                                                    ]
                                                };

                                                Plotly.newPlot(targetId, [...geneTraces, ...umiTraces], layout, {
                                                    displayModeBar: false,
                                                    displaylogo: false,
                                                    responsive: true
                                                });
                                            })();
                                        </script>
                                    </div>
                                </div>
</div>
<script>
                            const libraryCellsToggle = document.getElementById('toggle-library-cells-explanation');
                            if (libraryCellsToggle) {
                                libraryCellsToggle.addEventListener('click', function() {
                                    const explanationDiv = document.getElementById('library-cells-explanation');
                                    if (!explanationDiv) return;
                                    if (explanationDiv.style.display === 'none' || explanationDiv.style.display === '') {
                                        explanationDiv.style.display = 'block';
                                    } else {
                                        explanationDiv.style.display = 'none';
                                    }
                                });
                            }
                        </script>
</section>

<section class="section-card" data-library-content="gene-expression">
<h3 class="tooltip" data-tooltip="Analysis of bead-to-cell mapping and barcode rank distribution for RNA">RNA Beads to Cells
                                <button id="toggle-rna-beads-explanation-read" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(59, 130, 246, 0.3)'; this.style.background='#3b82f6'" onmouseover="this.style.transform='scale(1.1)'; this.style.boxShadow='0 4px 12px rgba(59, 130, 246, 0.4)'; this.style.background='#2563eb'" style="
                                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                    color: white;
                                    border: none;
                                    border-radius: 50%;
                                    width: 28px;
                                    height: 28px;
                                    font-size: 14px;
                                    font-weight: bold;
                                    cursor: pointer;
                                    margin-left: 15px;
                                    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);                                    
                                    display: inline-flex;
                                    align-items: center;
                                    justify-content: center;
                                ">?</button>
</h3>
<div id="rna-beads-explanation-read" style="
                                display: none; 
                                margin-top: 15px; 
                                padding: 20px; 
                                background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
                                border: none;
                                border-radius: 12px;
                                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
                                
                            ">
<h4 style="
                                    color: #2c3e50;
                                    margin-bottom: 15px;
                                    font-size: 1.1em;
                                    border-bottom: 2px solid #3498db;
                                    padding-bottom: 8px;
                                    display: inline-block;
                                ">RNA Beads to Cells Analysis Explanation</h4>
<ul style="
                                    list-style: none;
                                    padding: 0;
                                    margin: 0;
                                ">
<li style="
                                        margin-bottom: 12px;
                                        padding: 12px;
                                        background: rgba(255, 255, 255, 0.8);
                                        border-radius: 8px;
                                        border-left: 4px solid #3498db;
                                        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                                    "><strong style="color: #2980b9;">Histogram (left):</strong> Distribution of selected metrics across wells/cells.</li>
<li style="
                                        margin-bottom: 0;
                                        padding: 12px;
                                        background: rgba(255, 255, 255, 0.8);
                                        border-radius: 8px;
                                        border-left: 4px solid #e74c3c;
                                        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                                    "><strong style="color: #c0392b;">Point Density (right):</strong> Density of points for AllReads vs selected metric.</li>
</ul>
</div>
<div class="responsive-two-col-grid">
<div>
<div style="
                                        background: white;
                                        border-radius: 8px;
                                        padding: 15px;
                                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                                        height: 100%;
                                        display: flex;
                                        flex-direction: column;
                                        justify-content: center;
                                        align-items: center;
                                        min-height: 400px;
                                    ">
<div style="width: 100%; display: flex; justify-content: flex-end; align-items: center; gap: 10px; margin-bottom: 8px;">
<span style="color: #495057; font-size: 14px;">Metric</span>
<select id="rna-hist-metric-read" style="padding: 6px 10px; border: 1px solid #dee2e6; border-radius: 4px; background: white; color: #495057; font-size: 14px; cursor: pointer;">
<option value="mappingratio">MappingRatio</option>
<option value="exonintronratio">ExonIntronRatio</option>
<option value="umifrac">UMIfrac</option>
<option value="allreads">AllReads</option>
<option value="genes">Genes</option>
<option value="umis">UMIs</option>
</select>
</div>
<div id="rna-histogram-plot-read" class="plot-placeholder" data-plot-id="rna-histogram-plot-read" style="width: 400px; height: 360px; margin: 0 auto;"></div>
<script id="script-rna-histogram-plot-read">
                                            (function() {
                                                const el = document.getElementById('rna-histogram-plot-read');
                                                const selectEl = document.getElementById('rna-hist-metric-read');
                                                if (!el || !selectEl) return;
                                                if (typeof Plotly === 'undefined') {
                                                    el.innerHTML = '<div style="text-align:center;color:#e74c3c;padding-top:50px;">Plotly library failed to load</div>';
                                                    return;
                                                }

                                                const statsJson = '${rna_stats_table_data}';
                                                let rows = [];
                                                try {
                                                    const parsed = JSON.parse(statsJson);
                                                    rows = Array.isArray(parsed) ? parsed : [];
                                                } catch (e) {
                                                    rows = [];
                                                }

                                                const toNumber = (v) => {
                                                    if (v === null || v === undefined) return null;
                                                    if (typeof v === 'number') return Number.isFinite(v) ? v : null;
                                                    const s = String(v).trim();
                                                    if (!s) return null;
                                                    const n = Number(s.replace(/,/g, ''));
                                                    return Number.isFinite(n) ? n : null;
                                                };

                                                const safeDiv = (a, b) => {
                                                    const aa = toNumber(a);
                                                    const bb = toNumber(b);
                                                    if (aa === null || bb === null || bb === 0) return null;
                                                    return aa / bb;
                                                };

                                                const getVal = (r, keys) => {
                                                    for (let i = 0; i < keys.length; i++) {
                                                        const v = r ? r[keys[i]] : null;
                                                        const n = toNumber(v);
                                                        if (n !== null) return n;
                                                    }
                                                    return null;
                                                };

                                                const arrays = { mappingratio: [], exonintronratio: [], umifrac: [], allreads: [], genes: [], umis: [] };
                                                for (let i = 0; i < rows.length; i++) {
                                                    const r = rows[i] || {};
                                                    const internalReads = getVal(r, ['internal_reads']);
                                                    const umiReads = getVal(r, ['umi_reads']);
                                                    const allReads = (internalReads || 0) + (umiReads || 0);

                                                    const exonReads = getVal(r, ['Exon_reads']);
                                                    const intronReads = getVal(r, ['intron_reads', 'Intron_reads']);
                                                    const intergenicReads = getVal(r, ['Intergenic_reads']);
                                                    const ambiguityReads = getVal(r, ['Ambiguity_reads']);
                                                    const unmappedReads = getVal(r, ['Unmapped_reads']);

                                                    const mapped = (exonReads || 0) + (intronReads || 0) + (intergenicReads || 0) + (ambiguityReads || 0);
                                                    const denom = mapped + (unmappedReads || 0);
                                                    const mappingRatio = denom > 0 ? mapped / denom : null;

                                                    const exonIntronRatio = safeDiv(exonReads, intronReads);
                                                    const umiFrac = allReads > 0 ? (umiReads || 0) / allReads : null;

                                                    const genes = getVal(r, ['Intron_Exon_genes', 'Exon_genes']);
                                                    const umis = getVal(r, ['Intron_Exon_umis', 'Exon_umis']);

                                                    if (mappingRatio !== null && Number.isFinite(mappingRatio)) arrays.mappingratio.push(mappingRatio);
                                                    if (exonIntronRatio !== null && Number.isFinite(exonIntronRatio)) arrays.exonintronratio.push(exonIntronRatio);
                                                    if (umiFrac !== null && Number.isFinite(umiFrac)) arrays.umifrac.push(umiFrac);
                                                    if (Number.isFinite(allReads) && allReads > 0) arrays.allreads.push(allReads);
                                                    if (genes !== null && Number.isFinite(genes) && genes > 0) arrays.genes.push(genes);
                                                    if (umis !== null && Number.isFinite(umis) && umis > 0) arrays.umis.push(umis);
                                                }

                                                const meta = {
                                                    mappingratio: { title: 'Distribution of: MappingRatio', xTitle: 'Mapping Ratio', xType: 'linear' },
                                                    exonintronratio: { title: 'Distribution of: ExonIntronRatio', xTitle: 'Exon/Intron Ratio', xType: 'linear' },
                                                    umifrac: { title: 'Distribution of: UMIfrac', xTitle: 'UMI Fraction', xType: 'linear' },
                                                    allreads: { title: 'Distribution of: AllReads', xTitle: 'All Reads', xType: 'log' },
                                                    genes: { title: 'Distribution of: Genes', xTitle: 'Genes', xType: 'log' },
                                                    umis: { title: 'Distribution of: UMIs', xTitle: 'UMIs', xType: 'log' }
                                                };

                                                const draw = (key) => {
                                                    const x = Array.isArray(arrays[key]) ? arrays[key] : [];
                                                    if (!x.length) {
                                                        el.innerHTML = '<div style="text-align: center; color: #6c757d; padding-top: 50px;">No available data</div>';
                                                        return;
                                                    }
                                                    const m = meta[key] || meta.mappingratio;
                                                    const trace = { type: 'histogram', x: x, nbinsx: 120, marker: { color: '#1a5084', line: { color: '#1a5084', width: 1 } }, hovertemplate: 'Value=%{x}<br>Count=%{y}<extra></extra>' };
                                                    const layout = {
                                                        title: { text: m.title, font: { size: 12, color: '#2c3e50' } },
                                                        height: 360,
                                                        width: 400,
                                                        plot_bgcolor: 'rgba(0,0,0,0)',
                                                        paper_bgcolor: 'rgba(0,0,0,0)',
                                                        margin: { l: 40, r: 20, t: 36, b: 40 },
                                                        xaxis: { title: { text: m.xTitle, font: { size: 12, color: '#2c3e50' } }, type: m.xType, showgrid: false, zeroline: false, tickfont: { size: 10, color: '#2c3e50' } },
                                                        yaxis: { title: { text: 'Count', font: { size: 12, color: '#2c3e50' } }, showgrid: true, gridcolor: 'rgba(0,0,0,0.1)', zeroline: false, tickfont: { size: 10, color: '#2c3e50' } },
                                                        showlegend: false
                                                    };
                                                    Plotly.react('rna-histogram-plot-read', [trace], layout, { displayModeBar: false, responsive: true });
                                                };

                                                selectEl.addEventListener('change', function() { draw(String(this.value || 'mappingratio')); });
                                                draw(String(selectEl.value || 'mappingratio'));
                                            })();
                                        </script>
</div>
</div>
<div>
<div style="
                                        background: white;
                                        border-radius: 8px;
                                        padding: 15px;
                                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                                        height: 100%;
                                        display: flex;
                                        flex-direction: column;
                                        justify-content: center;
                                        align-items: center;
                                        min-height: 400px;
                                    ">
<div style="width: 100%; display: flex; justify-content: flex-end; align-items: center; gap: 10px; margin-bottom: 8px;">
<span style="color: #495057; font-size: 14px;">Metric</span>
<select id="rna-density-metric-read" style="padding: 6px 10px; border: 1px solid #dee2e6; border-radius: 4px; background: white; color: #495057; font-size: 14px; cursor: pointer;">
<option value="mappingratio">MappingRatio</option>
<option value="exonintronratio">ExonIntronRatio</option>
<option value="umifrac">UMIfrac</option>
<option value="umis">UMIs</option>
<option value="genes">Genes</option>
</select>
<span style="color: #495057; font-size: 14px;">X</span>
<select id="rna-density-xscale-read" style="padding: 6px 10px; border: 1px solid #dee2e6; border-radius: 4px; background: white; color: #495057; font-size: 14px; cursor: pointer;">
<option value="log" selected="">Log</option>
<option value="linear">Linear</option>
</select>
</div>
<div id="rna-density-plot-read" class="plot-placeholder" data-plot-id="rna-density-plot-read" style="width: 400px; height: 360px; margin: 0 auto;"></div>
<script id="script-rna-density-plot-read">
                                            (function() {
                                                const el = document.getElementById('rna-density-plot-read');
                                                const metricEl = document.getElementById('rna-density-metric-read');
                                                const xScaleEl = document.getElementById('rna-density-xscale-read');
                                                if (!el || !metricEl || !xScaleEl) return;
                                                if (typeof Plotly === 'undefined') {
                                                    el.innerHTML = '<div style="text-align:center;color:#e74c3c;padding-top:50px;">Plotly library failed to load</div>';
                                                    return;
                                                }

                                                const statsJson = '${rna_stats_table_data}';
                                                let rows = [];
                                                try {
                                                    const parsed = JSON.parse(statsJson);
                                                    rows = Array.isArray(parsed) ? parsed : [];
                                                } catch (e) {
                                                    rows = [];
                                                }

                                                const toNumber = (v) => {
                                                    if (v === null || v === undefined) return null;
                                                    if (typeof v === 'number') return Number.isFinite(v) ? v : null;
                                                    const s = String(v).trim();
                                                    if (!s) return null;
                                                    const n = Number(s.replace(/,/g, ''));
                                                    return Number.isFinite(n) ? n : null;
                                                };

                                                const safeDiv = (a, b) => {
                                                    const aa = toNumber(a);
                                                    const bb = toNumber(b);
                                                    if (aa === null || bb === null || bb === 0) return null;
                                                    return aa / bb;
                                                };

                                                const getVal = (r, keys) => {
                                                    for (let i = 0; i < keys.length; i++) {
                                                        const v = r ? r[keys[i]] : null;
                                                        const n = toNumber(v);
                                                        if (n !== null) return n;
                                                    }
                                                    return null;
                                                };

                                                const buildXY = () => {
                                                    const x = [];
                                                    const mappingratio = [];
                                                    const exonintronratio = [];
                                                    const umifrac = [];
                                                    const genes = [];
                                                    const umis = [];

                                                    for (let i = 0; i < rows.length; i++) {
                                                        const r = rows[i] || {};
                                                        const internalReads = getVal(r, ['internal_reads']);
                                                        const umiReads = getVal(r, ['umi_reads']);
                                                        const allReads = (internalReads || 0) + (umiReads || 0);
                                                        if (!Number.isFinite(allReads) || allReads <= 0) continue;

                                                        const exonReads = getVal(r, ['Exon_reads']);
                                                        const intronReads = getVal(r, ['intron_reads', 'Intron_reads']);
                                                        const intergenicReads = getVal(r, ['Intergenic_reads']);
                                                        const ambiguityReads = getVal(r, ['Ambiguity_reads']);
                                                        const unmappedReads = getVal(r, ['Unmapped_reads']);

                                                        const mapped = (exonReads || 0) + (intronReads || 0) + (intergenicReads || 0) + (ambiguityReads || 0);
                                                        const denom = mapped + (unmappedReads || 0);
                                                        const mr = denom > 0 ? mapped / denom : null;
                                                        const eir = safeDiv(exonReads, intronReads);
                                                        const uf = allReads > 0 ? (umiReads || 0) / allReads : null;

                                                        const g = getVal(r, ['Intron_Exon_genes', 'Exon_genes']);
                                                        const u = getVal(r, ['Intron_Exon_umis', 'Exon_umis']);

                                                        x.push(allReads);
                                                        mappingratio.push(mr);
                                                        exonintronratio.push(eir);
                                                        umifrac.push(uf);
                                                        genes.push(g);
                                                        umis.push(u);
                                                    }

                                                    return { x, mappingratio, exonintronratio, umifrac, genes, umis };
                                                };

                                                const data = buildXY();
                                                const meta = {
                                                    mappingratio: { title: 'Point Density Plot: MappingRatio', yTitle: 'Mapping Ratio' },
                                                    exonintronratio: { title: 'Point Density Plot: ExonIntronRatio', yTitle: 'Exon/Intron Ratio' },
                                                    umifrac: { title: 'Point Density Plot: UMIfrac', yTitle: 'UMI Fraction' },
                                                    umis: { title: 'Point Density Plot: UMIs', yTitle: 'UMIs' },
                                                    genes: { title: 'Point Density Plot: Genes', yTitle: 'Genes' }
                                                };

                                                const computeDensity = (xs, ys, xScale) => {
                                                    const pairs = [];
                                                    for (let i = 0; i < xs.length; i++) {
                                                        const x = xs[i];
                                                        const y = ys[i];
                                                        if (!Number.isFinite(x) || !Number.isFinite(y)) continue;
                                                        if (xScale === 'log' && x <= 0) continue;
                                                        const xx = (xScale === 'log') ? Math.log10(x) : x;
                                                        pairs.push({ xx, y });
                                                    }
                                                    if (!pairs.length) return [];

                                                    let minX = pairs[0].xx, maxX = pairs[0].xx, minY = pairs[0].y, maxY = pairs[0].y;
                                                    for (let i = 1; i < pairs.length; i++) {
                                                        const p = pairs[i];
                                                        if (p.xx < minX) minX = p.xx;
                                                        if (p.xx > maxX) maxX = p.xx;
                                                        if (p.y < minY) minY = p.y;
                                                        if (p.y > maxY) maxY = p.y;
                                                    }
                                                    if (minX === maxX) { minX -= 1; maxX += 1; }
                                                    if (minY === maxY) { minY -= 1; maxY += 1; }

                                                    const nx = 60;
                                                    const ny = 60;
                                                    const dx = (maxX - minX) / nx;
                                                    const dy = (maxY - minY) / ny;
                                                    const grid = new Array(nx * ny).fill(0);

                                                    const idx = (ix, iy) => (iy * nx + ix);
                                                    const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));

                                                    for (let i = 0; i < pairs.length; i++) {
                                                        const p = pairs[i];
                                                        const ix = clamp(Math.floor((p.xx - minX) / dx), 0, nx - 1);
                                                        const iy = clamp(Math.floor((p.y - minY) / dy), 0, ny - 1);
                                                        grid[idx(ix, iy)] += 1;
                                                    }

                                                    const z = [];
                                                    for (let i = 0; i < xs.length; i++) {
                                                        const x = xs[i];
                                                        const y = ys[i];
                                                        if (!Number.isFinite(x) || !Number.isFinite(y)) {
                                                            z.push(null);
                                                            continue;
                                                        }
                                                        if (xScale === 'log' && x <= 0) {
                                                            z.push(null);
                                                            continue;
                                                        }
                                                        const xx = (xScale === 'log') ? Math.log10(x) : x;
                                                        const ix = clamp(Math.floor((xx - minX) / dx), 0, nx - 1);
                                                        const iy = clamp(Math.floor((y - minY) / dy), 0, ny - 1);
                                                        z.push(grid[idx(ix, iy)]);
                                                    }
                                                    return z;
                                                };

                                                const draw = (metricKey, xScale) => {
                                                    const yArr = Array.isArray(data[metricKey]) ? data[metricKey] : [];
                                                    if (!data.x.length || !yArr.length) {
                                                        el.innerHTML = '<div style="text-align: center; color: #6c757d; padding-top: 50px;">No available data</div>';
                                                        return;
                                                    }
                                                    const z = computeDensity(data.x, yArr, xScale);
                                                    const m = meta[metricKey] || meta.mappingratio;
                                                    const trace = { type: 'scatter', mode: 'markers', x: data.x, y: yArr, marker: { size: 5, color: z, colorscale: 'Viridis', showscale: false, opacity: 0.9 }, hovertemplate: 'AllReads=%{x}<br>Value=%{y}<extra></extra>' };
                                                    const layout = {
                                                        title: { text: m.title, font: { size: 12, color: '#2c3e50' } },
                                                        height: 360,
                                                        width: 400,
                                                        plot_bgcolor: 'rgba(0,0,0,0)',
                                                        paper_bgcolor: 'rgba(0,0,0,0)',
                                                        margin: { l: 40, r: 20, t: 36, b: 40 },
                                                        xaxis: { title: { text: 'All reads', font: { size: 12, color: '#2c3e50' } }, type: xScale === 'log' ? 'log' : 'linear', showgrid: true, gridcolor: 'rgba(0,0,0,0.08)', zeroline: false, tickfont: { size: 10, color: '#2c3e50' } },
                                                        yaxis: { title: { text: m.yTitle, font: { size: 12, color: '#2c3e50' } }, showgrid: true, gridcolor: 'rgba(0,0,0,0.08)', zeroline: false, tickfont: { size: 10, color: '#2c3e50' } },
                                                        showlegend: false
                                                    };
                                                    Plotly.react('rna-density-plot-read', [trace], layout, { displayModeBar: false, responsive: true });
                                                };

                                                const redraw = () => { draw(String(metricEl.value || 'mappingratio'), String(xScaleEl.value || 'log')); };
                                                metricEl.addEventListener('change', redraw);
                                                xScaleEl.addEventListener('change', redraw);
                                                redraw();
                                            })();
                                        </script>
</div>
</div>
</div>
<script>
                            const rnaBeadsToggleRead = document.getElementById('toggle-rna-beads-explanation-read');
                            if (rnaBeadsToggleRead) {
                                rnaBeadsToggleRead.addEventListener('click', function() {
                                    const explanation = document.getElementById('rna-beads-explanation-read');
                                    if (!explanation) return;
                                    if (explanation.style.display === 'none' || explanation.style.display === '') {
                                        explanation.style.display = 'block';
                                    } else {
                                        explanation.style.display = 'none';
                                    }
                                });
                            }
                        </script>
</section>

<section class="section-card" data-library-content="gene-expression" id="plate-384-card-read">
<h3 class="tooltip" data-tooltip="384-well plate QC plot (auto samples only)">384-Well Plate</h3>
<div style="
                                        background: white;
                                        border-radius: 8px;
                                        padding: 15px;
                                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                                        height: 100%;
                                        display: flex;
                                        flex-direction: column;
                                        justify-content: center;
                                        align-items: center;
                                        min-height: 460px;
                                    ">
<div style="width: 100%; display: flex; justify-content: space-between; align-items: center; gap: 10px; margin-bottom: 10px;">
<div style="display: flex; align-items: center; gap: 8px;">
<span style="color: #495057; font-size: 14px;">Plate</span>
<select id="plate384-plate-select-read" style="padding: 6px 10px; border: 1px solid #dee2e6; border-radius: 4px; background: white; color: #495057; font-size: 14px; cursor: pointer;"></select>
</div>
<div style="display: flex; align-items: center; gap: 8px;">
<span style="color: #495057; font-size: 14px;">Metric</span>
<select id="plate384-metric-select-read" style="padding: 6px 10px; border: 1px solid #dee2e6; border-radius: 4px; background: white; color: #495057; font-size: 14px; cursor: pointer;">
<option value="mappingratio">MappingRatio</option>
<option value="exonintronratio">ExonIntronRatio</option>
<option value="umifrac">UMIfrac</option>
<option value="allreads">AllReads</option>
<option value="genes">Genes</option>
<option value="umis">UMIs</option>
</select>
</div>
</div>
<div id="plate-384-plot-read" class="plot-placeholder" data-plot-id="plate-384-plot-read" style="width: 900px; height: 420px;"></div>
<script id="script-plate-384-plot-read">
                                            (function() {
                                                const cardEl = document.getElementById('plate-384-card-read');
                                                const plotEl = document.getElementById('plate-384-plot-read');
                                                const plateSelect = document.getElementById('plate384-plate-select-read');
                                                const metricSelect = document.getElementById('plate384-metric-select-read');
                                                if (!cardEl || !plotEl || !plateSelect || !metricSelect) return;

                                                const sampleType = String('${sample_type}' || '').trim().toLowerCase();
                                                if (sampleType !== 'auto') {
                                                    cardEl.parentNode && cardEl.parentNode.removeChild(cardEl);
                                                    return;
                                                }

                                                if (typeof Plotly === 'undefined') {
                                                    plotEl.innerHTML = '<div style="text-align:center;color:#e74c3c;padding-top:50px;">Plotly library failed to load</div>';
                                                    return;
                                                }

                                                const statsJson = '${rna_stats_table_data}';
                                                let rows = [];
                                                try {
                                                    const parsed = JSON.parse(statsJson);
                                                    rows = Array.isArray(parsed) ? parsed : [];
                                                } catch (e) {
                                                    rows = [];
                                                }

                                                const toNumber = (v) => {
                                                    if (v === null || v === undefined) return null;
                                                    if (typeof v === 'number') return Number.isFinite(v) ? v : null;
                                                    const s = String(v).trim();
                                                    if (!s) return null;
                                                    const n = Number(s.replace(/,/g, ''));
                                                    return Number.isFinite(n) ? n : null;
                                                };

                                                const getVal = (r, keys) => {
                                                    for (let i = 0; i < keys.length; i++) {
                                                        const v = r ? r[keys[i]] : null;
                                                        const n = toNumber(v);
                                                        if (n !== null) return n;
                                                    }
                                                    return null;
                                                };

                                                const parsedWells = [];
                                                for (let i = 0; i < rows.length; i++) {
                                                    const wellID = String((rows[i] || {}).wellID || '').trim();
                                                    const m = wellID.match(/^P(\\d+)([A-P])(\\d+)$/);
                                                    if (!m) continue;
                                                    const plate = m[1];
                                                    const row = m[2];
                                                    const col = Number(m[3]);
                                                    if (!Number.isFinite(col)) continue;

                                                    const internalReads = getVal(rows[i], ['internal_reads']) || 0;
                                                    const umiReads = getVal(rows[i], ['umi_reads']) || 0;
                                                    const allReads = internalReads + umiReads;

                                                    const exonReads = getVal(rows[i], ['Exon_reads']) || 0;
                                                    const intronReads = getVal(rows[i], ['intron_reads', 'Intron_reads']) || 0;
                                                    const intergenicReads = getVal(rows[i], ['Intergenic_reads']) || 0;
                                                    const ambiguityReads = getVal(rows[i], ['Ambiguity_reads']) || 0;
                                                    const unmappedReads = getVal(rows[i], ['Unmapped_reads']) || 0;
                                                    const mapped = exonReads + intronReads + intergenicReads + ambiguityReads;
                                                    const denom = mapped + unmappedReads;
                                                    const mappingratio = denom > 0 ? mapped / denom : null;
                                                    const exonintronratio = intronReads > 0 ? exonReads / intronReads : null;
                                                    const umifrac = allReads > 0 ? umiReads / allReads : null;

                                                    const genes = getVal(rows[i], ['Intron_Exon_genes', 'Exon_genes']);
                                                    const umis = getVal(rows[i], ['Intron_Exon_umis', 'Exon_umis']);

                                                    parsedWells.push({ plate, row, col, wellID, mappingratio, exonintronratio, umifrac, allreads: allReads, genes, umis });
                                                }

                                                const plates = Array.from(new Set(parsedWells.map(w => w.plate))).sort((a, b) => Number(a) - Number(b));
                                                if (!plates.length) {
                                                    plotEl.innerHTML = '<div style="text-align: center; color: #6c757d; padding-top: 50px;">No available data</div>';
                                                    return;
                                                }

                                                plateSelect.innerHTML = '';
                                                for (let i = 0; i < plates.length; i++) {
                                                    const opt = document.createElement('option');
                                                    opt.value = plates[i];
                                                    opt.textContent = plates[i];
                                                    plateSelect.appendChild(opt);
                                                }

                                                const yOrder = [];
                                                for (let c = 'P'.charCodeAt(0); c >= 'A'.charCodeAt(0); c--) yOrder.push(String.fromCharCode(c));

                                                const draw = () => {
                                                    const plate = String(plateSelect.value || plates[0]);
                                                    const metric = String(metricSelect.value || 'mappingratio');
                                                    const wells = parsedWells.filter(w => w.plate === plate);
                                                    if (!wells.length) {
                                                        plotEl.innerHTML = '<div style="text-align: center; color: #6c757d; padding-top: 50px;">No available data</div>';
                                                        return;
                                                    }

                                                    const x = wells.map(w => w.col);
                                                    const y = wells.map(w => w.row);
                                                    const c = wells.map(w => {
                                                        const v = w[metric];
                                                        return (v !== null && v !== undefined && Number.isFinite(v)) ? v : null;
                                                    });
                                                    const text = wells.map(w => w.wellID);

                                                    const titleMap = { mappingratio: 'MappingRatio', exonintronratio: 'ExonIntronRatio', umifrac: 'UMIfrac', allreads: 'AllReads', genes: 'Genes', umis: 'UMIs' };
                                                    const titleMetric = titleMap[metric] || metric;

                                                    const trace = {
                                                        type: 'scatter',
                                                        mode: 'markers',
                                                        x: x,
                                                        y: y,
                                                        text: text,
                                                        marker: {
                                                            size: 20,
                                                            color: c,
                                                            colorscale: 'Viridis',
                                                            showscale: true,
                                                            colorbar: { title: '' },
                                                            line: { width: 1, color: 'DarkSlateGrey' }
                                                        },
                                                        hovertemplate: '<b>%{text}</b><br>Col=%{x}<br>Row=%{y}<br>Value=%{marker.color}<extra></extra>'
                                                    };

                                                    const layout = {
                                                        title: { text: `384-Well Plate Plot: ${titleMetric} (Plate: ${plate})`, font: { size: 12, color: '#2c3e50' } },
                                                        height: 420,
                                                        width: 900,
                                                        plot_bgcolor: 'rgba(0,0,0,0)',
                                                        paper_bgcolor: 'rgba(0,0,0,0)',
                                                        margin: { l: 40, r: 40, t: 40, b: 40 },
                                                        xaxis: { title: 'Column', dtick: 1, tick0: 1, showgrid: false, zeroline: false },
                                                        yaxis: { title: 'Row', categoryorder: 'array', categoryarray: yOrder, autorange: false },
                                                        showlegend: false
                                                    };

                                                    Plotly.react('plate-384-plot-read', [trace], layout, { displayModeBar: false, responsive: true });
                                                };

                                                plateSelect.addEventListener('change', draw);
                                                metricSelect.addEventListener('change', draw);
                                                draw();
                                            })();
                                        </script>
</div>
</section>
</div>
<!-- Parameters Tab -->
    
</div>
</div>
</div>

<!-- Interactive JavaScript -->
<script>
        // --- MANUAL CONFIGURATION ---
        // To manually show or hide the VDJ Target sections, set the flags below.
        // 'true' will show the section, 'false' will hide it, overriding backend settings.
        const manualSectionConfig = {
            // 'vdj-t-target': true, // Uncomment to override
            // 'vdj-b-target': true, // Uncomment to override
        };
        // --------------------------

        let sectionConfig; // Global config object

        // Helper function for rendering text data into a preformatted block
        function renderTextData(containerId, dataString, emptyMessage) {
            const container = document.getElementById(containerId);
            if (!container) return;

            if (!dataString || dataString.trim() === '' || dataString.trim() === 'undefined') {
                container.innerHTML = `<p style="padding: 12px; color: #64748b;">${emptyMessage}</p>`;
                return;
            }

        const pre = document.createElement('pre');
            pre.style.whiteSpace = 'pre';
            pre.style.fontFamily = 'ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';
            pre.style.background = 'var(--secondary-color)';
            pre.style.border = '1px solid var(--border-color)';
            pre.style.borderRadius = '8px';
            pre.style.padding = '12px';
            pre.style.margin = '0';
            pre.style.lineHeight = '1.4';
            pre.style.overflowX = 'auto';
            pre.style.overflowY = 'hidden';
            pre.style.maxWidth = '100%';
            pre.textContent = dataString.trim();

            container.innerHTML = '';
            container.appendChild(pre);
        }

        // Tab switching functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize sectionConfig by merging backend and manual settings
            try {
                const backendConfig = {
                    'cell-annotation': String('${cell_annotation_available}').trim().toLowerCase() === 'true',
                    'vdj-t-target': String('${vdj_t_target_enabled}').trim().toLowerCase() === 'true',
                    'vdj-b-target': String('${vdj_b_target_enabled}').trim().toLowerCase() === 'true'
                };
                // Merge manual config over backend config. Manually defined values take precedence.
                sectionConfig = { ...backendConfig, ...manualSectionConfig };
            } catch (e) {
                console.warn('Failed to parse backend config, using manual/default values:', e);
                sectionConfig = {
                    'cell-annotation': false,
                    'vdj-t-target': false,
                    'vdj-b-target': false,
                    ...manualSectionConfig
                };
            }

            // Initialize section visibility based on the final configuration
            initializeSectionVisibility();
            
            // Toggle ATAC Cell Quality Metrics explanation
            const atacCellToggle = document.getElementById('toggle-atac-cell-explanation');
            if (atacCellToggle) {
                atacCellToggle.addEventListener('click', function() {
                    const explanation = document.getElementById('atac-cell-explanation');
                    if (explanation.style.display === 'none' || explanation.style.display === '') {
                        explanation.style.display = 'block';
                    } else {
                        explanation.style.display = 'none';
                    }
                });
            }
            
            const tabButtons = document.querySelectorAll('.library-tab-btn[data-tab]');
            const tabPanes = document.querySelectorAll('.tab-pane');

            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const targetTab = this.getAttribute('data-tab');

                    // Remove active class from all buttons and panes
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabPanes.forEach(pane => pane.classList.remove('active'));

                    // Add active class to clicked button and corresponding pane
                    this.classList.add('active');
                    const targetPane = document.getElementById(targetTab + '-tab');
                    if (targetPane) {
                        targetPane.classList.add('active');
                        // Scroll to the top of the page when switching tabs
                        window.scrollTo({
                            top: 0,
                            behavior: 'auto'
                        });
                    }
                });
            });
        });

        // Smooth scrolling for navigation
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                const targetId = this.getAttribute('href');
                const targetSection = document.querySelector(targetId);
                
                if (targetSection) {
                    targetSection.scrollIntoView({
                        behavior: 'auto',
                        block: 'start'
                    });
                    
                    // Update active navigation item
                    document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                    this.classList.add('active');
                }
            });
        });

        // Intersection Observer for navigation highlighting
        const observerOptions = {
            root: null,
            rootMargin: '-20% 0px -70% 0px',
            threshold: 0
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const id = entry.target.getAttribute('id');
                    document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                    const activeNav = document.querySelector(`[href="#${id}"]`);
                    if (activeNav) activeNav.classList.add('active');
                }
            });
        }, observerOptions);

        // Observe all sections with IDs
        document.querySelectorAll('section[id]').forEach(section => {
            observer.observe(section);
        });

        

        



        

        

        

        // Cells explanation toggle functionality
        const cellsExplanationToggle = document.getElementById('toggle-cells-explanation');
        if (cellsExplanationToggle) {
            cellsExplanationToggle.addEventListener('click', function() {
                var explanationDiv = document.getElementById('cells-explanation');
                if (!explanationDiv) return;
                if (explanationDiv.style.display === 'none') {
                    explanationDiv.style.display = 'block';
                } else {
                    explanationDiv.style.display = 'none';
                }
            });
        }



        // Clonotype explanation toggle functionality
        const clonotypeExplanationToggle = document.getElementById('toggle-clonotype-explanation');
        if (clonotypeExplanationToggle) {
            clonotypeExplanationToggle.addEventListener('click', function() {
                var explanationDiv = document.getElementById('vdj-t-clonotype-explanation');
                if (!explanationDiv) return;
                if (explanationDiv.style.display === 'none' || explanationDiv.style.display === '') {
                    explanationDiv.style.display = 'block';
                } else {
                    explanationDiv.style.display = 'none';
                }
            });
        }

        // Cluster analysis explanation toggle functionality
        const clusterExplanationToggle = document.getElementById('toggle-cluster-explanation');
        if (clusterExplanationToggle) {
            clusterExplanationToggle.addEventListener('click', function() {
                var explanationDiv = document.getElementById('cluster-explanation');
                if (!explanationDiv) return;
                if (explanationDiv.style.display === 'none') {
                    explanationDiv.style.display = 'block';
                } else {
                    explanationDiv.style.display = 'none';
                }
            });
        }

        // Initialize section visibility based on configuration
        function initializeSectionVisibility() {
            // Handle Cell Annotation section visibility
            const cellAnnotationPlot = document.getElementById('cell-annotation-plot');
            const cellAnnotationSection = cellAnnotationPlot ? cellAnnotationPlot.closest('.section-card') : null;
            if (!cellAnnotationSection) return;
            if (sectionConfig && sectionConfig['cell-annotation']) {
                cellAnnotationSection.style.display = 'block';
            } else {
                cellAnnotationSection.style.display = 'none';
            }
        }

        function showGeneExpressionOnly() {
            document.querySelectorAll('[data-library-content]').forEach(element => {
                element.style.display = 'none';
            });
            document.querySelectorAll('[data-library-content="gene-expression"]').forEach(element => {
                element.style.display = 'block';
            });
        }

        // Initialize visibility on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Scroll to top on page load with a small delay to ensure proper positioning
            setTimeout(function() {
                window.scrollTo(0, 0);
                document.documentElement.scrollTop = 0;
                document.body.scrollTop = 0;
            }, 100);
            
            showGeneExpressionOnly();
            
            initializeSectionVisibility();
            
            // Initialize marker table functionality
            initializeMarkerTable();

            // Initialize zUMIs stats table functionality
            initializeRnaStatsTable();
            
            // Initialize VDJ annotation explanation buttons
            initializeVDJAnnotationButtons();

            // Render CSV and FASTQ data into their respective containers
            const csvData = `${input_csv_data}`;
            renderTextData('csv-table-container', csvData, 'CSV data not available or empty.');
            
            const fastqData = `${fastq_display_html}`;
            renderTextData('fastq-content-container', fastqData, 'FASTQ data not available or empty.');
        });

        // Function to dynamically generate table headers based on cluster data
        function generateMarkerTableHeaders(data) {
            if (!data || data.length === 0) return;
            
            // Extract cluster numbers from the first data row
            const firstRow = data[0];
            const clusterKeys = Object.keys(firstRow).filter(key => key.includes('_pval')).map(key => key.replace('_pval', ''));
            const clusterNumbers = clusterKeys.map(key => parseInt(key.replace('cluster', ''))).sort((a, b) => a - b);
            
            const thead = document.querySelector('#marker-table thead');
            if (!thead) return;
            
            // Clear existing headers
            thead.innerHTML = '';
            
            // Create main header row
            const mainHeaderRow = document.createElement('tr');
            mainHeaderRow.style.cssText = 'background: #f8f9fa; border-bottom: 1px solid #dee2e6;';
            
            // Feature column header
            const featureHeader = document.createElement('th');
            featureHeader.setAttribute('colspan', '2');
            featureHeader.style.cssText = 'padding: 8px 6px; text-align: center; font-weight: 600; color: #2c3e50; border-right: 1px solid #dee2e6;';
            featureHeader.textContent = 'Feature';
            mainHeaderRow.appendChild(featureHeader);
            
            // Cluster headers
            clusterNumbers.forEach((clusterNum, index) => {
                const clusterHeader = document.createElement('th');
                clusterHeader.setAttribute('colspan', '2');
                clusterHeader.style.cssText = `padding: 8px 6px; text-align: center; font-weight: 600; color: #2c3e50; ${index < clusterNumbers.length - 1 ? 'border-right: 1px solid #dee2e6;' : ''}`;
                clusterHeader.textContent = `Cluster ${clusterNum}`;
                mainHeaderRow.appendChild(clusterHeader);
            });
            
            thead.appendChild(mainHeaderRow);
            
            // Create sub header row
            const subHeaderRow = document.createElement('tr');
            subHeaderRow.style.cssText = 'background: #f8f9fa; border-bottom: 2px solid #dee2e6; font-size: 11px;';
            
            // ID and Name headers
            const idHeader = document.createElement('th');
            idHeader.className = 'sortable';
            idHeader.setAttribute('data-column', 'id');
            idHeader.style.cssText = 'padding: 4px 3px; text-align: center; color: #495057; border-right: 1px solid #dee2e6; cursor: pointer; user-select: none; font-weight: 600;';
            idHeader.textContent = 'ID';
            subHeaderRow.appendChild(idHeader);
            
            const nameHeader = document.createElement('th');
            nameHeader.className = 'sortable';
            nameHeader.setAttribute('data-column', 'name');
            nameHeader.style.cssText = 'padding: 4px 3px; text-align: center; color: #495057; border-right: 1px solid #dee2e6; cursor: pointer; user-select: none; font-weight: 600;';
            nameHeader.textContent = 'Name';
            subHeaderRow.appendChild(nameHeader);
            
            // Cluster sub headers (p-value and L2FC)
            clusterNumbers.forEach((clusterNum, index) => {
                const pvalHeader = document.createElement('th');
                pvalHeader.className = 'sortable';
                pvalHeader.setAttribute('data-column', `cluster${clusterNum}_pval`);
                pvalHeader.style.cssText = 'padding: 4px 3px; text-align: center; color: #6c757d; border-right: 1px solid #dee2e6; cursor: pointer; user-select: none;';
                pvalHeader.textContent = 'p-value';
                subHeaderRow.appendChild(pvalHeader);
                
                const l2fcHeader = document.createElement('th');
                l2fcHeader.className = 'sortable';
                l2fcHeader.setAttribute('data-column', `cluster${clusterNum}_lg2fc`);
                l2fcHeader.style.cssText = `padding: 4px 3px; text-align: center; color: #6c757d; ${index < clusterNumbers.length - 1 ? 'border-right: 1px solid #dee2e6;' : ''} cursor: pointer; user-select: none;`;
                l2fcHeader.textContent = 'L2FC';
                subHeaderRow.appendChild(l2fcHeader);
            });
            
            thead.appendChild(subHeaderRow);
        }

        function initializeRnaStatsTable() {
            let currentPage = 1;
            let rowsPerPage = 50;
            let totalPages = 1;
            let statsData = [];
            let filteredData = [];
            let sortColumn = null;
            let sortDirection = 'asc';

            const tableEl = document.getElementById('rna-stats-table');
            const theadEl = document.getElementById('rnaStatsTableHeader');
            const tbodyEl = document.getElementById('rna-stats-table-body');
            const startEl = document.getElementById('rna-stats-table-start');
            const endEl = document.getElementById('rna-stats-table-end');
            const totalEl = document.getElementById('rna-stats-table-total');
            const prevBtn = document.getElementById('rna-stats-prev-btn');
            const nextBtn = document.getElementById('rna-stats-next-btn');
            const rowsSelect = document.getElementById('rna-stats-rows-selector');
            const searchBox = document.getElementById('rna-stats-search');

            if (!tableEl || !theadEl || !tbodyEl) return;

            try {
                const templateStatsData = JSON.parse('${rna_stats_table_data}');
                if (Array.isArray(templateStatsData) && templateStatsData.length > 0) {
                    statsData = templateStatsData;
                } else {
                    throw new Error('No template data available');
                }
            } catch (e) {
                statsData = [
                    { wellID: 'A1', internal_reads: 0, umi_reads: 0, Exon_reads: 0, Intron_reads: 0, Unmapped_reads: 0 },
                    { wellID: 'A2', internal_reads: 0, umi_reads: 0, Exon_reads: 0, Intron_reads: 0, Unmapped_reads: 0 }
                ];
            }

            filteredData = [...statsData];
            totalPages = Math.max(1, Math.ceil(filteredData.length / rowsPerPage));

            const getColumns = () => {
                if (!filteredData.length) return [];
                const cols = Object.keys(filteredData[0] || {});
                const wellIdx = cols.findIndex(c => String(c).toLowerCase() === 'wellid');
                if (wellIdx > 0) {
                    const wellCol = cols[wellIdx];
                    return [wellCol, ...cols.filter(c => c !== wellCol)];
                }
                return cols;
            };

            const isNumericLike = (v) => {
                if (v === null || v === undefined) return false;
                if (typeof v === 'number') return Number.isFinite(v);
                const s = String(v).trim();
                if (!s) return false;
                return Number.isFinite(Number(s.replace(/,/g, '')));
            };

            const formatCellValue = (v) => {
                if (v === null || v === undefined) return '';
                if (typeof v === 'number') return v.toLocaleString();
                const s = String(v);
                if (isNumericLike(s)) {
                    const n = Number(s.replace(/,/g, ''));
                    if (Number.isFinite(n)) return n.toLocaleString();
                }
                return s;
            };

            const formatHeader = (col) => {
                const s = String(col || '').trim();
                if (!s) return '';
                return s.replace(/_/g, ' ');
            };

            const renderHeaders = () => {
                const cols = getColumns();
                theadEl.innerHTML = '';
                const tr = document.createElement('tr');
                tr.style.background = 'linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%)';
                cols.forEach((col, idx) => {
                    const th = document.createElement('th');
                    th.textContent = formatHeader(col);
                    th.dataset.column = col;
                    th.classList.add('sortable');
                    th.style.cssText = 'padding: 8px 10px; text-align: center; color: #2c3e50; border-bottom: 1px solid #dee2e6; cursor: pointer; user-select: none; white-space: nowrap;';
                    if (idx < cols.length - 1) th.style.borderRight = '1px solid #dee2e6';
                    tr.appendChild(th);
                });
                theadEl.appendChild(tr);
            };

            const sortData = () => {
                if (!sortColumn) return;
                const col = sortColumn;
                const dir = sortDirection;
                filteredData.sort((a, b) => {
                    const av = a ? a[col] : '';
                    const bv = b ? b[col] : '';
                    const aNum = isNumericLike(av) ? Number(String(av).replace(/,/g, '')) : null;
                    const bNum = isNumericLike(bv) ? Number(String(bv).replace(/,/g, '')) : null;
                    if (aNum !== null && bNum !== null) {
                        if (aNum < bNum) return dir === 'asc' ? -1 : 1;
                        if (aNum > bNum) return dir === 'asc' ? 1 : -1;
                        return 0;
                    }
                    const as = String(av ?? '').toLowerCase();
                    const bs = String(bv ?? '').toLowerCase();
                    if (as < bs) return dir === 'asc' ? -1 : 1;
                    if (as > bs) return dir === 'asc' ? 1 : -1;
                    return 0;
                });
            };

            const updatePaginationInfo = () => {
                const startIndex = filteredData.length ? (currentPage - 1) * rowsPerPage + 1 : 0;
                const endIndex = Math.min(currentPage * rowsPerPage, filteredData.length);
                if (startEl) startEl.textContent = String(startIndex);
                if (endEl) endEl.textContent = String(endIndex);
                if (totalEl) totalEl.textContent = String(filteredData.length);
                totalPages = Math.max(1, Math.ceil(filteredData.length / rowsPerPage));
                if (prevBtn) prevBtn.disabled = currentPage <= 1;
                if (nextBtn) nextBtn.disabled = currentPage >= totalPages;
            };

            const updateTable = () => {
                const cols = getColumns();
                tbodyEl.innerHTML = '';
                if (!filteredData.length) {
                    const tr = document.createElement('tr');
                    const td = document.createElement('td');
                    td.colSpan = Math.max(1, cols.length);
                    td.style.cssText = 'padding: 10px 12px; text-align: center; color: #6c757d;';
                    td.textContent = 'No stats table data';
                    tr.appendChild(td);
                    tbodyEl.appendChild(tr);
                    updatePaginationInfo();
                    return;
                }

                const start = (currentPage - 1) * rowsPerPage;
                const end = Math.min(start + rowsPerPage, filteredData.length);
                const pageRows = filteredData.slice(start, end);

                pageRows.forEach((row, ridx) => {
                    const tr = document.createElement('tr');
                    tr.style.borderBottom = '1px solid #dee2e6';
                    tr.style.background = (ridx % 2 === 0) ? 'white' : 'rgba(248, 250, 252, 0.7)';
                    cols.forEach((col, cidx) => {
                        const td = document.createElement('td');
                        const v = row ? row[col] : '';
                        const numeric = isNumericLike(v) && String(col).toLowerCase() !== 'wellid';
                        td.style.cssText = `padding: 6px 8px; color: #495057; border-bottom: 1px solid #dee2e6; ${numeric ? 'text-align: right; font-weight: 600;' : 'text-align: left;'} white-space: nowrap;`;
                        if (cidx < cols.length - 1) td.style.borderRight = '1px solid #dee2e6';
                        td.textContent = formatCellValue(v);
                        tr.appendChild(td);
                    });
                    tbodyEl.appendChild(tr);
                });

                updatePaginationInfo();
            };

            const attachSorting = () => {
                const headers = theadEl.querySelectorAll('.sortable');
                headers.forEach((h) => {
                    h.addEventListener('click', function() {
                        const col = this.dataset.column;
                        if (!col) return;
                        if (sortColumn === col) {
                            sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                        } else {
                            sortColumn = col;
                            sortDirection = 'asc';
                        }
                        sortData();
                        currentPage = 1;
                        updateTable();
                    });
                });
            };

            if (rowsSelect) {
                rowsSelect.addEventListener('change', function() {
                    rowsPerPage = parseInt(this.value, 10) || 50;
                    currentPage = 1;
                    updateTable();
                });
            }

            if (searchBox) {
                searchBox.addEventListener('input', function() {
                    const term = String(this.value || '').toLowerCase();
                    if (!term) {
                        filteredData = [...statsData];
                    } else {
                        const cols = getColumns();
                        filteredData = statsData.filter((row) => {
                            return cols.some((c) => String((row || {})[c] ?? '').toLowerCase().includes(term));
                        });
                    }
                    sortData();
                    currentPage = 1;
                    updateTable();
                });
            }

            if (prevBtn) {
                prevBtn.addEventListener('click', function() {
                    if (currentPage > 1) {
                        currentPage -= 1;
                        updateTable();
                    }
                });
            }
            if (nextBtn) {
                nextBtn.addEventListener('click', function() {
                    if (currentPage < totalPages) {
                        currentPage += 1;
                        updateTable();
                    }
                });
            }

            renderHeaders();
            attachSorting();
            updateTable();
        }

        // Marker Table Functionality
        // Utility: compact scientific notation formatter (e.g., '4.00000000000e-23' -> '4e-23')
        function formatSciString(value) {
            const s = String(value).trim();
            if (s === '' || s.toLowerCase() === 'nan') return s;
            const num = Number(s);
            if (!Number.isFinite(num)) return s;
            // Round mantissa to a single significant digit
            const expStr = num.toExponential(0); // one digit mantissa
            const m = expStr.match(/^([+-]?\d+(?:\.\d+)?)e([+-]?\d+)$/i);
            if (m) {
                const coef = m[1].replace(/\.?0+$/, '');
                const exp = String(parseInt(m[2], 10));
                return `${coef}e${exp}`;
            }
            return expStr.replace('E', 'e');
        }

        function initializeMarkerTable() {
            let currentPage = 1;
            let rowsPerPage = 10;
            let totalPages = 5;
            let markerData = [];
            let sortColumn = null;
            let sortDirection = 'desc';
            let filteredData = [];

            // Get table elements
            const markerTable = document.getElementById('marker-table');
            const markerTableStart = document.getElementById('marker-table-start');
            const markerTableEnd = document.getElementById('marker-table-end');
            const markerTableTotal = document.getElementById('marker-table-total');
            const markerPrevBtn = document.getElementById('marker-prev-btn');
            const markerNextBtn = document.getElementById('marker-next-btn');
            const rowsPerPageSelect = document.getElementById('marker-rows-selector');
            const searchBox = document.getElementById('marker-search');

            // Initialize marker data from template or use fallback data
            try {
                const templateMarkerData = JSON.parse('${rna_marker_data}');
                if (templateMarkerData && templateMarkerData.length > 0) {
                    markerData = templateMarkerData;
                } else {
                    throw new Error('No template data available');
                }
            } catch (e) {
                console.log('Using fallback marker data');
                // Fallback sample data: 5 rows, name = 'NNN', pval = '1e0', lg2fc = '0.00'
                markerData = [
                    {id: 'ENSG00000NNN1', name: 'NNN1', cluster0_pval: '1e0', cluster0_lg2fc: '0.00', cluster1_pval: '1e0', cluster1_lg2fc: '0.00', cluster2_pval: '1e0', cluster2_lg2fc: '0.00', cluster3_pval: '1e0', cluster3_lg2fc: '0.00', cluster4_pval: '1e0', cluster4_lg2fc: '0.00', cluster5_pval: '1e0', cluster5_lg2fc: '0.00', cluster6_pval: '1e0', cluster6_lg2fc: '0.00', cluster7_pval: '1e0', cluster7_lg2fc: '0.00', cluster8_pval: '1e0', cluster8_lg2fc: '0.00', cluster9_pval: '1e0', cluster9_lg2fc: '0.00', cluster10_pval: '1e0', cluster10_lg2fc: '0.00', cluster11_pval: '1e0', cluster11_lg2fc: '0.00', cluster12_pval: '1e0', cluster12_lg2fc: '0.00', cluster13_pval: '1e0', cluster13_lg2fc: '0.00', cluster14_pval: '1e0', cluster14_lg2fc: '0.00', cluster15_pval: '1e0', cluster15_lg2fc: '0.00'},
                    {id: 'ENSG00000NNN2', name: 'NNN2', cluster0_pval: '1e0', cluster0_lg2fc: '0.00', cluster1_pval: '1e0', cluster1_lg2fc: '0.00', cluster2_pval: '1e0', cluster2_lg2fc: '0.00', cluster3_pval: '1e0', cluster3_lg2fc: '0.00', cluster4_pval: '1e0', cluster4_lg2fc: '0.00', cluster5_pval: '1e0', cluster5_lg2fc: '0.00', cluster6_pval: '1e0', cluster6_lg2fc: '0.00', cluster7_pval: '1e0', cluster7_lg2fc: '0.00', cluster8_pval: '1e0', cluster8_lg2fc: '0.00', cluster9_pval: '1e0', cluster9_lg2fc: '0.00', cluster10_pval: '1e0', cluster10_lg2fc: '0.00', cluster11_pval: '1e0', cluster11_lg2fc: '0.00', cluster12_pval: '1e0', cluster12_lg2fc: '0.00', cluster13_pval: '1e0', cluster13_lg2fc: '0.00', cluster14_pval: '1e0', cluster14_lg2fc: '0.00', cluster15_pval: '1e0', cluster15_lg2fc: '0.00'},
                    {id: 'ENSG00000NNN3', name: 'NNN3', cluster0_pval: '1e0', cluster0_lg2fc: '0.00', cluster1_pval: '1e0', cluster1_lg2fc: '0.00', cluster2_pval: '1e0', cluster2_lg2fc: '0.00', cluster3_pval: '1e0', cluster3_lg2fc: '0.00', cluster4_pval: '1e0', cluster4_lg2fc: '0.00', cluster5_pval: '1e0', cluster5_lg2fc: '0.00', cluster6_pval: '1e0', cluster6_lg2fc: '0.00', cluster7_pval: '1e0', cluster7_lg2fc: '0.00', cluster8_pval: '1e0', cluster8_lg2fc: '0.00', cluster9_pval: '1e0', cluster9_lg2fc: '0.00', cluster10_pval: '1e0', cluster10_lg2fc: '0.00', cluster11_pval: '1e0', cluster11_lg2fc: '0.00', cluster12_pval: '1e0', cluster12_lg2fc: '0.00', cluster13_pval: '1e0', cluster13_lg2fc: '0.00', cluster14_pval: '1e0', cluster14_lg2fc: '0.00', cluster15_pval: '1e0', cluster15_lg2fc: '0.00'},
                    {id: 'ENSG00000NNN4', name: 'NNN4', cluster0_pval: '1e0', cluster0_lg2fc: '0.00', cluster1_pval: '1e0', cluster1_lg2fc: '0.00', cluster2_pval: '1e0', cluster2_lg2fc: '0.00', cluster3_pval: '1e0', cluster3_lg2fc: '0.00', cluster4_pval: '1e0', cluster4_lg2fc: '0.00', cluster5_pval: '1e0', cluster5_lg2fc: '0.00', cluster6_pval: '1e0', cluster6_lg2fc: '0.00', cluster7_pval: '1e0', cluster7_lg2fc: '0.00', cluster8_pval: '1e0', cluster8_lg2fc: '0.00', cluster9_pval: '1e0', cluster9_lg2fc: '0.00', cluster10_pval: '1e0', cluster10_lg2fc: '0.00', cluster11_pval: '1e0', cluster11_lg2fc: '0.00', cluster12_pval: '1e0', cluster12_lg2fc: '0.00', cluster13_pval: '1e0', cluster13_lg2fc: '0.00', cluster14_pval: '1e0', cluster14_lg2fc: '0.00', cluster15_pval: '1e0', cluster15_lg2fc: '0.00'},
                    {id: 'ENSG00000NNN5', name: 'NNN5', cluster0_pval: '1e0', cluster0_lg2fc: '0.00', cluster1_pval: '1e0', cluster1_lg2fc: '0.00', cluster2_pval: '1e0', cluster2_lg2fc: '0.00', cluster3_pval: '1e0', cluster3_lg2fc: '0.00', cluster4_pval: '1e0', cluster4_lg2fc: '0.00', cluster5_pval: '1e0', cluster5_lg2fc: '0.00', cluster6_pval: '1e0', cluster6_lg2fc: '0.00', cluster7_pval: '1e0', cluster7_lg2fc: '0.00', cluster8_pval: '1e0', cluster8_lg2fc: '0.00', cluster9_pval: '1e0', cluster9_lg2fc: '0.00', cluster10_pval: '1e0', cluster10_lg2fc: '0.00', cluster11_pval: '1e0', cluster11_lg2fc: '0.00', cluster12_pval: '1e0', cluster12_lg2fc: '0.00', cluster13_pval: '1e0', cluster13_lg2fc: '0.00', cluster14_pval: '1e0', cluster14_lg2fc: '0.00', cluster15_pval: '1e0', cluster15_lg2fc: '0.00'}
                ];
            }
            filteredData = [...markerData];
            
            // Generate dynamic table headers based on data
            generateMarkerTableHeaders(markerData);

            // Rows per page change handler
            if (rowsPerPageSelect) {
                rowsPerPageSelect.addEventListener('change', function() {
                    rowsPerPage = parseInt(this.value);
                    currentPage = 1;
                    totalPages = Math.ceil(filteredData.length / rowsPerPage);
                    updateMarkerTable();
                    updateMarkerPaginationInfo();
                });
            }

            // Search functionality
            if (searchBox) {
                searchBox.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase();
                    filteredData = markerData.filter(row => 
                        row.id.toLowerCase().includes(searchTerm) || 
                        row.name.toLowerCase().includes(searchTerm)
                    );
                    currentPage = 1;
                    totalPages = Math.ceil(filteredData.length / rowsPerPage);
                    updateMarkerTable();
                    updateMarkerPaginationInfo();
                });
            }

            // Data Loader Functions
            function loadData() {
                const dataInput = document.getElementById('dataInput');
                const statusDiv = document.getElementById('dataStatus');
                
                try {
                    const inputData = JSON.parse(dataInput.value.trim());
                    
                    if (!Array.isArray(inputData)) {
                        throw new Error('Data must be an array');
                    }
                    
                    // Validate data structure
                    if (inputData.length > 0) {
                        const firstItem = inputData[0];
                        if (!firstItem.id || !firstItem.name) {
                            throw new Error('Each item must have "id" and "name" properties');
                        }
                    }
                    
                    // Update global markerData
                    markerData = inputData;
                    
                    // Reset pagination
                    currentMarkerPage = 1;
                    
                    // Update table and pagination
                    updateMarkerTable();
                    updateMarkerPaginationInfo();
                    
                    // Show success message
                    statusDiv.style.display = 'block';
                    statusDiv.style.background = '#d4edda';
                    statusDiv.style.color = '#155724';
                    statusDiv.style.border = '1px solid #c3e6cb';
                    statusDiv.textContent = `Successfully loaded ${inputData.length} records`;
                    
                    // Hide success message after 3 seconds
                    setTimeout(() => {
                        statusDiv.style.display = 'none';
                    }, 3000);
                    
                } catch (error) {
                    // Show error message
                    statusDiv.style.display = 'block';
                    statusDiv.style.background = '#f8d7da';
                    statusDiv.style.color = '#721c24';
                    statusDiv.style.border = '1px solid #f5c6cb';
                    statusDiv.textContent = `Error: ${error.message}`;
                }
            }
            
            
            
            function clearData() {
                document.getElementById('dataInput').value = '';
                const statusDiv = document.getElementById('dataStatus');
                statusDiv.style.display = 'none';
            }

            // Add event listener for annotation explanation toggle
            const toggleAnnotationExplanationBtn = document.getElementById('toggle-annotation-explanation');
            if (toggleAnnotationExplanationBtn) {
                toggleAnnotationExplanationBtn.addEventListener('click', function() {
                    const explanation = document.getElementById('annotation-explanation');
                    if (explanation) {
                        if (explanation.style.display === 'none' || explanation.style.display === '') {
                            explanation.style.display = 'block';
                        } else {
                            explanation.style.display = 'none';
                        }
                    }
                });
            }

            // Add event listener for sequencing metrics explanation toggle
            const toggleSequencingExplanationBtn = document.getElementById('toggle-sequencing-explanation');
            if (toggleSequencingExplanationBtn) {
                toggleSequencingExplanationBtn.addEventListener('click', function() {
                    const explanation = document.getElementById('sequencing-explanation');
                    if (explanation) {
                        if (explanation.style.display === 'none' || explanation.style.display === '') {
                            explanation.style.display = 'block';
                        } else {
                            explanation.style.display = 'none';
                        }
                    }
                });
            }

            // Add event listener for mapping metrics explanation toggle
            const toggleMappingExplanationBtn = document.getElementById('toggle-mapping-explanation');
            if (toggleMappingExplanationBtn) {
                toggleMappingExplanationBtn.addEventListener('click', function() {
                    const explanation = document.getElementById('mapping-explanation');
                    if (explanation) {
                        if (explanation.style.display === 'none' || explanation.style.display === '') {
                            explanation.style.display = 'block';
                        } else {
                            explanation.style.display = 'none';
                        }
                    }
                });
            }

            // Initialize all functionality
            addSortingListeners();
            updateMarkerTable();
            updateMarkerPaginationInfo();    

        }
    </script>
    <div class="report-footer">
      <p style="margin: 0; opacity: 0.9;">Generated by <a href="https://github.com/MGI-tech-bioinformatics/zUMIs_MGI" target="_blank" style="color: #3b82f6; text-decoration: none; cursor: pointer;" onmouseover="this.style.color='#1d4ed8'" onmouseout="this.style.color='#3b82f6'">zUMIs_MGI</a></p>
      <p style="margin: 0.5rem 0 0 0; font-size: 0.75rem; opacity: 0.7;"> 2026 MGI Tech Co., Ltd. All rights reserved.</p>
    </div>
<script>
document.addEventListener("DOMContentLoaded", function() {
    const plotPlaceholders = document.querySelectorAll('.plot-placeholder');

    const plotObserver = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const placeholder = entry.target;
                const plotId = placeholder.dataset.plotId;

                // Find the script that generates the plot and execute it
                const scriptId = `script-${plotId}`;
                const plotScript = document.getElementById(scriptId);
                if (plotScript) {
                    try {
                        eval(plotScript.innerHTML);
                    } catch (e) {
                        console.error(`Error rendering plot ${plotId}:`, e);
                    }
                }

                // Stop observing the placeholder
                observer.unobserve(placeholder);
            }
        });
    }, { rootMargin: "200px" });

    plotPlaceholders.forEach(placeholder => {
        plotObserver.observe(placeholder);
    });
});
</script>
<script>

</script>
